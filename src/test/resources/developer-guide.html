<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="湯岳豊, 許嵩業, 楊博任, 林爾家">
<title>mgov-core 開發人員手冊</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>mgov-core 開發人員手冊</h1>
<div class="details">
<span id="author" class="author">湯岳豊</span><br>
<span id="email" class="email"><a href="mailto:franky@tist.com.tw">franky@tist.com.tw</a></span><br>
<span id="author2" class="author">許嵩業</span><br>
<span id="email2" class="email"><a href="mailto:sungyeh@tist.com.tw">sungyeh@tist.com.tw</a></span><br>
<span id="author3" class="author">楊博任</span><br>
<span id="email3" class="email"><a href="mailto:dennis@tist.com.tw">dennis@tist.com.tw</a></span><br>
<span id="author4" class="author">林爾家</span><br>
<span id="email4" class="email"><a href="mailto:jack@tist.com.tw">jack@tist.com.tw</a></span><br>
<span id="revnumber">version 0.5,</span>
<span id="revdate">2019-07-25</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">大綱</div>
<ul class="sectlevel1">
<li><a href="#_coding_style">1. Coding Style</a>
<ul class="sectlevel2">
<li><a href="#_java">1.1. Java</a></li>
<li><a href="#_jpa">1.2. JPA</a></li>
<li><a href="#_網址命名原則">1.3. 網址命名原則</a></li>
<li><a href="#_freemarker">1.4. Freemarker</a></li>
<li><a href="#_javascript">1.5. Javascript</a></li>
<li><a href="#_css">1.6. CSS</a></li>
<li><a href="#_靜態資源檔">1.7. 靜態資源檔</a></li>
</ul>
</li>
<li><a href="#_開發環境">2. 開發環境</a>
<ul class="sectlevel2">
<li><a href="#_jdk">2.1. JDK</a></li>
<li><a href="#_版本控制系統用戶端">2.2. 版本控制系統用戶端</a></li>
<li><a href="#_apache_maven">2.3. Apache Maven</a></li>
<li><a href="#_資料庫">2.4. 資料庫</a></li>
</ul>
</li>
<li><a href="#_開發指引">3. 開發指引</a>
<ul class="sectlevel2">
<li><a href="#_關於mgov_core">3.1. 關於mgov-core</a></li>
<li><a href="#_建立新專案">3.2. 建立新專案</a></li>
<li><a href="#_新增建檔作業">3.3. 新增建檔作業</a></li>
</ul>
</li>
<li><a href="#_資料庫_2">4. 資料庫</a>
<ul class="sectlevel2">
<li><a href="#_為何要使用_spring_data_jpa">4.1. 為何要使用 Spring Data JPA</a></li>
<li><a href="#_為何不應該直接使用jdbc">4.2. 為何不應該直接使用JDBC</a></li>
<li><a href="#_設計entity">4.3. 設計Entity</a></li>
<li><a href="#_repository">4.4. Repository</a></li>
<li><a href="#_連線多個資料庫">4.5. 連線多個資料庫</a></li>
<li><a href="#_如何客製化或擴充資料庫方言">4.6. 如何客製化或擴充資料庫方言</a></li>
<li><a href="#_jpa_metamodel">4.7. JPA Metamodel</a></li>
<li><a href="#_整合複雜的原生sql">4.8. 整合複雜的原生SQL</a></li>
</ul>
</li>
<li><a href="#_service">5. Service</a>
<ul class="sectlevel2">
<li><a href="#_service_簡介">5.1. Service 簡介</a></li>
<li><a href="#_非同步執行">5.2. 非同步執行</a></li>
<li><a href="#_排程">5.3. 排程</a></li>
</ul>
</li>
<li><a href="#_controller">6. Controller</a>
<ul class="sectlevel2">
<li><a href="#_controller簡介">6.1. Controller簡介</a></li>
<li><a href="#_controller如何提供資料給view">6.2. Controller如何提供資料給View</a></li>
<li><a href="#_querycontext簡介">6.3. QueryContext簡介</a></li>
<li><a href="#_modelattribute應用">6.4. ModelAttribute應用</a></li>
</ul>
</li>
<li><a href="#_view">7. View</a>
<ul class="sectlevel2">
<li><a href="#_freemarker_2">7.1. FreeMarker</a></li>
<li><a href="#_bootstrap">7.2. Bootstrap</a></li>
<li><a href="#_jquery">7.3. jQuery</a></li>
<li><a href="#_webjars">7.4. WebJars</a></li>
<li><a href="#_tist_ftl">7.5. tist.ftl</a></li>
</ul>
</li>
<li><a href="#_報表">8. 報表</a>
<ul class="sectlevel2">
<li><a href="#_建立excel">8.1. 建立Excel</a></li>
<li><a href="#_建立word">8.2. 建立Word</a></li>
</ul>
</li>
<li><a href="#_測試">9. 測試</a>
<ul class="sectlevel2">
<li><a href="#_單元測試原則">9.1. 單元測試原則</a></li>
<li><a href="#_單元測試使用工具">9.2. 單元測試使用工具</a></li>
<li><a href="#_壓力測試">9.3. 壓力測試</a></li>
</ul>
</li>
<li><a href="#_持續整合">10. 持續整合</a>
<ul class="sectlevel2">
<li><a href="#_持續整合工具_jenkins簡介">10.1. 持續整合工具-Jenkins簡介</a></li>
<li><a href="#_安裝jenkins">10.2. 安裝Jenkins</a></li>
<li><a href="#_安裝openjdk">10.3. 安裝OpenJDK</a></li>
<li><a href="#_安裝git">10.4. 安裝Git</a></li>
<li><a href="#_安裝maven">10.5. 安裝Maven</a></li>
<li><a href="#_plugin安裝">10.6. Plugin安裝</a></li>
<li><a href="#_gitea建立ssh連線">10.7. Gitea建立SSH連線</a></li>
<li><a href="#_建置基本作業">10.8. 建置基本作業</a></li>
<li><a href="#_使用_findbugs_進行靜態分析">10.9. 使用 Findbugs 進行靜態分析</a></li>
<li><a href="#_使用_checkstyle_進行靜態分析">10.10. 使用 Checkstyle 進行靜態分析</a></li>
<li><a href="#_使用_jacoco_進行涵蓋率分析">10.11. 使用 Jacoco 進行涵蓋率分析</a></li>
<li><a href="#_設定_email通知">10.12. 設定 Email通知</a></li>
<li><a href="#_jenkins升級">10.13. Jenkins升級</a></li>
</ul>
</li>
<li><a href="#_範例">11. 範例</a>
<ul class="sectlevel2">
<li><a href="#_如何繼承user增加系統使用者欄位">11.1. 如何繼承User(增加系統使用者欄位)</a></li>
<li><a href="#_如何在application_yml增加額外的設定">11.2. 如何在application.yml增加額外的設定</a></li>
<li><a href="#_如何設定與使用系統參數">11.3. 如何設定與使用系統參數</a></li>
<li><a href="#_如何設定與使用_encodableenum專用">11.4. 如何設定與使用 Encodable(Enum專用)</a></li>
<li><a href="#_檔案上傳">11.5. 檔案上傳</a></li>
<li><a href="#_如何發送_email">11.6. 如何發送 Email</a></li>
<li><a href="#_如何使用spring_security保護_restful_service">11.7. 如何使用Spring Security保護 RESTFul Service</a></li>
<li><a href="#_如何轉換物件型態">11.8. 如何轉換物件型態</a></li>
<li><a href="#_如何建立_web_service_client">11.9. 如何建立 Web Service Client</a></li>
<li><a href="#_如何建立_web_service_server端">11.10. 如何建立 Web Service Server端</a></li>
<li><a href="#_如何使用oauth驗證api">11.11. 如何使用Oauth驗證api</a></li>
<li><a href="#_如何將阿拉伯數字轉成中文數字">11.12. 如何將阿拉伯數字轉成中文數字</a></li>
<li><a href="#_如何使用onetomany級連處理">11.13. 如何使用OneToMany級連處理</a></li>
<li><a href="#_如何設定與使用_logableentity資料異動查詢紀錄">11.14. 如何設定與使用 Logable(Entity資料異動/查詢紀錄)</a></li>
<li><a href="#_如何發送簡訊">11.15. 如何發送簡訊</a></li>
<li><a href="#_如何設定proguard">11.16. 如何設定ProGuard</a></li>
<li><a href="#_如何使用mgov_initializer">11.17. 如何使用mgov-initializer</a></li>
<li><a href="#_如何修改登入流程的驗證項目">11.18. 如何修改登入流程的驗證項目</a></li>
<li><a href="#客製Kaptcha驗證碼">11.19. 如何客製Kaptcha驗證碼</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_coding_style">1. Coding Style</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
檔案命名原則除了java檔以外，其餘檔案一律小寫用減號分隔
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_java">1.1. Java</h3>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
請務必遵循 <a href="http://www.oracle.com/technetwork/java/codeconventions-150003.pdf">Java Code Conventions</a>
其他描述不足之處請參考 <a href="https://google.github.io/styleguide/javaguide.html">Google Java Style Guide</a>，兩者衝突處
以Java Code Conventions為準
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">類型</th>
<th class="tableblock halign-left valign-top">原則</th>
<th class="tableblock halign-left valign-top">備註</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>package</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>一律 <code>com.tist</code> 起頭，嚴禁其他名稱，如果是某客戶專用則加上客戶代號，例如宜蘭為 <code>com.tist.eland</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Annotation</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist.annotation</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Bean</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist.bean</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>設定</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist.config</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>常數</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist.constant</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>加解密</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist.crypt</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>JPA Entity</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist.domain</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Spring Data Repository</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist.repository</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Spring Security</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist.security</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Service</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist.service</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>工具</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist.util</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Controller</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist.web</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Open API</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist.web.rest</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Web Service</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist.ws</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_jpa">1.2. JPA</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">類型</th>
<th class="tableblock halign-left valign-top">原則</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>註解</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>需要撰寫完整的javadoc說明，註解第一行為欄位中文名稱，其他說明寫在註解第二行以後</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Table Name</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>一律小寫英數字組成，嚴禁使用中文，單字之間用 <code>_</code> (底線)隔開</p>
</li>
<li>
<p>字首一律使用 <code>tist_</code></p>
</li>
<li>
<p>總長度不得超過<strong>30</strong>的字元</p>
</li>
<li>
<p>可以指定table name的annotation一律設定table name，不使用預設名稱</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Column Name</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>一律小寫英數字組成，嚴禁使用中文，單字之間用 <code>_</code> (底線)隔開</p>
</li>
<li>
<p>總長度不得超過<strong>30</strong>的字元</p>
</li>
<li>
<p>字尾一律加上 <code>_</code> (底線)</p>
</li>
<li>
<p>可以指定column name的annotation一律設定column name，不使用預設名稱</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Foreign Key Name</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>一律小寫英數字組成，嚴禁使用中文，單字之間用 <code>_</code> (底線)隔開</p>
</li>
<li>
<p>字首一律使用 <code>fk_</code></p>
</li>
<li>
<p>總長度不得超過<strong>30</strong>個字元</p>
</li>
<li>
<p><code>@JoinColumn</code> 一律設定 <code>foreignKey</code>，使用到 <code>@ForeignKey</code> 的name屬性需要符合以上規則</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Unique Key Name</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>一律小寫英數字組成，嚴禁使用中文，單字之間用 <code>_</code> (底線)隔開</p>
</li>
<li>
<p>字首一律使用 <code>uk_</code></p>
</li>
<li>
<p>總長度不得超過<strong>30</strong>個字元</p>
</li>
<li>
<p><code>@Column</code> 的 <code>unique</code> 禁用，統一設定到 <code>@Table</code> 的 <code>uniqueConstraints</code>，其中的 <code>@UniqueConstraint</code> 的name屬性需要符合以上規則</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>屬性有關的annotation位置</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>一律使用lombok <code>@Data</code> annotation，如沒需要不產出getter與setter</p>
</li>
<li>
<p>一律設定在field不設定在property</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>超長文字欄位</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>請使用 <code>@Lob</code> 不要設定長度</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_網址命名原則">1.3. 網址命名原則</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">類型</th>
<th class="tableblock halign-left valign-top">原則</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>基本原則</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>一律小寫英數字組合，嚴禁使用中文</p>
</li>
<li>
<p>不同功能使用 <code>/</code> (斜線) 分隔</p>
</li>
<li>
<p>同一個功能使用 <code>-</code> (減號) 分隔</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>後台網址</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>admin</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>前台網址</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>home</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_freemarker">1.4. Freemarker</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">類型</th>
<th class="tableblock halign-left valign-top">原則</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>基本原則</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>請參閱 <a href="https://google.github.io/styleguide/htmlcssguide.html">Google HTML/CSS Style Guide</a></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>檔名</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>一律小寫英數字，嚴禁使用中文檔名，單字與單字之間優先使用 <code>-</code> (減號)或者 <code>_</code> (底線)分隔</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>根目錄路徑</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>由 <code>application.yml</code> 中的 <code>tist.admin.theme</code> 決定，如果tist.admin.theme的值為default 路徑為 src/main/resources/templates/default</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>後台樣板存放路徑</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>src/main/resources/templates/${tist.admin.theme}/admin/子目錄/檔名</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>前台樣板存放路徑</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>src/main/resources/templates/${tist.admin.theme}/home/子目錄/檔名</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Email樣板存放路徑</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>src/main/resources/templates/${tist.admin.theme}/email/子目錄/檔名</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_javascript">1.5. Javascript</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">類型</th>
<th class="tableblock halign-left valign-top">原則</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>基本原則</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>請參閱 <a href="https://google.github.io/styleguide/jsguide.html">Google JavaScript Style Guide</a></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>檔名</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>一律小寫英數字，嚴禁使用中文檔名，單字與單字之間優先使用 <code>-</code> (減號)或者 <code>_</code> (底線)分隔</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>後台js檔存放路徑</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>src/main/static/js/admin/檔名</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>前台js檔存放路徑</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>src/main/static/js/home/檔名</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>第三方套件放置路徑</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>src/main/static/js/libs/套件名稱/版本號/檔名<br>
例如 bootstrap 3.3.6版檔名為 <code>src/main/static/js/libs/bootstrap/3.3.6/bootstrap.js</code></p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_css">1.6. CSS</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">類型</th>
<th class="tableblock halign-left valign-top">原則</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>基本原則</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>請參閱 <a href="https://google.github.io/styleguide/htmlcssguide.html">Google HTML/CSS Style Guide</a></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>檔名</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>一律小寫英數字，嚴禁使用中文檔名，單字與單字之間優先使用 <code>-</code> (減號)或者 <code>_</code> (底線)分隔</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>後台js檔存放路徑</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>src/main/static/css/admin/檔名</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>前台js檔存放路徑</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>src/main/static/css/home/檔名</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>第三方套件放置路徑</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>src/main/static/css/libs/套件名稱/版本號/檔名<br>
例如 bootstrap 3.3.6版檔名為 <code>src/main/static/css/libs/bootstrap/3.3.6/bootstrap.css</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p>第三方套件字型檔路徑
<code>src/main/static/css/libs/套件名稱/版本號/fonts</code></p>
</li>
<li>
<p>第三方套件圖檔路徑
<code>src/main/static/css/libs/套件名稱/版本號/images</code></p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_靜態資源檔">1.7. 靜態資源檔</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">類型</th>
<th class="tableblock halign-left valign-top">原則</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>檔名</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>一律小寫英數字，嚴禁使用中文檔名，單字與單字之間優先使用-(減號)或者_(底線)分隔</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_開發環境">2. 開發環境</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_jdk">2.1. JDK</h3>
<div class="paragraph">
<p>使用版本為1.8</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
由於Oracle JDK 8於2019年1月停止免費支援更新，為了避免侵權得使用OpenJDK，以下方案擇以下載安裝
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://adoptopenjdk.net/">AdoptOpenJDK</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>請選擇 OpenJDK 8 + HotSpot的版本</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://aws.amazon.com/tw/corretto/">Amazon Corretto</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>請到Download頁籤下載</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://developers.redhat.com/products/openjdk/download/">RedHat OpenJDK</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_版本控制系統用戶端">2.2. 版本控制系統用戶端</h3>
<div class="sect3">
<h4 id="_git">2.2.1. Git</h4>
<div class="paragraph">
<p><a href="https://git-scm.com/">Git</a>，目前全世界最流行的版本控制系統</p>
</div>
</div>
<div class="sect3">
<h4 id="_self_hosted_git_service">2.2.2. Self-hosted Git Service</h4>
<div class="paragraph">
<p><a href="http://git.tist.com.tw:3000">台灣資服Git服務</a>，台灣資服內部<strong>類</strong>github服務，使用gitea
架設，請使用AD帳號密碼登入</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_apache_maven">2.3. Apache Maven</h3>
<div class="paragraph">
<p><a href="https://maven.apache.org/">Apache Maven</a>，Java界主流的build tool之一</p>
</div>
<div class="sect3">
<h4 id="_self_hosted_maven_repository">2.3.1. Self-hosted Maven Repository</h4>
<div class="paragraph">
<p><a href="http://repo.tist.com.tw:8081/" class="bare">http://repo.tist.com.tw:8081/</a>，台灣資服私有儲存庫，使用
<a href="https://www.sonatype.com/nexus-repository-oss">Nexus Repository OSS</a>架設，用來代理公
有儲藏庫、建構私有套件，請使用AD帳號密碼登入</p>
</div>
</div>
<div class="sect3">
<h4 id="_settings_xml">2.3.2. settings.xml</h4>
<div class="paragraph">
<p>Maven全域設定檔，路徑為{家目錄}/.m2/settings.xml，目前用途為設定如何存取
<a href="http://repo.tist.com.tw:8081/" class="bare">http://repo.tist.com.tw:8081/</a>，請將以下內容中的{AD帳號}與{AD密碼}替換</p>
</div>
<div class="listingblock">
<div class="title">settings.xml</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;settings xmlns="http://maven.apache.org/SETTINGS/1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd"&gt;
    &lt;localRepository/&gt;
    &lt;interactiveMode/&gt;
    &lt;usePluginRegistry/&gt;
    &lt;offline/&gt;
    &lt;servers&gt;
        &lt;server&gt;
            &lt;id&gt;tist&lt;/id&gt;
            &lt;username&gt;{AD帳號}&lt;/username&gt;
            &lt;password&gt;{AD密碼}&lt;/password&gt;
        &lt;/server&gt;
        &lt;server&gt;
            &lt;id&gt;tist.release&lt;/id&gt;
            &lt;username&gt;{AD帳號}&lt;/username&gt;
            &lt;password&gt;{AD密碼}&lt;/password&gt;
        &lt;/server&gt;
        &lt;server&gt;
            &lt;id&gt;tist.snapshots&lt;/id&gt;
            &lt;username&gt;{AD帳號}&lt;/username&gt;
            &lt;password&gt;{AD密碼}&lt;/password&gt;
        &lt;/server&gt;
        &lt;server&gt;
            &lt;id&gt;3rdparty&lt;/id&gt;
            &lt;username&gt;{AD帳號}&lt;/username&gt;
            &lt;password&gt;{AD密碼}&lt;/password&gt;
        &lt;/server&gt;
        &lt;server&gt;
            &lt;id&gt;central&lt;/id&gt;
            &lt;username&gt;{AD帳號}&lt;/username&gt;
            &lt;password&gt;{AD密碼}&lt;/password&gt;
        &lt;/server&gt;
    &lt;/servers&gt;
    &lt;mirrors&gt;
        &lt;mirror&gt;
            &lt;id&gt;tist&lt;/id&gt;
            &lt;mirrorOf&gt;*,!jcenter-releases,!jcentral&lt;/mirrorOf&gt;
            &lt;url&gt;http://repo.tist.com.tw:8081/repository/maven-public/&lt;/url&gt;
        &lt;/mirror&gt;
    &lt;/mirrors&gt;
    &lt;proxies/&gt;

    &lt;profiles&gt;
        &lt;profile&gt;
            &lt;id&gt;tist&lt;/id&gt;
            &lt;activation&gt;
                &lt;activeByDefault&gt;true&lt;/activeByDefault&gt;
            &lt;/activation&gt;

            &lt;repositories&gt;
                &lt;repository&gt;
                    &lt;id&gt;central&lt;/id&gt;
                    &lt;url&gt;http://central&lt;/url&gt;
                    &lt;releases&gt;
                        &lt;enabled&gt;true&lt;/enabled&gt;
                        &lt;updatePolicy&gt;daily&lt;/updatePolicy&gt;
                    &lt;/releases&gt;
                    &lt;snapshots&gt;
                        &lt;enabled&gt;true&lt;/enabled&gt;
                        &lt;updatePolicy&gt;always&lt;/updatePolicy&gt;
                    &lt;/snapshots&gt;
                &lt;/repository&gt;
                &lt;repository&gt;
                    &lt;id&gt;jcentral&lt;/id&gt;
                    &lt;name&gt;bintray&lt;/name&gt;
                    &lt;url&gt;http://jcenter.bintray.com&lt;/url&gt;
                    &lt;snapshots&gt;
                        &lt;enabled&gt;false&lt;/enabled&gt;
                    &lt;/snapshots&gt;
                &lt;/repository&gt;
            &lt;/repositories&gt;
            &lt;pluginRepositories&gt;
                &lt;pluginRepository&gt;
                    &lt;id&gt;central&lt;/id&gt;
                    &lt;url&gt;http://central&lt;/url&gt;
                    &lt;releases&gt;
                        &lt;enabled&gt;true&lt;/enabled&gt;
                    &lt;/releases&gt;
                    &lt;snapshots&gt;
                        &lt;enabled&gt;true&lt;/enabled&gt;
                    &lt;/snapshots&gt;
                &lt;/pluginRepository&gt;
                &lt;pluginRepository&gt;
                    &lt;id&gt;jcenter-releases&lt;/id&gt;
                    &lt;name&gt;jcenter&lt;/name&gt;
                    &lt;url&gt;http://jcenter.bintray.com&lt;/url&gt;
                    &lt;snapshots&gt;
                        &lt;enabled&gt;false&lt;/enabled&gt;
                    &lt;/snapshots&gt;
                &lt;/pluginRepository&gt;
            &lt;/pluginRepositories&gt;
        &lt;/profile&gt;
    &lt;/profiles&gt;
    &lt;activeProfiles&gt;
        &lt;activeProfile&gt;tist&lt;/activeProfile&gt;
    &lt;/activeProfiles&gt;
&lt;/settings&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_加速">2.3.3. 加速</h4>
<div class="literalblock">
<div class="title">加速編譯範例</div>
<div class="content">
<pre>mvn -T 1C -offline compile</pre>
</div>
</div>
<div class="paragraph">
<p><code>-T 1C</code> 代表CPU一個核心一個執行序，以Thinkpad X260為例將開啟4個執行序</p>
</div>
<div class="paragraph">
<p><code>-offline</code> 離線不檢查遠端套件的資訊，如果很確定本地端的套件不需要更新可使用此參數
=== IDE</p>
</div>
<div class="paragraph">
<p><a href="https://www.jetbrains.com/idea/download/">IntelliJ IDEA</a>，目前最強JAVA IDE，請下載Ultimate版本</p>
</div>
</div>
<div class="sect3">
<h4 id="_idea_設定">2.3.4. IDEA 設定</h4>
<div class="ulist">
<ul>
<li>
<p>預設檔案系統編碼： <span class="menuseq"><b class="menu">Welcome to Intellij IDEA</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Configure</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Edit Custom VM Options&#8230;&#8203;</b></span> 增加 <code>-Dfile.encoding=UTF-8</code></p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
請關閉所有專案轉換到Welcome to Intellij IDEA畫面
</td>
</tr>
</table>
</div>
</li>
<li>
<p>啟用動態載入樣板： <kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>A</kbd> 輸入 <code>Registry&#8230;&#8203;</code>  將  <code>compiler.automake.allow.when.app.running</code> 打勾</p>
</li>
<li>
<p>取消自動編譯： <span class="menuseq"><b class="menu">File</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Settings&#8230;&#8203;</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Build,Execution,Deployment</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Compiler</b></span> 確認Build project automatically <strong>未勾選 </strong></p>
</li>
<li>
<p>去消密碼記憶： <span class="menuseq"><b class="menu">File</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Settings&#8230;&#8203;</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Appearance &amp; Behavior</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">System Settings</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Passwords</b></span> 勾選 <code>Do not save, forget passwords after restart</code></p>
</li>
<li>
<p>變更編輯器等寬字型： <span class="menuseq"><b class="menu">File</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Settings&#8230;&#8203;</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Editor</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Font</b></span> Font改為 Source Code Pro</p>
</li>
<li>
<p>啟用Visual guides： <span class="menuseq"><b class="menu">File</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Settings&#8230;&#8203;</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Editor</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Code Style</b></span> Visual guides改為 80,120</p>
</li>
<li>
<p>變更*.properties預設編碼： <span class="menuseq"><b class="menu">File</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Settings&#8230;&#8203;</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Editor</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">File Encodings</b></span> <code>Default encoding for properties files</code> 改為UTF-8，勾選 <code>Transparent native-to-ascii conversion</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_plugins">2.3.5. Plugins</h4>
<div class="ulist">
<ul>
<li>
<p>.ignore ： 整合多種工具(含git)的ignore file</p>
</li>
<li>
<p>AngularJS ： 整合Angular</p>
</li>
<li>
<p>AsciiDoc：支援AsciiDoctor語法</p>
</li>
<li>
<p>FindBugs-IDEA： 整合FindBugs</p>
</li>
<li>
<p>Key Promoter X ： 鍵盤魔人專用</p>
</li>
<li>
<p>Lombok Plugin ： 整合Lombok</p>
</li>
<li>
<p>Maven Helper ： Maven小幫手</p>
</li>
<li>
<p>NodeJS: 整合node.js</p>
</li>
<li>
<p>PlantUML integration： 整合PlantUML</p>
</li>
<li>
<p>Save Action： 檔案儲存時額外的處理，例如程式碼排版</p>
</li>
<li>
<p>Translation：線上翻譯</p>
</li>
<li>
<p>String Manipulation：字串樣式切換，例如camel case切換成 snake case</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_資料庫">2.4. 資料庫</h3>
<div class="paragraph">
<p>目前支援Oracle、MSSQL、PostgreSQL，建議平時開發使用Oracle Express比較不會發生資料庫切換問題</p>
</div>
<div class="sect3">
<h4 id="_資料庫用戶端工具">2.4.1. 資料庫用戶端工具</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.jetbrains.com/idea/">IntelliJ IDEA</a></p>
</li>
<li>
<p><a href="https://dbeaver.io/">DBeaver</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_開發指引">3. 開發指引</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_關於mgov_core">3.1. 關於mgov-core</h3>
<div class="paragraph">
<p>mgov乃Mobile Government的簡稱，由顧彬提出，為了滿足政府日益升高行動化政府需求，使用Spring Boot
為基礎開發出來的底層框架，Spring Boot則為目前Java最流行的框架，為Spring Framework的子專案，
特色為簡化Spring Framework使用，開箱即用，降低Spring Framework的使用門檻，支援傳統J2EE或者
微服務架構，足以因應未來系統開發需求。</p>
</div>
</div>
<div class="sect2">
<h3 id="_建立新專案">3.2. 建立新專案</h3>
<div class="ulist">
<ul>
<li>
<p>下載 <a href="http://192.168.1.10:8080/share.cgi?ssid=07afoo2">開發用資料庫OVA檔</a></p>
<div class="ulist">
<ul>
<li>
<p>請使用VMWare Workstation Player開啟，預設管理者帳號密碼為root/tist24231451</p>
</li>
<li>
<p>使用 <code>ifconfig -a</code> 取得 ip位址</p>
</li>
</ul>
</div>
</li>
<li>
<p><span class="menuseq"><b class="menu">File</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">New</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Project&#8230;&#8203;</b></span></p>
<div class="ulist">
<ul>
<li>
<p>選擇 Spring Initializr</p>
</li>
<li>
<p>Project SDK 選擇OpenJDK 1.8 ，如果沒有請按右邊的 <b class="button">New&#8230;&#8203;</b> 新增SDK</p>
</li>
</ul>
</div>
</li>
<li>
<p>Project Metadata</p>
<div class="ulist">
<ul>
<li>
<p>Group 請輸入com.tist</p>
</li>
<li>
<p>Artifact 請輸入小寫有意義的英文詞彙，多個單字請用減號隔開</p>
</li>
<li>
<p>Type 選擇Maven Project</p>
</li>
<li>
<p>Language 選擇Java</p>
</li>
<li>
<p>Packaging 選擇War</p>
</li>
<li>
<p>Java Version 選擇8</p>
</li>
<li>
<p>Package 必須為com.tist</p>
</li>
</ul>
</div>
</li>
<li>
<p>建立完成之後 專案內應該有一個pom.xml與src目錄，這兩項需要使用版本控制系統控管，其他可忽略</p>
<div class="ulist">
<ul>
<li>
<p>刪除 <code>src/main/resources/application.properties</code> ，此為Spring Boot設定檔，格式可以是.properties或者.yml，YAML格式比較彈性所以改用YAML格式</p>
</li>
<li>
<p><code>src/main/resources/</code> 下建立以下四個檔案</p>
<div class="ulist">
<ul>
<li>
<p>application.yml 主設定檔，無論哪種profile都會載入</p>
</li>
<li>
<p>application-live.yml 正式環境設定檔，主要的差異在資料庫與快取設定</p>
</li>
<li>
<p>application-test.yml 測試環境設定檔，主要的差異在資料庫與快取設定</p>
</li>
<li>
<p>application-dev.yml 開發環境設定檔，主要的差異在資料庫與快取設定</p>
</li>
</ul>
</div>
</li>
<li>
<p>複製 <code>{家目錄}/.m2/repository/com/tist/mgov-core/{版本號}/mgov-core-{版本號}.jar</code>  中的 <code>templates/default</code> 目錄所有內容到 <code>src/main/resources/templates/default</code> 中</p>
</li>
<li>
<p>點選 <a href="#idea01">IDEA工作區</a> 中紅框處，選擇Edit Configurations&#8230;&#8203;，Active profiles 輸入dev，則系統啟動時將會載入application.yml與application-dev.yml</p>
</li>
<li>
<p>刪除 <code>src/test/java/com/tist/</code> 下所有單元測試</p>
</li>
</ul>
</div>
</li>
<li>
<p>點選紅匡右側的 <b class="button">Run</b> 或者 <b class="button">Debug</b> 啟動系統</p>
<div class="ulist">
<ul>
<li>
<p>預設帳號密碼為admin/1111</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div id="idea01" class="imageblock">
<div class="content">
<img src="images/idea01.png" alt="IDEA工作區" width="500">
</div>
<div class="title">Figure 1. IDEA工作區</div>
</div>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">tist:
  admin:
    system-name: 台灣資服某系統名稱 <i class="conum" data-value="1"></i><b>(1)</b>
    system-id: 系統線上報修代碼 <i class="conum" data-value="2"></i><b>(2)</b>
    theme: default <i class="conum" data-value="3"></i><b>(3)</b>
    max-depart-level: 5
spring:
  cache:
    jcache:
      config: ehcache3.xml
  jpa:
    generate-ddl: false <i class="conum" data-value="4"></i><b>(4)</b>
    show-sql: false <i class="conum" data-value="5"></i><b>(5)</b>
    database-platform: com.tist.jpa.dialect.OracleDialect <i class="conum" data-value="6"></i><b>(6)</b>
    properties:
      javax:
        persistence:
          validation:
            mode: none
  freemarker:
    enabled: true
    cache: true <i class="conum" data-value="7"></i><b>(7)</b>
    prefix: ${tist.admin.theme}/
    suffix: .ftl
    settings:
      template_exception_handler: ignore
  jackson:
    serialization:
      fail-on-empty-beans: false
      write-dates-as-timestamps: false
  profiles:
    active: live <i class="conum" data-value="8"></i><b>(8)</b>
  resources:
    cache:
      period: 86400s
  session:
    store-type: none
  servlet:
    multipart:
      max-file-size: 40MB
      max-request-size: 50MB
  jmx:
    enabled: false
server:
  servlet:
    session:
      cookie:
        name: PHPSESSIONID</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>系統中文名稱</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>有整合線上報修者，需要向客服確認系統代碼為何</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>如果使用default，則樣板的目錄為 <code>src/main/resources/template/default</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>true 系統啟動過程中將會自動執行SQL DDL語法，有缺漏的欄位或者索引將自動建立，會花費不少時間，如果
無需要平常應該保持false</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>true則任何存取資料庫的 sql語法將會輸出，通常用於除錯，如果無需要平常應該保持false</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>JPA對應的方言，Oracle請使用 <code>com.tist.jpa.dialect.OracleDialect</code>、MSSQL請使用
<code>com.tist.jpa.dialect.MsSqlServerDialect</code>，PostgreSQL則使用Hibernate提供的即可</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>正式環境應該為true以提高效能，開發環境因為樣板隨時會變動，則應該保持false</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>這會影響載入的設定檔，如範例所示系統除了application.yml之外還會順便載入application-live.yml，
且設定值重複者將以live為主</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">application-(live|test|dev).yml</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">spring:
  datasource:
    type: com.zaxxer.hikari.HikariDataSource
    url: jdbc:oracle:thin:@192.168.140.132:1521:xe <i class="conum" data-value="1"></i><b>(1)</b>
    driver-class-name: oracle.jdbc.driver.OracleDriver <i class="conum" data-value="2"></i><b>(2)</b>
    username: tistusr <i class="conum" data-value="3"></i><b>(3)</b>
    password: tistusr1234 <i class="conum" data-value="4"></i><b>(4)</b>
    maximum-pool-size: 10 <i class="conum" data-value="5"></i><b>(5)</b>
  jpa:
    generate-ddl: false
    show-sql: false
    properties:
      hibernate:
        default_schema: TISTUSR <i class="conum" data-value="6"></i><b>(6)</b>
  mail:
    host: 192.168.1.2 <i class="conum" data-value="7"></i><b>(7)</b>
    port: 25

tist:
  admin:
    debug: true <i class="conum" data-value="8"></i><b>(8)</b>
    mail-from: online@tist.com.tw <i class="conum" data-value="9"></i><b>(9)</b>
    upload: D:\upload <i class="conum" data-value="10"></i><b>(10)</b>
    system-url: http://localhost:8080 <i class="conum" data-value="11"></i><b>(11)</b>
debug: true <i class="conum" data-value="12"></i><b>(12)</b>
logging:
  level:
    org:
      hibernate: FATAL <i class="conum" data-value="13"></i><b>(13)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>JDBC URL</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>JDBC Driver</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>資料庫帳號</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>資料庫密碼</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Hikari Connection Pool連線數上限</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Hibernate額外的設定，不一定需要</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>測試用的SMTP host，正式環境請避免</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>發生Exception將顯示在畫面上</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>寄件者，如果 <code>spring.mail.host</code> 為 <code>192.168.1.2</code> 則必須為 <code>online@tist.com.tw</code></td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>檔案上傳存放目錄</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>系統網址</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>Spring Boot 除錯開關，設定true將會吐出海量訊息</td>
</tr>
<tr>
<td><i class="conum" data-value="13"></i><b>13</b></td>
<td>額外的log level設定，可提高或者降低特定套件的log level，範例為提高org.hibernate的log level，則除非發生fatal等級的log否則其他低於fatal的訊息系統將輸出，舉hibernate的例子是有時候可能 <code>spring.jpa.show-sql</code> 的訊息還不夠詳細，不足以除錯，可以設定為debug，將看到海量的hibernate log</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_新增建檔作業">3.3. 新增建檔作業</h3>
<div class="sect3">
<h4 id="_設計並建立資料表_entityclass">3.3.1. 設計並建立資料表 Entity(Class)</h4>
<div class="paragraph">
<p>主資料庫Entity的package為 <code>com.tist.domain</code> ，所以新的Entity必須開在 <code>com.tist.domain</code>
下，建議繼承 <code>com.tist.domain.AbstractEntity</code> ，完成設計後，將設定檔的 <code>generate-ddl</code>
設定為true，啟動程式將資料庫的Table也開啟，並檢查Table的欄位是否與規劃的一致，如果Entity沒異動
請將 <code>generate-ddl</code> 改回false，提高啟動速度。</p>
</div>
</div>
<div class="sect3">
<h4 id="_建立entity對應的repositoryinterface">3.3.2. 建立Entity對應的Repository(Interface)</h4>
<div class="paragraph">
<p>主資料庫Repository的package為 <code>com.tist.repository</code> ，只需要定義interface，系統會自行實
做與產生實體，建議繼承 <code>com.tist.repository.BaseRepository</code> ，命名原則為
Entity Name +Repository。</p>
</div>
</div>
<div class="sect3">
<h4 id="_建立_entity對應的serviceinterface">3.3.3. 建立 Entity對應的Service(Interface)</h4>
<div class="paragraph">
<p>Service的package為 <code>com.tist.service</code> ，為interface，如果要處理的為基本建檔，建議繼承
<code>com.tist.service.AbstractEntityService</code> 。</p>
</div>
</div>
<div class="sect3">
<h4 id="_實做serviceclass">3.3.4. 實做Service(Class)</h4>
<div class="paragraph">
<p>實做Service的package為 <code>com.tist.service.impl</code> ，如果interface有繼承
<code>com.tist.service.AbstractEntityService</code> ，則實做必須繼承
<code>com.tist.service.impl.AbstractEntityServiceImpl</code>，class level必須設定 <code>@Service</code>
其中的name屬性建議設定該類別的完整名稱即可，需要實做fetchAndUpdateBy方法，範例如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Transactional
@Service("com.tist.service.impl.CareNoticeServiceImpl")
public class CareNoticeServiceImpl extends AbstractEntityServiceImpl&lt;CareNotice, CareNoticeRepository&gt;
    implements CareNoticeService {

    /**
     * 不複製的屬性
     */
    private static final String[] EXCLUDE_PROPERTIES = new String[] {
        "id",
        "createUserId",
        "createTime"};


    @Override
    public CareNotice fetchAndUpdateBy(CareNotice source) {
        if (null == source) {
            return null;
        }

        // 新增時處理

        if (StringUtils.isEmpty(source.getId())) {
            source.setId(null);
            return source;
        }

        // 修改時處理
        return prepareMergedEntity(source, EXCLUDE_PROPERTIES);
    }

}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Service不建議繼續使用CrudService與CrudServiceImpl，因為相依了jxls會導致模組的
肥大，且不一定所有Service都需要jxls，所以建議改用AbstractEntityService與
AbstractEntityServiceImpl，原本export功能抽離到 <code>com.tist.util.CrudServiceUtils</code>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_建立controller">3.3.5. 建立Controller</h4>
<div class="paragraph">
<p>後台Controller的package為 <code>com.tist.web.admin</code>，相關說明請參閱範例中的註解</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Controller("com.tist.web.admin.CareNoticeController")
@RequestMapping("/admin/care-notice") <i class="conum" data-value="1"></i><b>(1)</b>
@SessionAttributes("queryContext") <i class="conum" data-value="2"></i><b>(2)</b>
public class CareNoticeController {

    // 查詢畫面的樣板名稱
    private static final String VIEW_INDEX = "/admin/care-notice/care-notice-index";

    // 編輯畫面的樣板名稱
    private static final String VIEW_INPUT = "/admin/care-notice/care-notice-input";

    // 轉址回查詢畫面的指令
    private static final String REDIRECT_INDEX = "redirect:index";

    // 注入對應的Service
    @Setter
    @Resource
    private CareNoticeService careNoticeService;

    // 顯示查詢畫面
    @RequestMapping({ UrlPattern.EMPTY, UrlPattern.INDEX })
    public String index(
        @ModelAttribute("queryContext") QueryContext queryContext,
        Model model) {
        Page&lt;CareNotice&gt; page = careNoticeService.queryAll(queryContext);
        model.addAttribute("page", page);
        return VIEW_INDEX;
    }

    // 顯示編輯畫面
    @GetMapping(UrlPattern.EDIT)
    public String edit(@PathVariable("id") String id, Model model) {
        model.addAttribute("main", careNoticeService.findOne(id));
        return VIEW_INPUT;
    }

    // 處理更新
    @PostMapping(UrlPattern.UPDATE)
    public String update(
        @Validated({Update.class}) @ModelAttribute("main") CareNotice main,
        BindingResult result,
        Model model) {
        if (result.hasErrors()) {
            return VIEW_INPUT;
        }
        careNoticeService.update(main);
        return REDIRECT_INDEX;
    }

    // 顯示新增畫面
    @GetMapping(UrlPattern.ADD)
    public String add(Model model) {
        CareNotice careNotice = new CareNotice();
        model.addAttribute("main", careNotice);
        return VIEW_INPUT;
    }

    // 處理新增
    @PostMapping(UrlPattern.SAVE)
    public String save(
        @Validated({Insert.class}) @ModelAttribute("main") CareNotice main,
        BindingResult result,
        Model model) {

        String viewName = REDIRECT_INDEX;
        if (result.hasErrors()) {
            viewName = VIEW_INPUT;
        } else {
            careNoticeService.save(main);
        }
        return viewName;
    }

    // 處理刪除
    @GetMapping(UrlPattern.DELETE)
    @ResponseBody
    public boolean delete(@PathVariable("id") String id) {
        CareNotice target = careNoticeService.delete(id);
        return target != null;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>class level 定義兩層的url pattern，第一層一律是admin，第二層則是類別名稱去掉
Controller轉成Lower Hyphen的命名規則，也就是單字都小寫用-隔開，Controller的name則設定該類別
的完整名稱</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>將查詢條件紀錄在session</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_建立樣板檔案">3.3.6. 建立樣板檔案</h4>
<div class="paragraph">
<p>樣板檔案的檔名與路徑與Controller定義的名稱一致，例如 查詢畫面名稱為
<code>/admin/care-notice/care-notice-index</code> ，則編輯樣板檔案就叫做
<code>/admin/care-notice/care-notice-index.ftl</code> 。</p>
</div>
<div class="listingblock">
<div class="title">查詢畫面範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="ftl">&lt;#ftl output_format="HTML" /&gt;
&lt;!DOCTYPE html&gt;
&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;

&lt;head&gt;
    &lt;#include "*/include/meta.ftl" /&gt;
&lt;/head&gt;
&lt;body class="hold-transition skin-blue sidebar-mini sidebar-collapse"&gt;
    &lt;div class="wrapper"&gt;
        &lt;#include "*/include/nav-top.ftl" /&gt;
        &lt;#include "*/include/nav-side.ftl" /&gt;
        &lt;div class="content-wrapper"&gt;
            &lt;@tist.breadCrumbs /&gt;
            &lt;section class="content"&gt;
                &lt;div class="con_main container"&gt;
                    &lt;form action="&lt;@spring.url "/admin/department " /&gt;" method="POST"&gt;
                        &lt;input type="hidden" name="${(_csrf.parameterName)!}" value="${(_csrf.token)!}" /&gt;
                        &lt;div class="con-box"&gt;
                            &lt;@tist.crudButtons prefix="/admin/department" actions=[ "add", "search", "export"] /&gt;
                            &lt;div class="panel panel-success"&gt;
                                &lt;div class="panel-heading"&gt;
                                    &lt;h3 class="panel-title"&gt;&lt;@spring.message "admin.index.data-filter" /&gt;&lt;/h3&gt;
                                &lt;/div&gt;
                                &lt;div class="panel-body"&gt;
                                    &lt;div class="form-group"&gt;
                                        &lt;label class="col-md-2"&gt;
                                            &lt;@spring.message "department.name" /&gt;
                                        &lt;/label&gt;
                                        &lt;div class="col-md-10"&gt;
                                            &lt;@tist.text path="queryContext.conditions[like-name]" /&gt;
                                        &lt;/div&gt;
                                    &lt;/div&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                        &lt;#if (page?? &amp;&amp; page.totalElements&gt; 0 ) &gt;
                        &lt;!-- 查詢結果區 --&gt;
                        &lt;div class="table-box"&gt;
                            &lt;table class="table table-bordered table-hover" summary=""&gt;
                                &lt;caption class="text-center"&gt;&amp;nbsp;&lt;/caption&gt;
                                &lt;thead&gt;
                                    &lt;tr&gt;
                                        &lt;th&gt;
                                            &lt;@spring.message "department.no" /&gt;
                                            &lt;@spring.formHiddenInput path="queryContext.sorts[no]" /&gt;
                                        &lt;/th&gt;
                                        &lt;th&gt;
                                            &lt;@spring.message "department.name" /&gt;
                                            &lt;@spring.formHiddenInput path="queryContext.sorts[name]" /&gt;
                                        &lt;/th&gt;
                                        &lt;th&gt;
                                            &lt;@spring.message "department.type" /&gt;
                                        &lt;/th&gt;
                                        &lt;th&gt;
                                            &lt;@spring.message "admin.index.function" /&gt;
                                        &lt;/th&gt;
                                    &lt;/tr&gt;
                                &lt;/thead&gt;
                                &lt;tbody&gt;
                                &lt;#list page.content as item&gt;
                                    &lt;tr&gt;
                                        &lt;td&gt;${item.no}&lt;/td&gt;
                                        &lt;td&gt;${item.name}&lt;/td&gt;
                                        &lt;td&gt;${item.typeDescription}&lt;/td&gt;
                                        &lt;td class="col-md-3"&gt;
                                            &lt;@tist.baseRowButtons updateUrl="/admin/department/update/${item.id}" deleteUrl="/admin/department/delete/${item.id}" /&gt;
                                        &lt;/td&gt;
                                    &lt;/tr&gt;
                                &lt;/#list&gt;
                                &lt;/tbody&gt;
                            &lt;/table&gt;
                            &lt;@tist.pagination page=page /&gt;
                        &lt;/div&gt;
                        &lt;#else /&gt;
                            &lt;@tist.noResult /&gt;
                        &lt;/#if&gt;
                    &lt;/form&gt;
                &lt;/div&gt;
            &lt;/section&gt;
        &lt;/div&gt;
        &lt;#include "*/include/footer.ftl" /&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>編輯畫面範例</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="ftl">&lt;#ftl output_format="HTML" /&gt;
&lt;!DOCTYPE html&gt;
&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;

&lt;head&gt;
    &lt;#include "*/include/meta.ftl" /&gt;
    &lt;script src="&lt;@spring.url "/js/admin/department.js" /&gt;"&gt;&lt;/script&gt;
    &lt;script&gt;
    parentIds = ["${parentIds?default([""])?join("\",\"")}"];
    &lt;/script&gt;
&lt;/head&gt;
&lt;body class="hold-transition skin-blue sidebar-collapse sidebar-mini"&gt;
    &lt;div class="wrapper"&gt;
        &lt;#include "*/include/nav-top.ftl" /&gt;
        &lt;#include "*/include/nav-side.ftl" /&gt;
        &lt;div class="content-wrapper" id="content"&gt;
            &lt;@tist.breadCrumbs /&gt;
            &lt;section class="content"&gt;
                &lt;div class="con_main container"&gt;
                    &lt;div class="con-box"&gt;
                        &lt;#if (department.id)??&gt;
                            &lt;#assign action="/admin/department/update" /&gt;
                        &lt;#else&gt;
                            &lt;#assign action="/admin/department/add" /&gt;
                        &lt;/#if&gt;
                        &lt;form role="form" action="&lt;@spring.url action /&gt;" method="POST" enctype="multipart/form-data" class="tist-validate"&gt;
                            &lt;input type="hidden" name="${(_csrf.parameterName)!}" value="${(_csrf.token)!}" /&gt;
                            &lt;@spring.formHiddenInput path="department.id" /&gt;
                            &lt;@spring.formHiddenInput path="department.parent.id" /&gt;
                            &lt;ul class="nav nav-tabs"&gt;
                                &lt;li class="active"&gt;
                                    &lt;!--&lt;a href="#"&gt;
                                        &lt;@tist.currentMenuName /&gt;
                                    &lt;/a&gt;--&gt;
                                &lt;/li&gt;
                            &lt;/ul&gt;
                            &lt;div class="con_main col-md-12"&gt;
                                &lt;div class="form-group col-md-12"&gt;
                                    &lt;label class="col-md-2"&gt;
                                        &lt;@spring.message "department.parent" /&gt;
                                    &lt;/label&gt;
                                    &lt;div id="parentContainer" class="col-md-10"&gt;
                                    &lt;/div&gt;
                                &lt;/div&gt;
                                &lt;div class="form-group col-md-12"&gt;
                                    &lt;label class="col-md-2 required"&gt;
                                        &lt;@spring.message "department.no" /&gt;
                                    &lt;/label&gt;
                                    &lt;div class="col-md-10"&gt;
                                        &lt;@tist.text path="department.no" attributes='required' /&gt;
                                    &lt;/div&gt;
                                &lt;/div&gt;
                                &lt;div class="form-group col-md-12"&gt;
                                    &lt;label class="col-md-2 required"&gt;
                                        &lt;@spring.message "department.name" /&gt;
                                    &lt;/label&gt;
                                    &lt;div class="col-md-10"&gt;
                                        &lt;@tist.text path="department.name" attributes='required' /&gt;
                                    &lt;/div&gt;
                                &lt;/div&gt;
                                &lt;div class="form-group col-md-12"&gt;
                                    &lt;label class="col-md-2 required"&gt;
                                        &lt;@spring.message "department.type" /&gt;
                                    &lt;/label&gt;
                                    &lt;div class="col-md-10"&gt;
                                        &lt;@tist.checkboxs path="department.types" options=types attributes="required" /&gt;
                                    &lt;/div&gt;
                                &lt;/div&gt;
                                &lt;div class="form-group col-md-12"&gt;
                                    &lt;label class="col-md-2"&gt;
                                        &lt;@spring.message "department.address" /&gt;
                                    &lt;/label&gt;
                                    &lt;div class="col-md-10"&gt;
                                        &lt;@tist.address cityPath="department.city.id" townPath="department.town.id" villagePath="department.village.id" addressPath="department.address" /&gt;
                                    &lt;/div&gt;
                                &lt;/div&gt;
                                &lt;div class="col-md-12"&gt;
                                &lt;#if (department.id)??&gt;
                                    &lt;button type="submit" class="btn btn-raised btn-info"&gt;
                                        &lt;@spring.message "admin.button.edit" /&gt;
                                    &lt;/button&gt;
                                    &lt;#else&gt;
                                        &lt;button type="submit" class="btn btn-raised btn-info"&gt;
                                            &lt;@spring.message "admin.button.add" /&gt;
                                        &lt;/button&gt;
                                &lt;/#if&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;
                        &lt;/form&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/section&gt;
        &lt;/div&gt;
        &lt;#include "*/include/footer.ftl" /&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_註冊選單">3.3.7. 註冊選單</h4>
<div class="paragraph">
<p>使用後台的選單管理將新增的Controller加上去，請在連結的部份選擇內建，並且在下拉選擇對應的Controller。</p>
</div>
</div>
<div class="sect3">
<h4 id="_授權">3.3.8. 授權</h4>
<div class="paragraph">
<p>使用後台的角色管理，設定指定角色的選單，將新增的選單打勾後按修改即可完成授權，如果發生選單無法出現的情況，請重新啟動服務。
=== 模組列表</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. mgov-core 模組列表</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">名稱</th>
<th class="tableblock halign-left valign-top">groupId</th>
<th class="tableblock halign-left valign-top">artifactId</th>
<th class="tableblock halign-left valign-top">備註</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>核心</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>mgov-core</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>標配</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>測試</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>mgov-core-jupiter</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>標配，整合JUnit5</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Webjars</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>mgov-core-webjars</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>標配，管理jQuery、Bootstrap、FontAwesome、Ionicons、jsTree、fontawesome-iconpicker、 CKEditor、js-cookie、bootstrap-notify、jQuery Validation、html5shiv、respond、 typeahead.js、clockpicker</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>JPA核心</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>mgov-core-kit</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>標配</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>使用者</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>mgov-core-user</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>標配，使用者核心</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>使用者</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>mgov-core-user-web</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>標配，包含使用者、部門、功能選單、角色與權限相關維護作業</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>安全</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>mgov-core-security</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>標配，管理系統授權與認證</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>系統參數</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>mgov-core-sys</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>標配。系統參數核心</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>系統參數</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>mgov-core-sys-web</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>標配。管理系統參數設定</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>加密</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>mgov-core-crypt</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>標配，提供簡易加解密工具</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>檔案</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>mgov-core-file</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>標配，統一附件架構規範，提供檔案上傳下載功能</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>行政區域代碼</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>mgov-core-country</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>標配，行政區域代碼核心</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>行政區域代碼</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>mgov-core-country-web</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>標配，行政區域代碼管理</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>申請單</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>mgov-core-appform</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>選配</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>公佈欄</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>mgov-core-bulletin</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>選配</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>檔案下載</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>mgov-core-download</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>選配</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>JasperReports整合</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>mgov-core-jasperreports</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>選配，目前支援docx、xls、ods、odt、pdf等格式</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Mobile Device Management</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>mgov-core-mdm</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>選配</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>OAuth</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>mgov-core-oauth</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>選配，整合OAuth</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>問卷調查</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>mgov-core-questionnaire</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>選配</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>個資</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>mgov-core-person</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>選配，用於紀錄個人基本資料</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>entity異動紀錄</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>mgov-core-log</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>選配，entity異動紀錄功能</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>參數檔</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>mgov-core-config</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>標配，標配常數檔讀取</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>電子信箱</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>mgov-core-mail</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>標配，電子信箱寄發模組</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>簡訊</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>com.tist</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>mgov-core-sms</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>標配，簡訊寄發模組</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_資料庫_2">4. 資料庫</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_為何要使用_spring_data_jpa">4.1. 為何要使用 Spring Data JPA</h3>
<div class="ulist">
<ul>
<li>
<p>Spring Boot預設整合SQL的方案</p>
</li>
<li>
<p>Spring Data 整合主流的SQL與NoSQL資料庫，並且提供統一的Repository介面，減低開發成本</p>
</li>
<li>
<p>JPA適合OLTP 類型的系統，台灣資服的系統多數屬於OLTP</p>
</li>
<li>
<p>支援執行原生sql</p>
</li>
<li>
<p>JPA支援auto ddl，設計完Entity可在資料庫自動建立對應的Table，減低開發成本</p>
</li>
<li>
<p>自行開發的JPADoclet可將Entity中的註解與屬性轉換成資料庫設計文件</p>
</li>
<li>
<p>JPA跨資料庫，支援分頁查詢，減低系統切換資料庫的成本</p>
</li>
<li>
<p>降低資料庫正規化的成本，提昇查詢效率</p>
</li>
<li>
<p>底層仍然是使用JDBC，享有最穩定最有效率的資料庫存取機制</p>
</li>
<li>
<p>使用Bean Validation進行欄位檢查，簡易的annotation設定即可完成</p>
</li>
<li>
<p>整合transaction，無須呼叫commit或者rollback指令，系統會在適當的時機自動執行</p>
</li>
<li>
<p>除了Repository提供基本的CRUD功能，亦可自行擴充Repository介面</p>
</li>
<li>
<p>具備audit機制與entity listener，統一的欄位可透過統一的程式處理，避免重工</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_為何不應該直接使用jdbc">4.2. 為何不應該直接使用JDBC</h3>
<div class="ulist">
<ul>
<li>
<p>JDBC API含有大量的checked exception，導致程式碼會有大量的nested block，降低了程式碼的可
閱讀性，提高了系統的開發與維護成本</p>
</li>
<li>
<p>JDBC 的Connection與Statement均為Closeable資源，如果沒有執行close將導致系統資源被佔用，
不斷的累積下可能導致整個系統崩潰，但是由於checked exception與觀念不正確的關係，即使老手都可能因
為不當的程式碼撰寫導致資源沒正常回收，因為沒有適當的防範機制，最理想的解法是避免直接使用。</p>
</li>
<li>
<p>JDBC本身不支援分頁查詢，必須使用SQL特定語法進行查詢，這語法每種SQL的下法皆不同，稱為方言，也就
是使用方言將導致資料庫要轉換到別種資料庫成本極高</p>
</li>
<li>
<p>得額外撰寫Java Bean與處理的程式碼接收來自sql 執行結果，欄位檢查、transaction都需要自行處理，
基本的CRUD處理需要撰寫額外的sql，開發速度會遠慢於使用JPA</p>
</li>
<li>
<p>所有audit欄位與基本欄位處理、log機制，都需要額外撰寫程式碼處理</p>
</li>
<li>
<p>由於沒有針對資料庫正規化提供友善的功能，設計人員往往因為急就章或者偷懶設計了結構不當的資料表，導
致了後續的效能瓶頸，往往是累積的大量資料後才被發現，失敗成本極高</p>
</li>
<li>
<p>得自行規劃DAO架構</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_設計entity">4.3. 設計Entity</h3>
<div class="paragraph">
<p>JPA只是減輕使用sql的成本，本質上還是使用sql，對於sql的基本觀念還是得非常熟悉，至於
Spring Data JPA的參考文件有</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/">Spring Data JPA - Reference Documentation</a></p>
</li>
<li>
<p><a href="https://javaee.github.io/tutorial/persistence-intro.html#BNBPZ">Introduction to the Java Persistence API</a></p>
</li>
<li>
<p><a href="https://download.oracle.com/otn-pub/jcp/persistence-2_2-mrel-spec/JavaPersistence.pdf">JSR 338: Java
Persistence API, Version 2.2</a></p>
</li>
<li>
<p><a href="http://hibernate.org/orm/documentation">Hibernate ORM Documentation</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_注意事項">4.3.1. 注意事項</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>泛型：JPA支援有限，盡量避免將欄位型態與泛型結合</p>
</li>
<li>
<p><code>javax.persistence.ElementCollection</code> 如果內容型態為Entity，應該改用 <code>@ManyToMany</code>
之類的設計</p>
</li>
<li>
<p>欄位屬性名稱應該避免使用多餘的前綴字，例如案號應該使用no而不是appNo，如此可以統一意義
上相同的欄位名稱，可以使用interface進行規範，好處是未來可使用Spring Data 的
Projection功能提高查詢效率</p>
</li>
<li>
<p>設計的Entity如果是共用的套件，可能在不同的SQL上使用，建議使用Oracle進行開發測試，因為
Oracle的要求最為嚴格，Oracle上面沒問題的，通常其他SQL也不會有問題。</p>
</li>
<li>
<p>annotation位置一律放在 field，禁止放在setter或者 getter，因為Entity會搭配 <strong>Lombok</strong>
使用，平常不會有getter與setter的code，AbstractEntity的 <code>@Id</code> 是放在field，
Hibernate掃描annotation是根據 <code>@Id</code> 放置的位置，所以繼承 <code>AbstractEntity</code> 的
Entity，setter與getter的JPA annotation將不會掃到</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_類別設計">4.3.2. 類別設計</h4>
<div class="ulist">
<ul>
<li>
<p>如果需要紀錄附件，請實做 <code>FileAttachable</code> 介面，強制附件欄位名稱與複數附件，單一附件
的設計容易遭遇事後使用者翻盤為多檔的調整成本，系統有提供統一的服務處理 <code>FileAttachable</code></p>
<div class="listingblock">
<div class="title">FileAttachable範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class Bulletin extends AppForm implements FileAttachable&lt;FileAttach&gt; {</code></pre>
</div>
</div>
</li>
<li>
<p>如果欄位會有name這個欄位，可實做 <code>Feature</code> 介面，可結合Spring Data Projection做更有效率的查詢</p>
<div class="listingblock">
<div class="title">Feature範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class CountryCode extends AbstractEntity implements Feature {</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Repository使用Feature範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public interface CountryCodeRepository extends BaseRepository&lt;CountryCode, String&gt; {
    List&lt;Feature&gt; findAllByParentCode(String code); <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>實際sql只會撈id與name對應的欄位，這樣查詢更有效率</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>如果欄位會有name與no這兩個欄位，可實做 <code>FeatureWithNo</code> 介面</p>
<div class="listingblock">
<div class="title">FeatureWithNo範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class SysConfig extends AbstractEntity implements FeatureWithNo {</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div id="json-identity-info" class="ulist">
<ul>
<li>
<p>如果有欄位為雙向關聯，可增加
<code>@JsonIdentityInfo(generator = ObjectIdGenerators.PropertyGenerator.class, property = "id")</code>
避免轉json時的無窮迴圈</p>
</li>
<li>
<p>請務必使用 <strong>Lombok</strong> 的 <code>@Data</code> ，盡量使用 <code>@EqualsAndHashCode</code> 與 <code>@ToString</code></p>
</li>
<li>
<p>部份欄位需要視情況調整 <strong>fetch type</strong> 從 <strong>lazy</strong> 變為 <strong>eager</strong> 可使用
<code>@NamedEntityGraph</code> 與 <code>@EntityGraph</code></p>
<div class="listingblock">
<div class="title">NamedEntityGraph範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@NamedEntityGraphs({
    @NamedEntityGraph(
            name = "with-department-roles",
            attributeNodes = {
                    @NamedAttributeNode("department"),
                    @NamedAttributeNode("roles")})})
@Data
@EqualsAndHashCode(callSuper = false, doNotUseGetters = true, of = {"userId"})
@ToString(doNotUseGetters = true, of = {"userId", "name"})
public class User extends AbstractEntity implements Feature {</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">EntityGraph範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public interface UserRepository extends BaseRepository&lt;User, String&gt; {
    @EntityGraph("with-department-roles")
    User findByUserId(String userId);
}</code></pre>
</div>
</div>
</li>
<li>
<p>額外的唯一值條件約束設定在 <code>@Table</code> 的 <code>uniqueConstraints</code></p>
<div class="listingblock">
<div class="title">額外的UniqueConstraint設定</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Table(
    name = "tist_child",
    uniqueConstraints = {
        @UniqueConstraint(name = "uk_child_no", columnNames = {"no_"})
    }
)</code></pre>
</div>
</div>
</li>
<li>
<p>Entity生命週期中一定要做的操作可使用 <code>@EntityListeners</code></p>
<div class="listingblock">
<div class="title">EntityListeners範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@EntityListeners(ChildcareStaffListener.class)
public class ChildcareStaff extends User implements CitizenCertificate {

    @ManyToOne
    @JoinColumn(
        name = "org_id_",
        foreignKey = @ForeignKey(name = "fk_tist_cwis_user_org")
    )
    private CwisOrg org;
}

public class CwisUserListener {

    @PrePersist
    @PreUpdate
    public void syncDepartment(CwisUser user) {
        if (!Objects.isNull(user.getOrg())) {
            user.setDepartment(user.getOrg());
        }
    }
}</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_欄位field設計">4.3.3. 欄位(Field)設計</h4>
<div class="ulist">
<ul>
<li>
<p>避免使用原生型態如 <code>int</code> 、 <code>long</code> 、 <code>boolean</code> 、 <code>float</code> 、 <code>double</code> ，而是應該
改用對應的Wrapper如 <code>Integer</code> 、 <code>Long</code> 、 <code>Boolean</code> 、 <code>Float</code> 、 <code>Double</code></p>
<div class="listingblock">
<div class="title">基本型態欄位範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Column(name="name_")
private String name;</code></pre>
</div>
</div>
</li>
<li>
<p>日期型態請使用 <code>LocalDate</code></p>
<div class="listingblock">
<div class="title">日期型態欄位範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Column(name="birthday_")
private LocalDate birthday;</code></pre>
</div>
</div>
</li>
<li>
<p>日期時間型態請使用 <code>LocalDateTime</code></p>
<div class="listingblock">
<div class="title">日期時間型態欄位範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Column(name="work_time_")
private LocalDateTime workTime;</code></pre>
</div>
</div>
</li>
<li>
<p>避免使用多餘的前綴字</p>
</li>
<li>
<p>代碼類的欄位請使用 <code>SysConfig</code></p>
<div class="listingblock">
<div class="title">SysConfig many-to-one 範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@ManyToOne
@JoinColumn(
    name = "type_id_",
    foreignKey = @ForeignKey(name = "fk_childcare_center_type")
)
private SysConfig type;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">SysConfig many-to-many 範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@ManyToMany
@JoinTable(
    name = "tist_childcare_quasi_public_qr",
    joinColumns = {
        @JoinColumn(
            name = "quasi_public_id_",
            foreignKey = @ForeignKey(name = "fk_childcare_quasi_public_qr_q")
        )
    },
    inverseJoinColumns = {
        @JoinColumn(
            name = "reason_id_",
            foreignKey = @ForeignKey(name = "fk_childcare_quasi_public_qr_r")
        )
    },
    uniqueConstraints = @UniqueConstraint(
        name = "uk_childcare_quasi_public_qr",
        columnNames = {"quasi_public_id_", "reason_id_"}))
private List&lt;SysConfig&gt; quitReasons;</code></pre>
</div>
</div>
</li>
<li>
<p>列舉類的請務必實做 <code>Encodable</code> 介面</p>
<div class="listingblock">
<div class="title">Encodable範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@RequiredArgsConstructor <i class="conum" data-value="1"></i><b>(1)</b>
public enum AuthType implements Encodable {

    一般帳號登入("user_password"), 自然人憑證登入("moica"), 無密碼登入("no_password");

    @NonNull <i class="conum" data-value="2"></i><b>(2)</b>
    @Getter <i class="conum" data-value="3"></i><b>(3)</b>
    private String code;
}

@Converter(autoApply = true) <i class="conum" data-value="4"></i><b>(4)</b>
public class AuthTypeConverter extends EncodableAttributeConverter&lt;AuthType&gt; {

    public AuthTypeConverter() {
        super(AuthType.class);
    }
}

public class CwisUser extends User implements CitizenCertificate {

    @ElementCollection
    @CollectionTable(
        name = "tist_cwis_user_auth_type",
        joinColumns = @JoinColumn(
            name = "user_id_",
            foreignKey = @ForeignKey(name = "fk_cwis_user_auth_type_user")
        ),
        uniqueConstraints = @UniqueConstraint(
            name = "uk_cwis_user_auth_type_ua",
            columnNames = {"user_id_", "auth_type_"}
        )
    )
    @Column(name = "auth_type_")
    private List&lt;AuthType&gt; authTypes;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Lombok annotation 可將設定 <code>@NonNull</code> 欄位作為建構元的參數</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Lombok annotation 標記為必填欄位</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>Encodable</code> 需要實作 <code>getCode</code> 直接利用Lombok <code>@Getter</code> 完成</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>建立 <code>Encodable</code> 對應的 <code>AttributeConverter</code></td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>可整合Bean Validation，詳情參閱
<a href="https://beanvalidation.org/2.0/spec/#builtinconstraints">Built-in Constraint definitions</a></p>
<div class="listingblock">
<div class="title">Size範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Size(max = 10) <i class="conum" data-value="1"></i><b>(1)</b>
@Column(name = "no_")
private String no;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>欄位長度將會被限制在10，且驗證時會檢查實際內容是不是小於10</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">NotEmpty範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@NotEmpty(groups = {Insert.class, Update.class}) <i class="conum" data-value="1"></i><b>(1)</b>
@Column(name = "organizer_name_")
private String organizerName;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>不能為null或者空字串，驗證時必須屬於 <code>Insert</code> 或 <code>Update</code> 群組才會檢查，其他情況
不檢查，拿掉 <code>groups</code> 則無論那個群組都檢查</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>整合Jackson(整合ajax或者rest api需要將entity轉換成json格式時使用)，entity轉換json
需要注意以下幾個議題</p>
<div class="ulist">
<ul>
<li>
<p>雙向關聯需要設定斷點，避免無窮迴圈，Jackson設計斷點的機制有多種，其中一種
<a href="#json-identity-info">JsonIdentityInfo</a>是設定在class level，其他多數設定在field level</p>
</li>
<li>
<p>避免json過於肥大影響效能</p>
</li>
<li>
<p>瀏覽器是否能正常解析</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">JsonView範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class ChildcareCourse extends AbstractEntity {

    @JsonView(View.Summary.class) <i class="conum" data-value="1"></i><b>(1)</b>
    @Column(name = "no_")
    private String no;
}

public class ChildcareCourseController{

    @JsonView(View.Summary.class) <i class="conum" data-value="2"></i><b>(2)</b>
    @PostMapping(UrlPattern.QUERY)
    public Page&lt;ChildcareCourse&gt; query(
        @RequestBody(required = false) QueryContext queryContext
    ) {
        return RestControllerUtils.query(service, queryContext, this);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>標記用，可以是任意類別或介面</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Controller指定特定的 <code>@JsonView</code> 則回傳的Entity只會涵蓋符合的欄位，可用來減輕json
體積或者建立斷點機制</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">JsonProperty範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@JsonProperty(access = JsonProperty.Access.WRITE_ONLY) <i class="conum" data-value="1"></i><b>(1)</b>
@Column(name = "cert_")
private String cert;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>表示此欄位對於Jackson的 <code>ObjectMapper</code> 只能 <strong>寫</strong> 不能讀，ObjectMapper 格式化json
時會忽略此欄位，解析json的時候可以解析此欄位，需要斷點通常是在轉換json的時候，可作
為一種斷點的手段</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">JsonIgnore範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@JsonIgnore <i class="conum" data-value="1"></i><b>(1)</b>
@OneToMany(mappedBy = "center")
private List&lt;ChildcareStaff&gt; staffs;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>無論是格式化或者解析都會被忽略，通常是不太需要傳遞到client端的欄位才可使用</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">JsonManagedReference與JsonBackReference</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class GoodsStorage extends AbstractEntity {

    @JsonManagedReference <i class="conum" data-value="1"></i><b>(1)</b>
    @ManyToOne
    @JoinColumn(
            name = "goods_warehouse_id_",
            foreignKey = @ForeignKey(name = "fk_goods_storage_warehouse"))
    private GoodsWarehouse goodsWarehouse;
}

public class GoodsWarehouse extends AbstractEntity {

    @JsonBackReference <i class="conum" data-value="2"></i><b>(2)</b>
    @OneToMany(mappedBy = "goodsWarehouse")
    private List&lt;GoodsStorage&gt; goodsStorages;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>轉換成json時此欄位將正常轉換</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>轉換成json時將忽略，解析json時很容易出錯，使用 <code>JsonBackReference</code> 時務必詳細測試
entity的json序列化與反序列化</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">JsonFilter</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@JsonFilter("exclude-write-only") <i class="conum" data-value="1"></i><b>(1)</b>
public class User extends AbstractEntity implements Feature {

    @WriteOnly <i class="conum" data-value="2"></i><b>(2)</b>
    private String password;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>設定使用id 為 <code>exclude-write-only</code> 的Filter(此為mgov-core自訂的Filter)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>使用自訂的 annotation @WriteOnly</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
如果是自建的ObjectMapper需要設定 <code>FilterProvider</code> 否則將無效果
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_關聯">4.3.4. 關聯</h4>
<div class="listingblock">
<div class="title">ManyToOne(多對一)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class User extends AbstractEntity implements Feature {

    @ManyToOne <i class="conum" data-value="1"></i><b>(1)</b>
    @JoinColumn(
            name = "depart_id_",
            foreignKey = @ForeignKey(name = "fk_user_department")
    )
    private Department department;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>代表一個 <code>Department</code> 會有多個 <code>User</code> ， <code>User</code> 與 <code>Department</code> 的關係由於是紀錄
在 <code>User.department</code> 屬性，所以 <code>User</code> 是兩個Entity關係的 <strong>持有者(owner)</strong> ，在
sql中 <strong>外鍵</strong> 也是紀錄在 <code>User</code> 對應的Table中， <strong>ManyToOne</strong> 為最常見的應用</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">OneToMany(一對多)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class Department extends AbstractEntity implements FeatureWithNo {

    @OneToMany(mappedBy = "department") <i class="conum" data-value="1"></i><b>(1)</b>
    private List&lt;User&gt; users;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><strong>OneToMany</strong> 通常要先有 <strong>ManyToOne</strong> 的設定，以範例來說，因為已經先在 <code>User</code> 設定
<code>department</code> 的關聯，若 <code>Department</code> 也想設定到底哪些 <code>User</code> 與他關聯，則使用
<strong>OneToMany</strong> ，因為 <code>User</code> 已經設定了兩者的關係，所以只要告訴JPA請參考 <code>User</code> 的
<code>department</code> 屬性(<code>Department.users</code> 已經知道型態是 <code>User</code>，所以 <code>mappedBy</code> 只
要告知屬性名稱即可)，通常這種應用也稱為雙向關聯，如果某一方的屬性刪除，則為傳統的單
向關聯</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">OneToMany的Cascade</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class Department extends AbstractEntity implements FeatureWithNo {

    @OneToMany(mappedBy = "department", cascade = CascadeType.ALL, orphanRemoval = true) <i class="conum" data-value="1"></i><b>(1)</b>
    private List&lt;User&gt; users;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>以範例來說，如果系統的CRUD是以 <code>Department</code> 為主，包含 <code>User</code> ， <code>Department</code> 刪
除則相關 <code>User</code> 也要一併刪除者，可如此設定， <code>CascadeType.ALL</code> 表示不管
<code>Department</code> 的新增修改刪除都要順便處理 <code>users</code>， <code>orphanRemoval</code> 則表示失去關聯
的 <code>User</code> 要一併移除</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<strong>OneToMany</strong> 盡量避免設定 <code>fetch=EAGER</code>，因為這會導致不管怎麼的查詢都會
           join此欄位，如果Entity有多個屬性都是 <strong>OneToMany</strong> 且設定 <code>EAGER</code> ，可能導
           致查詢結果會重複，並且影響查詢效能
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">ManyToMany(多對多)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class Bulletin extends AppForm implements FileAttachable&lt;FileAttach&gt; {

    @ManyToMany(cascade = CascadeType.ALL) <i class="conum" data-value="1"></i><b>(1)</b>
    @JoinTable(
            name = "tist_bulletin_attach",
            joinColumns = {@JoinColumn(
                name = "bulletin_id_",
                foreignKey = @ForeignKey(name = "fk_bulletin_attach_bulletin")
            )},
            inverseJoinColumns = {@JoinColumn(
                name = "attach_id_",
                foreignKey = @ForeignKey(name = "fk_bulletin_attach_attach")
            )},
            uniqueConstraints = @UniqueConstraint(
                    name="uk_bulletin_attach_ba",
                    columnNames = {"bulletin_id_", "attach_id_"}))
    private List&lt;FileAttach&gt; attachs;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>FileAttach</code> 為系統統一紀錄檔案資訊的Entity，所以不可能每開一個新的Entity就將新的
關聯設定到 <code>FileAttach</code> ，這樣違反開放封閉法則，也就是此為設計上只能為單向關聯，且
關聯必須建立在 <code>FileAttach</code> 的對應的Entity上，加上為了多筆，所以必須使用
<strong>ManyToMany</strong> ，且代價是另外開一個Table紀錄彼此的關係</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">雙向關聯且對象都是同一個型態</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class SysConfig extends AbstractEntity implements FeatureWithNo {

    @ManyToOne <i class="conum" data-value="1"></i><b>(1)</b>
    @JoinColumn(
        name = "parent_id_",
        foreignKey = @ForeignKey(name = "fk_sys_config_parent")
    )
    private SysConfig parent;

    @OneToMany(mappedBy = "parent")
    private List&lt;SysConfig&gt; children;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>系統參數設定有階層關係(樹狀結構)，可以直接設計上一層關係來紀錄(一般樹狀結構的紀錄方
式為紀錄上一層的節點)</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
可搭配 <code>@OrderBy</code> 進行排序
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">複合式主鍵 @IdClass 搭配 @ManyToOne</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Entity
@Table(name = "SYS_SUBSIDY")
@IdClass(SysSubsidyPK.class)
@Data
public class SysSubsidy implements Serializable {

    @Id
    @ManyToOne
    @JoinColumn(name = "SOC_TYPE")
    private SysSoc socType;

    @Id
    @Column(name = "APP_NO")
    private String appNo;
}

@Entity
@Table(name = "SYS_SOC")
@Data
public class SysSoc implements Serializable {

    @Id
    @Size(max = 4)
    @Basic(optional = false)
    @Column(name = "SOC_TYPE")
    private String socType;
}

@Data
public class SysSubsidyPK implements Serializable {
    private String socType; <i class="conum" data-value="1"></i><b>(1)</b>
    private String appNo;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>只需要SysSoc的Id欄位</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_繼承">4.3.5. 繼承</h4>
<div class="paragraph">
<p>物件導向的觀念中組裝優於繼承，所以除非不得已，應該盡量以關聯的方式為主，而不是使用繼承</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@MappedSuperclass</code>，通常用於基礎類別，繼承此類別的Entity對應的Table都會建立基礎類
別的欄位，也就是雖然不同的Entity因為繼承同一基礎類別，但是資料是獨立紀錄的</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">MappedSuperclass</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@MappedSuperclass <i class="conum" data-value="1"></i><b>(1)</b>
public class AbstractEntity implements Serializable {

    @Column(name = "create_user_id_", length = 32) <i class="conum" data-value="2"></i><b>(2)</b>
    private String createUserId;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>此基礎類別不是Entity不能設定 <code>@Entity</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>每個繼承 <code>AbstractEntity</code> 的Entity對應的Table都會建立 <code>create_user_id_</code> 欄位</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@Inheritance(strategy = InheritanceType.JOINED)</code>，當需要讓某個Entity可以被擴充
屬性，但是基本欄位的資料都是紀錄在同一個Table，擴充的欄位才是紀錄對應的Table</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Inheritance</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Entity
@Table(name = "tist_user")
@Inheritance(strategy = InheritanceType.JOINED)
public class User extends AbstractEntity implements Feature {

}

@Entity
@Table(name = "tist_cwis_user")
@PrimaryKeyJoinColumn(
    name = "id_",
    foreignKey = @ForeignKey(name = "fk_tist_cwis_user_pkjc")
)
public class CwisUser extends User{

}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Java Runtime雖然允許轉型，但是資料庫卻沒辦法，如果資類別有多種型態，且相同
           的紀錄可能存在於不同的子類，則只能用 <code>MappedSuperclass</code> 不能用 <code>Inheritance</code>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_jpa不支援的部份">4.3.6. JPA不支援的部份</h4>
<div class="paragraph">
<p>雖然Spring Boot支援多種JPA Provider，但是mgov-core只用Hibernate，所以使用Hibernate
特有API處理JPA尚未支援的部份，例如：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JPA不支援 <code>select * from (select xx from yy) a</code> 語法，可使用Hibernate的
<code>@Subselect</code> 達成</p>
</li>
<li>
<p>整合現有系統資料庫，關聯的欄位可能沒設定外鍵導致資料可能存在dirty data，可使用
<code>@NotFound</code> 忽略</p>
<div class="listingblock">
<div class="title">NotFound範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@NotFound(action = NotFoundAction.IGNORE)
@ManyToOne(optional = true)
@JoinColumn(
        name = "nation",
        foreignKey = @ForeignKey(name = "fk_some_foreign_key_name")
)
private SysCd nation;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_jpadoclet">4.3.7. JPADoclet</h4>
<div class="paragraph">
<p>利用java Doclet技術將Entity中的javadoc資訊轉換成資料庫設計文件，pom.xml中加上以下內容
，再執行maven指令 <code>javadoc:javadoc</code> 即可在 <code>target/site/apidocs/com.tist.domains</code>
產生資料庫設計文件</p>
</div>
<div class="listingblock">
<div class="title">JPADoclet設定範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.tist&lt;/groupId&gt;
        &lt;artifactId&gt;mgov-core-kit&lt;/artifactId&gt; <i class="conum" data-value="1"></i><b>(1)</b>
    &lt;/dependency&gt;
&lt;/dependencies&gt;
&lt;build&gt;
    &lt;plugins&gt;
        &lt;plugin&gt;
            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
            &lt;artifactId&gt;maven-javadoc-plugin&lt;/artifactId&gt;
            &lt;configuration&gt;
                &lt;show&gt;private&lt;/show&gt; <i class="conum" data-value="2"></i><b>(2)</b>
                &lt;includeDependencySources&gt;true&lt;/includeDependencySources&gt; <i class="conum" data-value="3"></i><b>(3)</b>
                &lt;dependencySourceIncludes&gt;
                    &lt;dependencySourceInclude&gt;com.tist:*&lt;/dependencySourceInclude&gt; <i class="conum" data-value="4"></i><b>(4)</b>
                &lt;/dependencySourceIncludes&gt;
                &lt;doclet&gt;com.tist.doclet.JpaEntityToSchema&lt;/doclet&gt; <i class="conum" data-value="5"></i><b>(5)</b>
                &lt;docletArtifacts&gt;
                    &lt;docletArtifact&gt; <i class="conum" data-value="6"></i><b>(6)</b>
                        &lt;groupId&gt;com.tist&lt;/groupId&gt;
                        &lt;artifactId&gt;jpa-doclet&lt;/artifactId&gt;
                        &lt;version&gt;1.3-SNAPSHOT&lt;/version&gt;
                    &lt;/docletArtifact&gt;
                &lt;/docletArtifacts&gt;
                &lt;useStandardDocletOptions&gt;false&lt;/useStandardDocletOptions&gt; <i class="conum" data-value="7"></i><b>(7)</b>
                &lt;additionalJOption&gt;-J-Dschema-template=${project.basedir}/schema-template.docx&lt;/additionalJOption&gt; <i class="conum" data-value="8"></i><b>(8)</b>
            &lt;/configuration&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;
&lt;/build&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>需要產生文件的相依套件必須明確設定在 <code>dependencies</code> 中，否則無法正常下載sources檔
，如果需要 <code>AbstractEntity</code> 的欄位說明，則需要引用 <code>mgov-core-kit</code> 套件</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>輸出修飾字 <code>private</code> 等級以上的javadoc，<code>private</code> 是最低，所以是全部輸出的意思</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>包含相依套件的原始碼</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>使用 <code>groupId</code> 為 <code>com.tist</code> ， <code>artifactId</code> 為任意值的套件的原始碼</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>使用的Doclet類別全名</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Doclet對應的套件資訊</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>不使用標準設定，此項必須設定為 <code>false</code> 否則將會異常</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>自訂資料庫設計文件樣板，如無需要可移除</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
錯誤或者遺漏javadoc可能導致文件無法正常產出！
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_erd">4.3.8. ERD</h4>
<div class="imageblock">
<div class="content">
<img src="images/idea-persistence.png" alt="Persistence" width="500">
</div>
<div class="title">Figure 2. 使用IDEA產生ERD</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/dbeaver01.png" alt="dbeaver01" width="500">
</div>
<div class="title">Figure 3. DBeaver檢視單一資料表產生ERD</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/dbeaver02.png" alt="dbeaver02" width="500">
</div>
<div class="title">Figure 4. DBeaver從ER Diagrams建立ERD</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_repository">4.4. Repository</h3>
<div class="sect3">
<h4 id="_基本用法">4.4.1. 基本用法</h4>
<div class="paragraph">
<p>一個Entity原則上對應一個Repository</p>
</div>
<div class="listingblock">
<div class="title">Repository範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public interface SysConfigRepository extends BaseRepository&lt;SysConfig, String&gt; { <i class="conum" data-value="1"></i><b>(1)</b>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>只要定義介面即可，Spring Data會自行將此介面與BaseRepository的基底類別進行編織成Spring Bean</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_baserepository簡介">4.4.2. BaseRepository簡介</h4>
<div class="paragraph">
<p>詳情請參閱javadoc API文件，特色如下：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>凡參數可設定propertyName者，除了屬性名稱以外，還可以在前面加上邏輯判斷運算子，語法為
<code>運算子-propertyName</code>，支援的運算子請查詢API文件的 <code>com.tist.jpa.criteria.predicate</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">property查詢範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class User {

    @Column(name="name_")
    private String name;

    @Column(name="birthday_")
    private LocalDate birthday;
}

List&lt;User&gt; users = userRepository.findAll("before-birthday",someday); <i class="conum" data-value="1"></i><b>(1)</b>

Map&lt;String,Object&gt; conditions = new HashMap&lt;&gt;();
conditions.put("like-name","王"); <i class="conum" data-value="2"></i><b>(2)</b>
conditions.put("before-birthday",someday);
List&lt;User&gt; users = userRepository.findAll(conditions); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>查詢生日早於指定日期的紀錄</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>查詢名稱有『王』這個字</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>複合式查詢</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>特殊Specification查詢，Spring Data 提供的Specification原本目的只在於設定查詢條件，但是
BaseRepository提供的findXXXTuple系列，允許實做Specification時，自訂查詢欄位</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">DetailedSpecification範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class CountGoodsInSpecification
        implements DetailedSpecification&lt;GoodsDonate&gt; {

    private MonthRange condition;

    private Join&lt;GoodsDonate, GoodsWarehouse&gt; warehouseJoin;
    private Join&lt;GoodsWarehouse, CountryCode&gt; townJoin;
    private Join&lt;GoodsDonate, SysConfig&gt; classJoin;
    private Join&lt;GoodsDonate, SysConfig&gt; donatorTypeJoin;
    private Join&lt;GoodsDonate, GoodsPerson&gt; personJoin;

    public CountGoodsInSpecification(MonthRange condition) {
        this.condition = condition;
    }

    @Override
    public void buildJoin(Root&lt;GoodsDonate&gt; root) { <i class="conum" data-value="1"></i><b>(1)</b>
        warehouseJoin = root.join("goodsWarehouse", JoinType.INNER);
        townJoin = warehouseJoin.join("town", JoinType.LEFT);
        classJoin = root.join("donateClass", JoinType.INNER);
        donatorTypeJoin = root.join("donatorType", JoinType.INNER);
        personJoin = root.join("goodsPerson", JoinType.INNER);
    }

    @Override
    public void buildSelect(
            Root&lt;GoodsDonate&gt; root,
            CriteriaQuery&lt;?&gt; query,
            CriteriaBuilder builder
    ) {
        <i class="conum" data-value="2"></i><b>(2)</b>
        query.multiselect(
                townJoin.get("name"),
                classJoin.get("no"),
                donatorTypeJoin.get("no"),
                builder.countDistinct(personJoin.get("id")),
                builder.count(root.get("id"))
        );

        <i class="conum" data-value="3"></i><b>(3)</b>
        query.groupBy(
                townJoin.get("name"),
                classJoin.get("no"),
                donatorTypeJoin.get("no")
        );
    }

    @Override
    public Predicate toPredicate(
            Root&lt;GoodsDonate&gt; root,
            CriteriaQuery&lt;?&gt; query,
            CriteriaBuilder builder
    ) {
        buildJoin(root);
        buildSelect(root, query, builder);

        List&lt;Predicate&gt; predicates = new ArrayList&lt;&gt;();
        predicates.add(builder.isTrue(root.get("inOrNot")));
        ....
        ....
        .... <i class="conum" data-value="4"></i><b>(4)</b>

        return builder.and(predicates.toArray(new Predicate[]{}));
    }
}

<i class="conum" data-value="5"></i><b>(5)</b>
GeneralSummaryCondition condition = new GeneralSummaryCondition();
CountGoodsInSpecification spec = new CountGoodsInSpecification(condition);
List&lt;Tuple&gt; tuples = repository.findAllTuple(spec);
for (Tuple tuple : tuples) {
    System.err.println(tuple.get(0, String.class));
    System.err.println(tuple.get(1, String.class));
    System.err.println(tuple.get(2, String.class));
    System.err.println(tuple.get(3, Long.class));
    System.err.println(tuple.get(4, Long.class));
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>處理join，效果等同sql join</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>指定要查詢的欄位</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>設定group by</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>可以做非常複雜的條件判斷</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>測試程式碼，將查詢結果輸出到stderr</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>可擴充BaseRepository</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">擴充BaseRepository範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@NoRepositoryBean <i class="conum" data-value="1"></i><b>(1)</b>
public interface GenericDepartmentRepository&lt;T extends Department&gt; extends BaseRepository&lt;T, String&gt; { <i class="conum" data-value="2"></i><b>(2)</b>

    @Query("SELECT NEW com.tist.bean.tree.Node(t.id,p.id) "
            + "FROM #{#entityName} t " <i class="conum" data-value="3"></i><b>(3)</b>
            + "LEFT JOIN t.parent p")
    List&lt;Node&gt; findAllNodes();

    List&lt;T&gt; findByParentIdOrderBySortAsc(String id);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>如果繼承的Repository不需要編織成Spring Bean，則需要使用@NoRepositoryBean標注</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Department本身就可以採用繼承的方式擴充，所以利用泛型設計一個公版的DepartmentRepository</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>特殊用法，可透過此語法指定實做時對應的Entity類型，詳情請參閱 <a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query.spel-expressions">Using SpEL Expressions</a></td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_crud語法建構原則">4.4.3. CRUD語法建構原則</h4>
<div class="ulist">
<ul>
<li>
<p>與CRUD相關的處理都放置在 <code>com.tist.repository</code> 或者sub-package</p>
</li>
<li>
<p>最簡單的查詢使用BaseRepository內建功能查詢</p>
</li>
<li>
<p>Query Method參數不要超過3個，超過3個請搭配SpEL使用，參閱
<a href="https://spring.io/blog/2014/07/15/spel-support-in-spring-data-jpa-query-definitions">SpEL support in Spring Data JPA @Query definitions</a></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Query+SpEL範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Query(
    "SELECT t FROM SysCd t " +
        "WHERE t.projCode= :#{#main.projCode} " +
        "AND t.sysCode= :#{#main.sysCode} " +
        "AND t.mainCode = :#{#main.mainCode} " +
        "ORDER BY t.sortCode ASC"
)
List&lt;SysCd&gt; findByMainCode(@Param("main") SysCm main);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query+SpEL範例(搭配常數)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Query("SELECT t FROM ChildcareSubsidyGrant t " +
    "INNER JOIN t.status s " +
    "WHERE t.app = :app " +
    "AND s.no = ?#{T(com.tist.constant.cwis.Z1PaySts).NOT_FUNDED} " +
    "AND (t.month &lt; :#{#app.minGrantDate} " +
    "  OR t.month &gt; :#{#app.maxGrantDate})")
List&lt;ChildcareSubsidyGrant&gt; findOutdateGrants(
    @Param("app") ChildcareSubsidyApp app
);</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
SpEL只支援英數字，如果常數名稱使用中文將無法正常！
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>查詢條件不固定處理方式</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#specifications">Specifications</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#query-by-example">QueryByExample</a></p>
</li>
<li>
<p>QueryContext搭配BaseRepository擴充功能或者單用BaseRepository的擴充功能</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
當無法擴充特定Repository的時候也可以用這些方式進行擴充，例如 <code>UserRepository</code>
           屬於 <code>mgov-core</code> 的核心，不一定每個人都有權修改其原始碼
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_連線多個資料庫">4.5. 連線多個資料庫</h3>
<div class="listingblock">
<div class="title">Java 設定範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Configuration
@EnableTransactionManagement
@EnableJpaRepositories(
        repositoryBaseClass = BaseRepositoryImpl.class,  <i class="conum" data-value="1"></i><b>(1)</b>
        entityManagerFactoryRef = "elandSsoEntityManagerFactory",
        transactionManagerRef = "elandSsoTransactionManager",
        basePackages = "com.tist.eland.sso.repository") <i class="conum" data-value="2"></i><b>(2)</b>
public class ElandSsoDbConfig {

    @Value("${eland.sso.jpa.show-sql:false}") <i class="conum" data-value="3"></i><b>(3)</b>
    private boolean showSql;

    @Value("${eland.sso.jpa.generate-ddl:false}") <i class="conum" data-value="4"></i><b>(4)</b>
    private boolean generateDdl;

    @Value("${eland.sso.jpa.database-platform:}") <i class="conum" data-value="5"></i><b>(5)</b>
    private String databasePlatform;

    @Bean
    @ConfigurationProperties("eland.sso.datasource") <i class="conum" data-value="6"></i><b>(6)</b>
    public DataSourceProperties ssoDataSourceProperties() {
        return new DataSourceProperties();
    }

    @Bean
    public DataSource elandSsoDataSource() {
        return ssoDataSourceProperties()
            .initializeDataSourceBuilder().type(HikariDataSource.class).build();
    }

    @Bean(name = "elandSsoJdbcTemplate") <i class="conum" data-value="7"></i><b>(7)</b>
    public JdbcTemplate elandSsoJdbcTemplate(
            @Qualifier("elandSsoDataSource") DataSource elandSsoDataSource) {
        return new JdbcTemplate(elandSsoDataSource);
    }

    @Bean(name = "elandSsoEntityManagerFactory")
    public LocalContainerEntityManagerFactoryBean barEntityManagerFactory(
            EntityManagerFactoryBuilder builder,
            @Qualifier("elandSsoDataSource") DataSource elandSsoDataSource) {
        HibernateJpaVendorAdapter vendorAdapter = new HibernateJpaVendorAdapter();
        vendorAdapter.setShowSql(showSql);
        vendorAdapter.setGenerateDdl(generateDdl);
        if (!StringUtils.isEmpty(databasePlatform)) {
            vendorAdapter.setDatabasePlatform(databasePlatform);
        }

        LocalContainerEntityManagerFactoryBean factory = builder
                .dataSource(elandSsoDataSource)
                .packages("com.tist.eland.sso.domain") <i class="conum" data-value="8"></i><b>(8)</b>
                .persistenceUnit("eland-sso")
                .build();
        factory.setJpaVendorAdapter(vendorAdapter);
        return factory;
    }

    @Bean(name = "elandSsoTransactionManager")
    public PlatformTransactionManager elandSsoTransactionManager( <i class="conum" data-value="9"></i><b>(9)</b>
            @Qualifier("elandSsoEntityManagerFactory")
            EntityManagerFactory elandSsoEntityManagerFactory
    ) {
        return new JpaTransactionManager(elandSsoEntityManagerFactory);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Repository拿來編織的基底類別</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Repository存放的package名稱，避免與主資料庫使用相同的package</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>注入show-sql設定，原則上prefix與其他相關設定應該一致</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>注入generate-ddl設定，原則上prefix與其他相關設定應該一致</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>注入database-platform設定，原則上prefix與其他相關設定應該一致</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>設定datasource 屬性要使用的prefix，系統會自動到application.yml撈取對應的設定</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>建立對應的JdbcTemplate，如確定不需要，可移除</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Entity存放的package名稱，避免與主資料庫使用相同的package</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>設定transaction</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">application.yml 設定範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">eland:
  sso:
    datasource:
      type: com.zaxxer.hikari.HikariDataSource
      url: jdbc:sqlserver://192.168.140.129:1433;databaseName=person
      username: tist
      password: tist24231451_001
      driver-class-name: com.microsoft.sqlserver.jdbc.SQLServerDriver
      maximum-pool-size: 5
      max-lifetime: 570000
    jpa:
      generate-ddl: false
      show-sql: false
      database-platform: com.tist.jpa.dialect.MsSqlServerDialect</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_如何客製化或擴充資料庫方言">4.6. 如何客製化或擴充資料庫方言</h3>
<div class="paragraph">
<p>提供core裡面對於oracle10、11跟postgres的作法，若各專案有特殊需求可繼承對應的類別進行操作</p>
</div>
<div class="sect3">
<h4 id="_oracle">4.6.1. Oracle</h4>
<div class="listingblock">
<div class="title">Oracle10</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class OracleDialect extends Oracle10gDialect {

    private static final int NVARCHAR_MAX_LENGTH = 2000;

    public OracleDialect() {
        super();
        registerColumnType(Types.VARCHAR, NVARCHAR_MAX_LENGTH, "nvarchar2($l)");
        registerColumnType(Types.VARCHAR, "nclob");
        registerColumnType(Types.CLOB, "nclob");
        registerColumnType(Types.NVARCHAR, "nvarchar2($l)");
        registerColumnType(Types.LONGNVARCHAR, "nvarchar2($l)");
    }

    // 複寫掉由hibernate提供的Oracle10gDialect所註冊的方法
    @Override
    protected void registerFunctions() {
        //保留Oracle10gDialect所註冊的方法
        super.registerFunctions();
        // 建立一個protected的方法以供子類別擴充
        versionFunctions();
    }

    // 依照需求加入該本版本特有之方言
    protected void versionFunctions() {
        this.registerFunction(
                "listagg",
                new SQLFunctionTemplate(
                        StandardBasicTypes.STRING,
                        "substr(wm_concat(',' || to_char(?1)), 2)"
                )
        );
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>由於oracle10跟11所用之dialect皆為10g，所以在針對兩種版本不同的做法就藉由override的方式來處理</p>
</div>
<div class="listingblock">
<div class="title">Oracle11</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class Oracle11Dialect extends OracleDialect {
    // 加入該本版本特有之方言
    @Override
    protected void versionFunctions() {
        // 此方法等同於上一張圖裡面wm_concat的用法，只是在11改用listagg
        this.registerFunction(
                "listagg",
                new SQLFunctionTemplate(
                        StandardBasicTypes.STRING,
                        "listagg(to_char(?1),',') within group(order by ?1)"
                )
        );
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Postgres</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class PostgreSqlDialect extends PostgreSQL95Dialect {

    public PostgreSqlDialect() {
        this.registerFunction();
    }

    // 註冊方言(使用protected增加擴充性)
    protected void registerFunction() {
        registerFunction(
                "listagg",
                new SQLFunctionTemplate(
                        StandardBasicTypes.STRING,
                        "array_agg(?1)"
                ));
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_專案引用方法">4.6.2. 專案引用方法</h4>
<div class="paragraph">
<p>在專案的yml中設定由core提供或自己擴充的方言，以oracle10為例階層關係如下</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">spring:
  jpa:
    database-platform: com.tist.jpa.dialect.OracleDialect
    properties:
      hibernate:
        temp:
          use_jdbc_metadata_defaults: true <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>預設為true, 此為部分JPA設定會直接使用資料庫設定, 但MsSql部分有瑕疵, 若資料庫使用MsSql請將之設為false</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_具體使用">4.6.3. 具體使用</h4>
<div class="paragraph">
<p>以postgres為例，使用上述客製化的方法(listagg)在specification使用</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">private Join&lt;Bulletin, SysConfig&gt; typeJoin;

@Override
public void buildJoin(Root&lt;Bulletin&gt; root) {
    typeJoin = root.join("bulletinTypeList", JoinType.INNER);
}

@Override
public void buildSelect(Root&lt;Bulletin&gt; root, CriteriaQuery&lt;?&gt; query, CriteriaBuilder builder) {
    query.multiselect(
        root.get("title"),
        builder.function("listagg", String.class, typeJoin.get("name"))
    ).groupBy(root.get("title"));
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jpa_metamodel">4.7. JPA Metamodel</h3>
<div class="paragraph">
<p>請參閱 <a href="https://docs.jboss.org/hibernate/orm/current/topical/html_single/metamodelgen/MetamodelGenerator.html">JPA Static Metamodel Generator</a></p>
</div>
<div class="paragraph">
<p>主要用來使用型別安全的方式操作JPA Criteria API，可透過工具根據Entity產生對應的Metamodel類
別，名稱通常是 Entity名稱 + <code>_</code>，例如 <code>User</code> 之於 <code>User_</code>，如果搭配Maven plugin，可在
<code>target/generated-sources/apt</code> 路徑下自動產生 Metamodel類別，IDEA會自動整合，編譯封裝會
自動整合進去</p>
</div>
<div class="listingblock">
<div class="title">Usage with Maven</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;properties&gt;
    &lt;hibernate-jpamodelgen.version&gt;5.4.2.Final&lt;/hibernate-jpamodelgen.version&gt;
&lt;/properties&gt;

&lt;build&gt;
    &lt;plugins&gt;
        &lt;plugin&gt;
            &lt;groupId&gt;org.bsc.maven&lt;/groupId&gt;
            &lt;artifactId&gt;maven-processor-plugin&lt;/artifactId&gt;
            &lt;executions&gt;
                &lt;execution&gt;
                    &lt;id&gt;process&lt;/id&gt;
                    &lt;goals&gt;
                        &lt;goal&gt;process&lt;/goal&gt;
                    &lt;/goals&gt;
                    &lt;phase&gt;generate-sources&lt;/phase&gt;
                    &lt;configuration&gt;
                        &lt;processors&gt;
                            &lt;processor&gt;org.hibernate.jpamodelgen.JPAMetaModelEntityProcessor&lt;/processor&gt;
                        &lt;/processors&gt;
                        &lt;options&gt;
                            &lt;addSuppressWarningsAnnotation&gt;true&lt;/addSuppressWarningsAnnotation&gt;
                        &lt;/options&gt;
                    &lt;/configuration&gt;
                &lt;/execution&gt;
            &lt;/executions&gt;
            &lt;dependencies&gt;
                &lt;dependency&gt;
                    &lt;groupId&gt;org.hibernate&lt;/groupId&gt;
                    &lt;artifactId&gt;hibernate-jpamodelgen&lt;/artifactId&gt;
                    &lt;version&gt;${hibernate-jpamodelgen.version}&lt;/version&gt;
                &lt;/dependency&gt;
            &lt;/dependencies&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;
&lt;/build&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_整合複雜的原生sql">4.8. 整合複雜的原生SQL</h3>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
JPA 2.1 起支援原生SQL比較完整，但是使用過多的原生SQL可能導致SQL可攜性下降，建議不
         得已的時候才使用
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_namednativequery">4.8.1. @NamedNativeQuery</h4>
<div class="listingblock">
<div class="title">Entity範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Entity
@NamedNativeQuery(
    name = "Natb001m.findByPersonIds", <i class="conum" data-value="1"></i><b>(1)</b>
    query = "SELECT DISTINCT PERSON_ID, PERSON_NAME, BIRTH_ORDER_SEX, " +  <i class="conum" data-value="2"></i><b>(2)</b>
            "BIRTH_YYYMMDD, HOUSEHOLD_HEAD_ID, HOUSEHOLD_ID, HOUSEHOLD_NAME, TOWN, " +
            "VILLAGE, NEIGHBOR, NEIGHBOR_CHAR, STREET_DOORPLATE, FATHER, MOTHER, " +
            "LIVING_STYLE_CODE, RELATIONSHIP " +
            "FROM ( " +

            "SELECT PERSON_ID, N''||PERSON_NAME PERSON_NAME, BIRTH_ORDER_SEX, " +
            "BIRTH_YYYMMDD, HOUSEHOLD_HEAD_ID, HOUSEHOLD_ID, " +
            "N''||HOUSEHOLD_NAME HOUSEHOLD_NAME, " +
            "(SELECT MAX(TOWNNOTE1) FROM SYS_CITY WHERE TOWNNO=AREA_CODE||'00') TOWN, " +
            "N''||VILLAGE VILLAGE, NEIGHBOR, N''||NEIGHBOR_CHAR NEIGHBOR_CHAR, " +
            "N''||STREET_DOORPLATE STREET_DOORPLATE, N''||FATHER FATHER, " +
            "N''||MOTHER MOTHER, LIVING_STYLE_CODE, N''||RELATIONSHIP RELATIONSHIP " +
            "FROM NATB001M A " +
            "WHERE A.PERSON_ID IN (:personIds) " + <i class="conum" data-value="3"></i><b>(3)</b>

            "UNION ALL " +

            "SELECT PERSON_ID, PERSON_NAME, BIRTH_ORDER_SEX, BIRTH_YYYMMDD, " +
            "HOUSEHOLD_HEAD_ID, HOUSEHOLD_ID, HOUSEHOLD_NAME, " +
            "(SELECT MAX(TOWNNOTE1) FROM SYS_CITY WHERE TOWNNO=AREA_CODE||'00') TOWN, " +
            "VILLAGE, NEIGHBOR, NEIGHBOR_CHAR, STREET_DOORPLATE, FATHER, MOTHER, " +
            "LIVING_STYLE_CODE, RELATIONSHIP " +
            "FROM NATB001A B " +
            "WHERE B.PERSON_ID IN (:personIds) " +

            ") C",
    resultSetMapping = "Natb001CoreResultSetMapping" <i class="conum" data-value="4"></i><b>(4)</b>
)
@SqlResultSetMapping(
    name = "Natb001CoreResultSetMapping", <i class="conum" data-value="5"></i><b>(5)</b>
    classes = @ConstructorResult(
        targetClass = Natb001Core.class, <i class="conum" data-value="6"></i><b>(6)</b>
        columns = {
            @ColumnResult(name = "PERSON_ID"), <i class="conum" data-value="7"></i><b>(7)</b>
            @ColumnResult(name = "PERSON_NAME"),
            @ColumnResult(name = "BIRTH_ORDER_SEX"),
            @ColumnResult(name = "BIRTH_YYYMMDD"),
            @ColumnResult(name = "HOUSEHOLD_HEAD_ID"),
            @ColumnResult(name = "HOUSEHOLD_ID"),
            @ColumnResult(name = "HOUSEHOLD_NAME"),
            @ColumnResult(name = "TOWN"),
            @ColumnResult(name = "VILLAGE"),
            @ColumnResult(name = "NEIGHBOR"),
            @ColumnResult(name = "NEIGHBOR_CHAR"),
            @ColumnResult(name = "STREET_DOORPLATE"),
            @ColumnResult(name = "FATHER"),
            @ColumnResult(name = "MOTHER"),
            @ColumnResult(name = "LIVING_STYLE_CODE"),
            @ColumnResult(name = "RELATIONSHIP")
        }
    )
)
@Table(name = "NATB001M")
@Data
public class Natb001m implements Serializable {

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>此名稱後續可被Spring Data的Repository使用</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>複雜的原生SQL</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>查詢條件，需要與Spring Data Repository Method的參數名稱一致</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>查詢結果要轉換成Java Bean的設定，需要有對應的 <code>@SqlResultSetMapping</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>需要有對應的 <code>resultSetMapping</code></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>要轉換的Java Bean型態，此處使用的是建構子方式</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>建構子參數對應的查詢結果欄位(原生SQL Select的欄位名稱)</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Java Bean範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Data
public class Natb001Core{
    private String personId;
    private String personName;
    private String birthOrderSex;
    private String birthYyymmdd;
    private String householdHeadId;
    private String householdId;
    private String householdName;
    private String town;
    private String village;
    private String neighbor;
    private String neighborChar;
    private String streetDoorplate;
    private String father;
    private String mother;
    private String livingStyleCode;
    private String relationship;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Repository範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public interface Natb001mRepository extends BaseRepository&lt;Natb001m, String&gt; {

    @Query(name = "Natb001m.findByPersonIds", nativeQuery = true) <i class="conum" data-value="1"></i><b>(1)</b>
    Set&lt;Natb001Core&gt; findByPersonIds(
        @Param("personIds") Collection&lt;String&gt; personIds <i class="conum" data-value="2"></i><b>(2)</b>
    );
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>nativeQuery必須設定為true，如果不想設定name則method名稱必須避免使用 <strong>find</strong> 、
<strong>count</strong> 、 <strong>query</strong>、 <strong>get</strong> 等字眼開頭的名稱，否則會進入Spring Data Query Method
的解析，造成錯誤</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>需要指定參數名稱</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_service">5. Service</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_service_簡介">5.1. Service 簡介</h3>
<div class="paragraph">
<p>系統主要商業邏輯實做區域，一律先建立interface再實做class，理由是方便Spring AOP加工，interface
統一放在 <code>com.tist.service</code>，實做類別統一放在 <code>com.tist.service.impl</code></p>
</div>
<div class="paragraph">
<p>如果是CRUD的Service，interface建議繼承 <code>AbstractEntityService</code>，而class繼承
<code>AbstractEntityServiceImpl</code></p>
</div>
<div class="listingblock">
<div class="title">Service Interface範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public interface RoleService extends AbstractEntityService&lt;Role, RoleRepository&gt; {

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Service Class範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Transactional <i class="conum" data-value="1"></i><b>(1)</b>
@Service("com.tist.service.impl.RoleServiceImpl") <i class="conum" data-value="2"></i><b>(2)</b>
public class RoleServiceImpl extends AbstractEntityServiceImpl&lt;Role, RoleRepository&gt;
        implements RoleService {

    private static final String[] EXCLUDE_PROPERTIES = new String[]{
            "id",
            "createUserId",
            "createTime"
    }; <i class="conum" data-value="3"></i><b>(3)</b>

    @Override
    public Role fetchAndUpdateBy(Role source) { <i class="conum" data-value="4"></i><b>(4)</b>
        if (null == source) { <i class="conum" data-value="5"></i><b>(5)</b>
            return null;
        }

        if (StringUtils.isEmpty(source.getId())) { <i class="conum" data-value="6"></i><b>(6)</b>
            source.setId(null);
            return source;
        }
        Role target = null;
        Optional&lt;Role&gt; optionalTarget = getBaseRepository().findById(source.getId()); <i class="conum" data-value="7"></i><b>(7)</b>
        if (optionalTarget.isPresent()) {
            target = optionalTarget.get();
            BeanUtils.copyProperties(source, target, EXCLUDE_PROPERTIES); <i class="conum" data-value="8"></i><b>(8)</b>
        }
        return target;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>啟動sql transaction機制</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Spring Bean Id統一使用類別的完整名稱</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>修改時同步request與資料庫資料時要忽略的欄位，一般來講至少要忽略主鍵、建立人員、建立時間，此三個
欄位是系統新增時自動產生，事後都不得變動</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>fetchAndUpdateBy是save(新增)與update(修改)前會呼叫的樣板方法，用來整理可儲存的資料</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>防呆處理</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>主鍵為空值，代表是情境是新增，強制設定主鍵為null讓系統自動產生，避免空字串干擾，執行return結束處理</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>有主鍵則代表情境是修改，使用Repository內建的方法取得對應的Entity實體</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>將Request的Bean複製到Entity實體，除了EXCLUDE_PROPERTIES設定的欄位全部複製</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_非同步執行">5.2. 非同步執行</h3>
<div class="paragraph">
<p>使用情境為需要花費大量時間執行的運算，為了避免影響用戶體驗，需要另開執行序背景處理，例如資料匯入，一般來講應該
避免使用@Transactional，transaction會有執行時間限制，Spring Boot預設時間為60秒</p>
</div>
<div class="listingblock">
<div class="title">非同步執行範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Service("com.tist.service.impl.WelfareRecordAsyncServiceImpl")
@Slf4j
public class WelfareRecordAsyncServiceImpl implements WelfareRecordAsyncService {

    @Async <i class="conum" data-value="1"></i><b>(1)</b>
    @Override
    public Future&lt;String&gt; updateLatestBy(int start, int offset, int size) { <i class="conum" data-value="2"></i><b>(2)</b>

        <i class="conum" data-value="3"></i><b>(3)</b>
        return new AsyncResult&lt;&gt;("complete");
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>使用 org.springframework.scheduling.annotation.Async</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>如果需要知道何時執行完畢可考慮回傳 java.util.concurrent.Future</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>會處理很久的程式碼</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_排程">5.3. 排程</h3>
<div class="listingblock">
<div class="title">排程範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Service("com.tist.service.impl.SyncWelfareRobotServiceImpl")
@Slf4j
public class SyncWelfareRobotServiceImpl implements SyncWelfareRobotService {

    @Scheduled(cron = "0 0 1 * * ?") <i class="conum" data-value="1"></i><b>(1)</b><i class="conum" data-value="2"></i><b>(2)</b>
    @Override
    public void execute() {
        <i class="conum" data-value="3"></i><b>(3)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>使用 org.springframework.scheduling.annotation.Scheduled</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>使用 cron expression設定觸發時間</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>需要排程處理的程式碼</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_controller">6. Controller</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_controller簡介">6.1. Controller簡介</h3>
<div class="paragraph">
<p>mgov-core中的Controller指的是Spring MVC 中的Controller，請參閱
<a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc">Spring Web MVC</a>
Controller原則上只是整合View與Model，mgov-core的View主要是以 <strong>FreeMarker</strong> 為主，而Model主要 是Service，所以，Controller除了Request Mapping以外，不應該寫入過多的商業邏輯，主要的商業邏輯 應該建構在Service層</p>
</div>
<div class="sect3">
<h4 id="_原理">6.1.1. 原理</h4>
<div class="ulist">
<ul>
<li>
<p>Servlet base，Spring MVC 內建一個DispatcherServlet，負責預先處理所有Request在分派給對應的 Controller，再將Controller回傳的內容轉換成Response，Spring Boot將會自動偵測執行環境，如果是 Web Application將自動完成DispatcherServlet的設定</p>
</li>
<li>
<p>Controller屬於Spring Bean，預設也是Singleton，所以應該避免將session相關的物件注入到 Controller的field，例如HttpSession，應該設定到Method的參數上</p>
</li>
<li>
<p>Controller的主要目的就是設定哪個網址要給哪個Method處理，Spring MVC 自帶許多Converter，也可自行 擴充，可以將Request與Response進行型態轉換，所以只要在參數指定希望的型態，只要Converter支援都會自動 轉換並且注入到參數中</p>
</li>
<li>
<p>設定 <code>@ResponseBody</code> 的回傳值，預設將自動轉換成JSON格式</p>
</li>
<li>
<p>沒設定 <code>@ResponseBody</code> 且型態為字串，則視為指定View的檔名(不含根目錄與副檔名)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_url_pattern">6.1.2. Url Pattern</h4>
<div class="paragraph">
<p>Controller網址規則以三層為主，後端業務系統規則 <code>/admin/{小寫ControllerName}/{小寫MethodName}</code>
，而前端則是 <code>/home</code> 開頭</p>
</div>
</div>
<div class="sect3">
<h4 id="_controller_vs_restcontroller">6.1.3. @Controller vs @RestController</h4>
<div class="paragraph">
<p>mgov-core會掃描系統全部的Controller，與Spring Security的權限管理整合，主要分為一下兩種處理</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@Controller</code> 將會被判定為系統選單，故使用此註解的Controller必須具備index Method，否則將因為 缺乏預設網址導致存取被拒，其中有設定 <code>@RequestMapping</code> 、 <code>@GetMapping</code> 、 <code>@PostMapping</code> 且 沒有使用 <code>@ResponseBody</code> 的Method，將是為可授權的網址，提供給系統做權限控管，其餘有使用
<code>@ResponseBody</code> 的Method，只要成功登入即可合法存取。</p>
</li>
<li>
<p><code>@RestController</code> 不會被當作系統選單，所有Method只要登入成功即可合法存取。</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>@RestController</code> 跟 <code>@Controller</code> 唯一的區別是 <code>@RestController</code> 自帶 <code>@ResponseBody</code>
，適合撰寫全部都是REST API時，減少 <code>@ResponseBody</code> 的使用，讓程式碼更簡潔
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">CRUD Controller範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Controller("com.tist.web.admin.CountryCodeController")
@RequestMapping("/admin/country-code") <i class="conum" data-value="1"></i><b>(1)</b>
@SessionAttributes("queryContext") <i class="conum" data-value="2"></i><b>(2)</b>
@Slf4j
public class CountryCodeController {

    private static final String VIEW_INDEX = "/admin/country-code/country-code-index"; <i class="conum" data-value="3"></i><b>(3)</b>
    private static final String VIEW_INPUT = "/admin/country-code/country-code-input"; <i class="conum" data-value="4"></i><b>(4)</b>
    private static final String REDIRECT_INDEX = "redirect:index"; <i class="conum" data-value="5"></i><b>(5)</b>

    @Resource
    @Setter
    private CountryCodeService countryCodeService; <i class="conum" data-value="6"></i><b>(6)</b>

    @RequestMapping(value = {UrlPattern.EMPTY, UrlPattern.INDEX}) <i class="conum" data-value="7"></i><b>(7)</b>
    public String index(
            @ModelAttribute("queryContext") QueryContext queryContext,
            Model model) {
        Page&lt;CountryCode&gt; page = countryCodeService.queryAll(queryContext);
        model.addAttribute("page", page);
        return VIEW_INDEX;
    }

    @GetMapping(UrlPattern.ADD) <i class="conum" data-value="8"></i><b>(8)</b>
    public String add(Model model) {
        return VIEW_INPUT;
    }

    @PostMapping(UrlPattern.SAVE) <i class="conum" data-value="9"></i><b>(9)</b>
    public String save(
            @Valid @ModelAttribute("main") CountryCode main, <i class="conum" data-value="10"></i><b>(10)</b>
            BindingResult result
    ) {
        String viewName = REDIRECT_INDEX;
        if (result.hasErrors()) { <i class="conum" data-value="11"></i><b>(11)</b>
            viewName = VIEW_INPUT;
        } else {
            CountryCode target = countryCodeService.save(main); <i class="conum" data-value="12"></i><b>(12)</b>
        }
        return viewName;
    }

    @GetMapping(UrlPattern.EDIT) <i class="conum" data-value="13"></i><b>(13)</b>
    public String edit(@PathVariable("id") String id, Model model) {
        model.addAttribute(
            "main", countryCodeService.findOne(id) <i class="conum" data-value="14"></i><b>(14)</b>
        );
        return VIEW_INPUT;
    }

    @PostMapping(UrlPattern.UPDATE) <i class="conum" data-value="15"></i><b>(15)</b>
    public String update(
            @Valid @ModelAttribute("main") CountryCode main, <i class="conum" data-value="16"></i><b>(16)</b>
            BindingResult result
    ) {
        String viewName = REDIRECT_INDEX;
        if (result.hasErrors()) {
            viewName = VIEW_INPUT;
        } else {
            countryCodeService.update(main);
        }
        return viewName;
    }

    @GetMapping(UrlPattern.DELETE)
    @ResponseBody
    public boolean delete(@PathVariable("id") String id) {
        CountryCode target = countryCodeService.delete(id);
        return target != null;
    }

    @RequestMapping(UrlPattern.EXPORT) <i class="conum" data-value="17"></i><b>(17)</b>
    @ResponseBody
    public ResponseEntity&lt;org.springframework.core.io.Resource&gt; export(
            @ModelAttribute("queryContext") QueryContext queryContext
    ) {
        return countryCodeService.createExportResponseEntity(queryContext);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>設定Controller主要網址(前兩層)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>效果為紀錄查詢條件，只有在Post或者切換不同Controller查詢條件才會被清除</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>查詢時對應的樣板名稱</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>新增修改時對應的樣板名稱</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>儲存成功後的轉址</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>主要的Crud Service</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>設定主要的查詢網址，由於GET與POST皆可能，所以使用 <code>@RequestMapping</code></td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>切換到新增畫面網址設定</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>處理新增的網址設定</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td><code>@Valid</code> 代表要進行欄位驗證，Bean需要設定Bean Validation支援的Annotation</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>欄位驗證有錯誤，代表欄位驗證沒通過，回到新增畫面，剩下的錯誤訊息交給View處理</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>驗證通過則透過Service進行新增</td>
</tr>
<tr>
<td><i class="conum" data-value="13"></i><b>13</b></td>
<td>切換到編輯畫面的網址設定</td>
</tr>
<tr>
<td><i class="conum" data-value="14"></i><b>14</b></td>
<td>將要編輯的Entity實體設定到Model，傳給View使用</td>
</tr>
<tr>
<td><i class="conum" data-value="15"></i><b>15</b></td>
<td>處理修改的網址設定</td>
</tr>
<tr>
<td><i class="conum" data-value="16"></i><b>16</b></td>
<td>同新增時的欄位驗證</td>
</tr>
<tr>
<td><i class="conum" data-value="17"></i><b>17</b></td>
<td>資料匯出的網址設定</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">RestController範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@RestController("com.tist.web.admin.AttachController")
@RequestMapping("/admin/attach")
@Slf4j
public class AttachController {

    @Resource(name = "fileAttachService")
    private FileAttachService fileAttachService;

    @GetMapping(value = "{id}") <i class="conum" data-value="1"></i><b>(1)</b>
    public ResponseEntity&lt;org.springframework.core.io.Resource&gt; download(
            @PathVariable("id") String id
    ) {
        return fileAttachService.getResponseEntityById(id);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>因為 <code>@RestController</code> 自帶 <code>@ResponseBody</code> 的效果，就不需要再註記 <code>@ResponseBody</code></td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_欄位驗證">6.1.4. 欄位驗證</h4>
<div class="paragraph">
<p>使用 <code>@Valid</code> 是驗證Bean中全部有設定Bean Validation Annotation的欄位，如果只想驗證部 份欄位可以加註Annotation的group參數，然後改用 <code>@Validated</code></p>
</div>
<div class="listingblock">
<div class="title">Validated 範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class User extends AbstractEntity implements Feature {

    @NotEmpty(groups = {Insert.class, Update.class}) <i class="conum" data-value="1"></i><b>(1)</b>
    @Column(name = "name_", nullable = false)
    private String name;

    @NotEmpty(groups = Insert.class) <i class="conum" data-value="2"></i><b>(2)</b>
    @Column(name = "password_")
    private String password;
}

@PostMapping(UrlPattern.SAVE)
public String save(
        @Validated(Insert.class) @ModelAttribute("main") User main, <i class="conum" data-value="3"></i><b>(3)</b>
        BindingResult result
) {
    String viewName = REDIRECT_INDEX;
    if (result.hasErrors()) {
        viewName = VIEW_INPUT;
    } else {
        CountryCode target = userService.save(main);
    }
    return viewName;
}

@PostMapping(UrlPattern.UPDATE)
public String update(
        @Validated(Update.class) @ModelAttribute("main") User main, <i class="conum" data-value="4"></i><b>(4)</b>
        BindingResult result
) {
    String viewName = REDIRECT_INDEX;
    if (result.hasErrors()) {
        viewName = VIEW_INPUT;
    } else {
        userService.update(main);
    }
    return viewName;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>姓名無論新增修改都是必填</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>密碼只有新增時才是必填</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>新增只檢查新增欄位</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>修改只檢查修改欄位</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Controller URL若位於/admin底下請避免使用雙層PathVariable, 會使MGOV判斷權限造成異常
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">錯誤示範</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java"> @GetMapping("demo/{id}/{no}")
    @ResponseBody
    public boolean demo(@PathVariable("id") String id,@PathVariable("no") String no) {

        return false;
    }</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_controller如何提供資料給view">6.2. Controller如何提供資料給View</h3>
<div class="sect3">
<h4 id="_org_springframework_ui_model">6.2.1. org.springframework.ui.Model</h4>
<div class="listingblock">
<div class="title">Model 範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@RequestMapping({ UrlPattern.EMPTY, UrlPattern.INDEX })
public String index(
    @ModelAttribute("queryContext") QueryContext queryContext,
    Model model) {
    Page&lt;User&gt; page = userService.queryAll(queryContext);
    model.addAttribute("page", page); <i class="conum" data-value="1"></i><b>(1)</b>
    return VIEW_INDEX;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>view就可以使用page</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_org_springframework_web_servlet_modelandview">6.2.2. org.springframework.web.servlet.ModelAndView</h4>
<div class="paragraph">
<p>通常是 <strong>Interceptor</strong> 、 <strong>RestController</strong> 、 <strong>ControllerAdvice</strong> 比較常用</p>
</div>
<div class="listingblock">
<div class="title">ModelAndView 範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@ResponseStatus(HttpStatus.BAD_REQUEST)
@ExceptionHandler(Exception.class)
public ModelAndView handleError(HttpServletRequest request, Exception exception) {

    String requestedWith = request.getHeader("X-Requested-With");
    ModelAndView mav = new ModelAndView();
    if (StringUtils.isEmpty(requestedWith)) {
        mav.addObject("exception", exception);
        mav.addObject("url", request.getRequestURL());
        mav.addObject("debug", isDebug());
        mav.setViewName("home/home/error");
    } else {
        Map&lt;String, Object&gt; error = new HashMap&lt;&gt;();
        error.put("error", true);
        if (isDebug()) {
            error.put("exception", exception);
        }
        try {
            mav.addObject("errorJson", JsonUtils.stringify(error));
        } catch (JsonProcessingException e) {
            LOGGER.warn(e.getLocalizedMessage());
        }
        mav.setViewName("home/error-json");
    }
    return mav;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_org_springframework_web_bind_annotation_modelattribute">6.2.3. org.springframework.web.bind.annotation.ModelAttribute</h4>
<div class="paragraph">
<p>Controller預設為singleton，如果getter提供的資料可能因為使用者而改變，則不
能快取</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@ModelAttribute("cripTypes")
public Map&lt;String, String&gt; getCripTypes() {
    return cripTypes;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_org_springframework_web_bind_annotation_controlleradvice">6.2.4. org.springframework.web.bind.annotation.ControllerAdvice</h4>
<div class="paragraph">
<p>ControllerAdvice 可針對符合特定規則多個Controller進行控制，其中包含ModelAttribute</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@ControllerAdvice(basePackages = "com.tist.web.admin") <i class="conum" data-value="1"></i><b>(1)</b>
public class QueryContextAdvice {

    @ModelAttribute("queryContext")
    public QueryContext getQueryContext() {
        return new QueryContext();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>package屬於com.tist.web.admin的Controller</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_querycontext簡介">6.3. QueryContext簡介</h3>
<div class="paragraph">
<p>主要用於查詢畫面，查詢發出的Request包含查詢條件、分頁資訊與欄位排序資訊，故設計此類別統整以上
三種資訊，並且提供基本的轉換方便後續Service操作使用，詳情請參閱API文件</p>
</div>
</div>
<div class="sect2">
<h3 id="_modelattribute應用">6.4. ModelAttribute應用</h3>
<div class="listingblock">
<div class="title">搭配Lombok @Getter減少getter撰寫</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@SysConfigResource(GoodsShareConfig.REPORT_TYPE)
@Getter(onMethod_ = @ModelAttribute("types"))
private Map&lt;String, String&gt; types;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
此功能還處於實驗性質
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">搭配SpEL</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Value("#{@'com.tist.service.impl.GoodsSysConfigServiceImpl'.findDoneeTypeNos()}") <i class="conum" data-value="1"></i><b>(1)</b>
private Map&lt;String, String&gt; doneeTypeNos;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>效果是呼叫GoodsSysConfigServiceImpl.findDoneeTypeNos 並將回傳值設定到doneeTypeNos</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_view">7. View</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_freemarker_2">7.1. FreeMarker</h3>
<div class="paragraph">
<p>mgov-core使用的樣板引擎為 <a href="https://freemarker.apache.org/">FreeMarker</a>，採用的理由如下：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>根據官方文件 <a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#boot-features-jsp-limitations">JSP Limitations</a>
描述，JSP只能在以war檔的形式佈署在J2EE Container上正常執行，沒辦法在嵌入式的Container上執行，使用
JSP可能不利於微服務架構佈署，使用JSP有開發上的風險</p>
</li>
<li>
<p>JSP不利製作email內容，通常email內容也是html格式，JSP不適合製作email內容勢必得尋求其他樣板引擎解決</p>
</li>
<li>
<p>FreeMarker老牌、穩定、效能不差且擴充容易，具備比較便利的XSS防護機制</p>
</li>
<li>
<p>XDocReport依賴FreeMarker</p>
</li>
<li>
<p>Spring官方支援FreeMarker</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_bootstrap">7.2. Bootstrap</h3>
<div class="paragraph">
<p><a href="https://getbootstrap.com/docs/3.3/">Bootstrap</a>為CSS框架，用來解決響應式網頁的需求，目前使用的版本為3.x</p>
</div>
</div>
<div class="sect2">
<h3 id="_jquery">7.3. jQuery</h3>
<div class="paragraph">
<p><a href="http://jquery.com/">jQuery</a>主要目的為簡化跨瀏覽器操作，目前使用版本為3.x</p>
</div>
</div>
<div class="sect2">
<h3 id="_webjars">7.4. WebJars</h3>
<div class="paragraph">
<p><a href="https://www.webjars.org/">WebJars</a>將流行的js或者css套件轉換成jar檔並且佈署在Maven Public Central
上，系統可以直接在pom.xml設定相關的套件資訊，即可直接使用，無須手動下載放到專案目錄中</p>
</div>
</div>
<div class="sect2">
<h3 id="_tist_ftl">7.5. tist.ftl</h3>
<div class="paragraph">
<p>使用FreeMarker macro功能，提供了幾個常用的欄位輸出功能</p>
</div>
<div class="sect3">
<h4 id="_參數說明">7.5.1. 參數說明</h4>
<div class="ulist">
<ul>
<li>
<p>path 屬性路徑</p>
</li>
<li>
<p>attributes 其他html屬性(字串型態)</p>
</li>
<li>
<p>options 由Map組成</p>
</li>
<li>
<p>class 樣式類別</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_功能說明">7.5.2. 功能說明</h4>
<div class="listingblock">
<div class="title">文字欄位</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="ftl">&lt;@tist.text path="main.name" /&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">文字欄位(必填)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="ftl">&lt;@tist.text path="main.name" attributes="required" class="some-style"/&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">多行文字欄位</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="ftl">&lt;@tist.textarea path="main.name" /&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">密碼欄位</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="ftl">&lt;@tist.password path="main.password" /&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">數字欄位</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="ftl">&lt;@tist.number path="main.number" min=1 max=10 attributes="required" class="some-style"/&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">單選下拉選單</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="ftl">&lt;@tist.singleSelect path="main.marry.id" options={"":"請選擇..."}+marrys /&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">checkboxs</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="ftl">&lt;@tist.checkboxs path="main.names" options=names /&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">checkbox</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="ftl">&lt;@tist.checkbox path="main.name" key="some key" value="some value" /&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">radioButtons</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="ftl">&lt;@tist.radioButtons path="main.names" options=names /&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">單檔上傳</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="ftl">&lt;@tist.singleFile path="main.attach" /&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">多檔上傳</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="ftl">&lt;@tist.multiFile path="main.attachs" /&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">日期欄位</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="ftl">&lt;@tist.dateText path="main.birthday" /&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">時間欄位</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="ftl">&lt;@tist.clockPicker path="main.time" /&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">月份欄位</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="ftl">&lt;@tist.monthPicker path="main.month" /&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">地址欄位</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="ftl">&lt;@tist.address
    cityPath="main.city.id"
    townPath="main.town.id"
    villagePath="main.village.id"
    addressPath="main.address" /&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_報表">8. 報表</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_建立excel">8.1. 建立Excel</h3>
<div class="paragraph">
<p>使用 <a href="http://jxls.sourceforge.net/getting_started.html">JXLS</a></p>
</div>
<div class="ulist">
<ul>
<li>
<p>mgov-core已經引用了相關檔案</p>
</li>
<li>
<p>使用excel當樣板，在註解中設定相關的語法</p>
</li>
<li>
<p>樣板檔案請放到resources/jxls</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">一般查詢匯出Excel Controller範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@RequestMapping(UrlPattern.EXPORT)
@ResponseBody
public ResponseEntity&lt;org.springframework.core.io.Resource&gt; export(
        @ModelAttribute("queryContext") QueryContext queryContext
) {
    return countryCodeService.createExportResponseEntity(queryContext);
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">一般查詢匯出Excel Service範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Override
public ResponseEntity&lt;Resource&gt; createExportResponseEntity(QueryContext queryContext) {
    return CrudServiceUtils.createExportExcelResponseEntity(
            queryContext, this, "country-code.xlsx"
    );
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_建立word">8.2. 建立Word</h3>
<div class="paragraph">
<p>使用 <a href="https://github.com/opensagres/xdocreport/wiki">XDocReport</a></p>
</div>
<div class="sect3">
<h4 id="_說明">8.2.1. 說明</h4>
<div class="ulist">
<ul>
<li>
<p>直接使用MS Office或者LibreOffice作設計工具，當客戶已經有現成的電子檔時可減少大量的開發成本，
即使客戶沒有電子檔，使用MS Office設計報表依然比其他報表設計方式節省時間，且保證產出與設計一致</p>
</li>
<li>
<p>使用FreeMarker作為樣板引擎</p>
</li>
<li>
<p>支援 MS Office(docx) 與 OpenOffice(odt) 格式</p>
</li>
<li>
<p>支援轉換成pdf(可能會跑版)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_設計_docx">8.2.2. 設計 docx</h4>
<div class="paragraph">
<p>參考 <a href="https://github.com/opensagres/xdocreport/wiki/DocxReportingJavaMain">DocxReportingJavaMain</a></p>
</div>
<div class="paragraph">
<p><span class="menuseq"><b class="menu">插入</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">快速組件</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">功能變數</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">MergeField</b></span></p>
</div>
</div>
<div class="sect3">
<h4 id="_設計odt">8.2.3. 設計odt</h4>
<div class="paragraph">
<p>參考 <a href="https://github.com/opensagres/xdocreport/wiki/ODTDesignReport">ODT Design Report</a></p>
</div>
<div class="paragraph">
<p><span class="menuseq"><b class="menu">插入</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">欄位</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">更多欄位</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">功能</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">輸入欄位</b></span></p>
</div>
<div class="listingblock">
<div class="title">Controller範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@GetMapping("visit-report/{id}")
@ResponseBody
public ResponseEntity&lt;org.springframework.core.io.Resource&gt; createVisitReport(
        @PathVariable("id") String id
) {
    return service.createVisitReportResponseEntity(id, "app-alone.docx");
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Service範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Override
public ResponseEntity&lt;org.springframework.core.io.Resource&gt; createVisitReportResponseEntity(
        String id, String filename
) {
    AppAlone main = findOne(id);
    if (main != null) {
        try (InputStream odtTemplate = getClass()
                .getResourceAsStream("/templates/report/" + filename); <i class="conum" data-value="1"></i><b>(1)</b>
                ByteArrayOutputStream baos = new ByteArrayOutputStream() <i class="conum" data-value="2"></i><b>(2)</b>
        ) {
            IXDocReport report = XDocReportRegistry
                    .getRegistry()
                    .loadReport(odtTemplate, TemplateEngineKind.Freemarker); <i class="conum" data-value="3"></i><b>(3)</b>
            IContext context = report.createContext();
            context.put("main", main); <i class="conum" data-value="4"></i><b>(4)</b>
            report.process(context, baos); <i class="conum" data-value="5"></i><b>(5)</b>

            MimetypesFileTypeMap fileTypeMap = new MimetypesFileTypeMap();
            String mimeType = fileTypeMap.getContentType(filename);
            return ResponseEntity
                    .ok()
                    .contentType(MediaType.parseMediaType(mimeType))
                    .header(
                            HttpHeaders.CONTENT_DISPOSITION,
                            UrlUtils.getFileDownloadHeader(filename)
                    )
                    .body(new ByteArrayResource(baos.toByteArray())); <i class="conum" data-value="6"></i><b>(6)</b>
        } catch (Exception e) {
            log.error(e.getLocalizedMessage());
        }
    }
    return ResponseEntity.noContent().build();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>載入樣板檔</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>建立ByteArrayOutputStream來接輸出的內容，再轉給ResponseEntity使用</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>XDocReport設定樣板引擎為FreeMarker</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>設定要跟樣板整合的資料</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>輸出報表</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>將報表內容轉成ByteArrayResource塞給ResponseEntity
=== JasperReports</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://community.jaspersoft.com/">Jaspersoft</a> 提供的報表引擎解決方案，目前採用的方案是 使用Jaspersoft Studio設計報表，然後透過JasperReports Library輸出報表，優點如下：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>免授權費用</p>
</li>
<li>
<p>設計一次報表可產出多種格式</p>
</li>
<li>
<p>支援 MS Office、ODF、PDF、Html等格式</p>
</li>
<li>
<p>目前已知的免費ODS解決方案中，效能最佳</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
參考文件 <a href="https://community.jaspersoft.com/documentation">Jaspersoft Community Docs</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_jasperreports_pdf中文字型處理">8.2.4. JasperReports PDF中文字型處理</h4>
<div class="paragraph">
<p><span class="menuseq"><b class="menu">Window</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Preferences</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Jaspersoft Studio</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Fonts</b></span> 將報表使用的字型匯出成jar並且 加入到系統的lib中，<strong>mgov-core-jasperreports</strong> 已預先將 <strong>標楷體</strong> 包成jar上傳到 <strong>repo.tist.com.tw</strong> 所以只有當字型使用其他字型時才需要這麼做</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Linux環境在產生PDF時候還會發生找不到標楷體的錯誤，可能是主機檔案系統空間已滿造成
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_清單類報表製作策略">8.2.5. 清單類報表製作策略</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>DataSource： <code>JRBeanCollectionDataSource</code> ，也就是程式先將資料整理好封裝到Java Bean再傳遞 給JasperReports</p>
</li>
<li>
<p>設計Java Bean</p>
<div class="listingblock">
<div class="title">Java Bean設計範例(移撥物資明細)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Data
@RequiredArgsConstructor
public class Goods {

    @NonNull
    private String name; <i class="conum" data-value="1"></i><b>(1)</b>

    @NonNull
    private Integer amount; <i class="conum" data-value="2"></i><b>(2)</b>

    @NonNull
    private String unit; <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>品名</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>數量</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>單位</td>
</tr>
</table>
</div>
</li>
<li>
<p>實做Service完成將相關查詢結果封裝到Java Bean</p>
</li>
<li>
<p>依據Java Bean欄位設計報表</p>
</li>
<li>
<p>驗證報表輸出格式是否跑版</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_jaspersoft_studio_報表設計簡介">8.2.6. Jaspersoft Studio 報表設計簡介</h4>
<div class="ulist">
<ul>
<li>
<p><span class="menuseq"><b class="menu">File</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">New</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Jasper Report</b></span> 建立新的報表</p>
</li>
<li>
<p><span class="menuseq"><b class="menu">Outline</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Styles</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Create Style</b></span> 建立共用樣式</p>
<div class="imageblock">
<div class="content">
<img src="images/jasper-studio-01.png" alt="Create Style" width="500">
</div>
<div class="title">Figure 5. Create Style</div>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="menuseq"><b class="menu">Properties</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Style</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Name</b></span> 設定可識別名稱例如 BaseStyle</p>
</li>
<li>
<p><span class="menuseq"><b class="menu">Properties</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Style</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Default Style</b></span> 勾選，則所有新增元素預設皆使用此樣式</p>
</li>
<li>
<p><span class="menuseq"><b class="menu">Properties</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Style</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Blank When NULL</b></span> True，如果輸入的內容是null則空白顯示， 否則將顯示null</p>
</li>
<li>
<p><span class="menuseq"><b class="menu">Properties</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Style</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Text Alignment</b></span> 水平對齊選center，垂直對齊選middle</p>
</li>
<li>
<p><span class="menuseq"><b class="menu">Properties</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Style</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Font</b></span> 選擇『標楷體』，大小選擇12，mgov-core-jasperreport 會順便引用標楷體，這樣製作pdf中文才會正常</p>
</li>
<li>
<p><span class="menuseq"><b class="menu">Properties</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Borders</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Borders</b></span> 點選四個邊，並請將 Pen Width設定為0.50</p>
<div class="imageblock">
<div class="content">
<img src="images/jasper-studio-02.png" alt="Border Style" width="500">
</div>
<div class="title">Figure 6. Border Style</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><span class="menuseq"><b class="menu">Outline</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Parameters</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Create Parameter</b></span> 建立參數</p>
</li>
<li>
<p><span class="menuseq"><b class="menu">Outline</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Fields</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Create Field</b></span> 建立欄位</p>
<div class="ulist">
<ul>
<li>
<p>Name 直接設定中文名稱即可</p>
</li>
<li>
<p>Description 這邊必須設定Java Bean的屬性名稱</p>
</li>
<li>
<p>Class 設定Java Bean屬性的型態</p>
</li>
</ul>
</div>
</li>
<li>
<p>Basic Element選擇，Text Field可輸入動態內容，所以內容是變動的需要使用此類，固定內容 則使用Static Text，清單類報表大概只需要這兩種即可，使用錯類型也可以事後轉換</p>
</li>
<li>
<p>Band設計，清單類的通常只需要Title、Column Header、 Detail，其餘用不到的可以刪除，事 後如果發現需要可以還原</p>
<div class="ulist">
<ul>
<li>
<p>Title設計，將Title的 <span class="menuseq"><b class="menu">Properties</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Appearance</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Layout</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Layouts</b></span>設定為 Vertical Layout，也就是垂直對齊，加入的Element寬度都會拉伸到與Title同寬並且往下堆疊， 拖曳一個Text Field進入Title，滑鼠連點修改內容，例如
<code>"移撥" + $P{WarehouseName} + "發放物資數量"</code>， <code>$P{}</code> 代表參數類的，可以在預先建立好的 參數區加入</p>
<div class="imageblock">
<div class="content">
<img src="images/jasper-studio-03.png" alt="Expression Editor" width="500">
</div>
<div class="title">Figure 7. Expression Editor</div>
</div>
</li>
<li>
<p>Column Header與Detail設計</p>
<div class="ulist">
<ul>
<li>
<p>將兩者的<span class="menuseq"><b class="menu">Properties</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Appearance</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Layout</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Layouts</b></span>設定為 Grid Layout</p>
</li>
<li>
<p>全選Field拖曳到Detail區即可</p>
</li>
<li>
<p>如果需要流水號，事先手動增加，並且將Detail區的Text Field內容設定為 <code>$V{REPORT_COUNT}</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>先調整高度再調整寬度，Grid Layout預設為自動，如果需要調整寬度需要將
<span class="menuseq"><b class="menu">Properties</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Appearance</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Layout</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Fixed Size</b></span> 設定為True，然後再到
<span class="menuseq"><b class="menu">Properties</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Appearance</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Size</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">w</b></span> 調整寬度</p>
</li>
</ul>
</div>
</li>
<li>
<p>點選.jrxml檔按滑鼠右鍵選單 選擇Compile Report，理論上會產生.jasper檔，兩者都可以跟 程式整合，但是jasper檔由於已經預先編譯，速度比較快，jrxml則類似原始碼的角色</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_jasperreports報表測試">8.2.7. JasperReports報表測試</h4>
<div class="listingblock">
<div class="title">JasperReports單元測試</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">package com.tist.util;

import com.tist.bean.Goods;
import com.tist.report.ReportFormat;
import com.tist.report.ReportSetting;
import net.sf.jasperreports.engine.data.JRBeanCollectionDataSource;
import org.junit.jupiter.api.Test;

import java.io.FileOutputStream;
import java.io.OutputStream;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class GoodsTransferReportTest {

    @Test
    void create() throws Exception {
        List&lt;Goods&gt; goodsList = new ArrayList&lt;&gt;();
        goodsList.add(new Goods("白米(真空包)", 8, "包"));
        goodsList.add(new Goods("五木麵條2kg", 4, "包"));
        goodsList.add(new Goods("新東陽肉醬罐頭", 24, "罐"));
        goodsList.add(new Goods("肉燥泡麵", 30, "包"));
        goodsList.add(new Goods("隨緣泡麵", 30, "包"));
        goodsList.add(new Goods("沙其馬", 10, "包"));
        goodsList.add(new Goods("大豆沙拉油", 12, "罐"));
        goodsList.add(new Goods("保久乳", 48, "罐"));
        goodsList.add(new Goods("阿華田", 6, "罐"));
        goodsList.add(new Goods("日安麥片", 12, "包"));
        goodsList.add(new Goods("八寶粥", 24, "罐"));
        goodsList.add(new Goods("鮪魚罐頭", 24, "罐"));
        goodsList.add(new Goods("科學麵", 40, "包"));
        goodsList.add(new Goods("精鹽", 4, "包"));
        goodsList.add(new Goods("玉米罐頭", 24, "罐"));
        JRBeanCollectionDataSource dataSource = new JRBeanCollectionDataSource(goodsList); <i class="conum" data-value="1"></i><b>(1)</b>

        Map&lt;String, Object&gt; parameters = new HashMap&lt;&gt;(); <i class="conum" data-value="2"></i><b>(2)</b>
        parameters.put("WarehouseName", "宜蘭教會物資銀行");
        parameters.put("TransferDate", "107年11月6日");

        ReportSetting setting = new ReportSetting();
        setting.setJasperName("goods-transfer.jasper"); <i class="conum" data-value="3"></i><b>(3)</b>
        //setting.setJrxmlName("goods-transfer.jrxml");
        setting.setParameters(parameters); <i class="conum" data-value="4"></i><b>(4)</b>

        setting.setDataSource(dataSource);
        setting.setSheetName("移撥單"); <i class="conum" data-value="5"></i><b>(5)</b>

        for (ReportFormat format : ReportFormat.values()) {
            dataSource.moveFirst();
            setting.setFormat(format);
            OutputStream outputStream = new FileOutputStream("goods-transfer." + format.getCode());
            JasperReportUtils.write(setting, outputStream);
            outputStream.close();
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>準備測試用DataSource</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>準備報表所需參數</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>設定預計使用的jasper檔</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>設定參數</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>輸出Excel的頁籤名或者下載時使用的檔名</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Service範例(無標準寫法僅供參考)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Service
public class GoodsTransferReportServiceImpl
        implements GoodsTransferReportService {

    @Override
    public ResponseEntity&lt;Resource&gt; createReportResponseEntity(
            GoodsAsk goodsAsk, String format
    ) {

        ReportSetting setting = new ReportSetting();
        setting.setJasperName("jasper/goods-transfer.jasper");
        setting.setFormat(EnumUtils.getValueOf(ReportFormat.class, format));
        setting.setDataSource(
                new JRBeanCollectionDataSource(goodsAsk.getGoodsAskDetails())
        );
        setting.putParameter(
                "WarehouseName", goodsAsk.getReceivedWarehouse().getName()
        );
        setting.putParameter(
                "TransferDate",
                DateUtils.format(goodsAsk.getOutDate(), DateUtils.EEEMMDD_SAY)
        );
        setting.setSheetName("簽收單");
        return JasperReportUtils.createResponseEntity(setting);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_子報表簡介">8.2.8. 子報表簡介</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Parameter &gt; 新增兩個parameter</p>
<div class="ulist">
<ul>
<li>
<p>一個類別設定成 net.sf.jasperreports.engine.JasperReport 這個要拿來放子報表</p>
</li>
<li>
<p>另一個類別是 net.sf.jasperreports.engine.data.JRBeanCollectionDataSource 這個是子報表的資料來源</p>
</li>
</ul>
</div>
</li>
<li>
<p>把 Subreport 拉到要放子報表的位置</p>
<div class="ulist">
<ul>
<li>
<p>這時會跑出一個視窗，勾選 Select an existing report</p>
<div class="imageblock">
<div class="content">
<img src="images/subreport-1.png" alt="Select an existing report" width="500">
</div>
<div class="title">Figure 8. Select an existing report</div>
</div>
</li>
<li>
<p>接著在下方輸入$P{JasperReport變數名稱} (或點右邊的編輯按鈕然後選 Parameter 或在 JasperReport 的變數點兩下也可以)</p>
</li>
<li>
<p>點next後出現 Connection的頁面，勾選 Use a JRDatasource expression 在下面輸入$P{剛剛的DataSource的變數名稱} (或點右邊的編輯按鈕然後選 Parameter 後在 DataSource 的變數點兩下也可以)</p>
<div class="imageblock">
<div class="content">
<img src="images/subreport-2.png" alt="Use a JRDatasource expression" width="500">
</div>
<div class="title">Figure 9. Use a JRDatasource expression</div>
</div>
</li>
<li>
<p>設計子報表欄位</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
記得建立子報表的jrxml檔案
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
子報表也是獨立的報表，裡面文件邊緣預設會有空格會影響原本報表的排版<br>
排版時需要稍微注意一下
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Service範例(無標準寫法僅供參考)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Override
public ResponseEntity&lt;Resource&gt; createReportResponseEntity(AppGoodsApply appGoodsApply, String format) {

    ReportSetting setting = new ReportSetting();
    List&lt;GoodsAssessment&gt; goodsAssessments =
        setGoodsAssessment(appGoodsApply);
    List&lt;GoodsAssessmentRequireItem&gt; goodsAssessmentRequireItems =
        setGoodsAssessmentRequirementItem(appGoodsApply);
    Resource subReportFile =
        new ClassPathResource("jasper/requirement-item.jasper");
    JasperReport subReport = null;

    //設定子報表樣板
    try {
        subReport = (JasperReport) JRLoader.loadObject(subReportFile.getFile());
    } catch (JRException | IOException e) {
        e.printStackTrace();
    }

    //設定報表樣板
    setting.setJasperName("jasper/goods-assessment.jasper");
    setting.setFormat(EnumUtils.getValueOf(ReportFormat.class, format));
    //設定報表資料來源
    setting.setDataSource(
            new JRBeanCollectionDataSource(goodsAssessments)
    );

    //將子報表指定給報表的參數
    setting.putParameter("subReport", subReport);
    //設定子報表資料來源
    setting.putParameter("requirementItems",
        new JRBeanCollectionDataSource(goodsAssessmentRequireItems));

    setting.setSheetName("食物銀行核定單");

    //設定報表名稱
    String filename = appGoodsApply.getAppPerson().getName() + "食物銀行核定單." + format;
    MimetypesFileTypeMap fileTypeMap = new MimetypesFileTypeMap();
    String mimeType = fileTypeMap.getContentType(filename);

    return ResponseEntity
            .ok()
            .contentType(MediaType.parseMediaType(mimeType))
            .header(HttpHeaders.CONTENT_DISPOSITION,
                    UrlUtils.getFileDownloadHeader(filename))
            .body(new ByteArrayResource(JasperReportUtils.generateReport(setting)));
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_測試">9. 測試</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_單元測試原則">9.1. 單元測試原則</h3>
<div class="ulist">
<div class="title">3A原則</div>
<ul>
<li>
<p>Arrange：初始化物件及預期結果(excepted)<br></p>
</li>
<li>
<p>Act：調用物件基本方法<br></p>
</li>
<li>
<p>Assert：驗證結果是否符合預期結果</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class FooTest{
    @Test
    public void add(){
        // Arrange
        Foo foo = new Foo();
        foo.setAge(13);
        int excepted  = 18;
        // Act
        int actual = foo.getAge() + 5;
        // Assert
        assertThat(actual).isEqualTo(excepted);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">一次只測試一件事</div>
<p>一個單元測試通常只測試一個方法，且不包含複雜邏輯，提高可讀性、方便除錯以及縮短處理問題的時間</p>
</div>
<div class="paragraph">
<div class="title">列外處理</div>
<p>遇到例外處理應交由JUnit來處理，避免自行撰寫try/catch</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class Foo
{
  int foo(int i) throws IOException;
}

public class FooTest{

    @Test(expected = IOException.class)
    public void add() throws Exception{
        new Foo().foo(9);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">適當使用斷言</div>
<p>正確使用斷言確保JUnit測試正常</p>
</div>
<div class="ulist">
<ul>
<li>
<p>參數順序</p>
<div class="ulist">
<ul>
<li>
<p>actual 待測物件</p>
</li>
<li>
<p>excepted 期待結果</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>assertThat(<strong><em>actual</em></strong>).isEqualTo(<strong><em>excepted</em></strong>);</code><br>
<code>assertThat(<strong><em>excepted</em></strong>).isEqualTo(<strong><em>actual</em></strong>);</code> 不符合API定義順序</p>
</div>
<div class="ulist">
<ul>
<li>
<p>合適斷言</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class Foo
{
  boolean getStatus();
  int foo(int i);
}

public class FooTest{

    @Test
    public void add(){
        assertThat(new Foo().getStatus()).isTrue();
        //assertThat(new Foo().getStatus()).isEqualTo(true);較不佳比對方式

        assertThat(new Foo().foo(9)).isEqualTo(9);
        //assertThat(new Foo().foo(9)==9).isTrue();較不佳比對方式
    }
}</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">獨立性、可重複性</div>
<ul>
<li>
<p>單元測試其對象通常是一個class中各方法，應與其他程式碼相依性不高，以確保不會因程式修改造成其他單元測試異常</p>
</li>
<li>
<p>測試需時常保持在任何環境下皆可執行，並以利各人員隨時了解程式狀況</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">涵蓋率</div>
<p>單元測試中每支程式仍有不同分支，測試時也須將 <code><strong><em>各分支</em></strong></code> 進行測試，提高測試涵蓋率<br></p>
</div>
<div class="ulist">
<ul>
<li>
<p>低涵蓋</p>
<div class="ulist">
<ul>
<li>
<p>綠色為測試完整流經程式碼</p>
</li>
<li>
<p>黃色為部分流經程式碼</p>
</li>
<li>
<p>紅色為無流經程式碼</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Service
public class FooServiceImpl implements FooService {
    @Override
    public boolean getStatus(boolean status) {
        boolean returnBoolean;
        if(status){
            returnBoolean= false;
        }else{
            returnBoolean=true;
        }
        return returnBoolean;
    }
}
public class FooServiceTest {
    @Resource
    private FooService service;
    @Test
    public void foo(){
        assertThat(service.getStatus(true)).isFalse();
    }
}</code></pre>
</div>
</div>
<div id="低涵蓋" class="imageblock">
<div class="content">
<img src="images/converge01.png" alt="低涵蓋]" width="800">
</div>
<div class="title">Figure 10. 低涵蓋</div>
</div>
<div class="ulist">
<ul>
<li>
<p>高涵蓋</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>public class FooServiceTest {
    @Resource
    private FooService service;
    @Test
    public void foo(){
        assertThat(service.getStatus(true)).isFalse();
        assertThat(service.getStatus(false)).isTrue();
    }
}</pre>
</div>
</div>
<div id="高涵蓋" class="imageblock">
<div class="content">
<img src="images/converge02.png" alt="高涵蓋]" width="800">
</div>
<div class="title">Figure 11. 高涵蓋</div>
</div>
</div>
<div class="sect2">
<h3 id="_單元測試使用工具">9.2. 單元測試使用工具</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://junit.org/junit5/">JUnit5</a>：主要的測試框架</p>
</li>
<li>
<p><a href="http://joel-costigliola.github.io/assertj/">AssertJ</a>：JUnit5已經不內建斷言工具，所以
採用此方案</p>
</li>
<li>
<p><a href="https://site.mockito.org/">Mockito 2</a>：模擬用(無法模擬靜態方法)</p>
</li>
<li>
<p><a href="https://jmockit.github.io/">JMockit</a>：模擬靜態方法</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">pom.xml設定範例(surefire 3.x)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;properties&gt;
    ...
    ...
    &lt;!-- junit --&gt;
    &lt;mockito-junit-jupiter.version&gt;2.23.4&lt;/mockito-junit-jupiter.version&gt;
    &lt;h2.version&gt;1.4.197&lt;/h2.version&gt;
    &lt;jmockit.version&gt;1.46&lt;/jmockit.version&gt;
    &lt;!-- plugins --&gt;
    &lt;maven-surefire-plugin.version&gt;3.0.0-M1&lt;/maven-surefire-plugin.version&gt;
&lt;/properties&gt;

&lt;dependencyManagement&gt;
    &lt;dependencies&gt;
        ...
        ...
        &lt;dependency&gt;
            &lt;groupId&gt;org.mockito&lt;/groupId&gt;
            &lt;artifactId&gt;mockito-junit-jupiter&lt;/artifactId&gt;
            &lt;version&gt;${mockito-junit-jupiter.version}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.tist&lt;/groupId&gt;
            &lt;artifactId&gt;mgov-core-jupiter&lt;/artifactId&gt;
            &lt;version&gt;${mgov-core.version}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.h2database&lt;/groupId&gt;
            &lt;artifactId&gt;h2&lt;/artifactId&gt;
            &lt;version&gt;${h2.version}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.jmockit&lt;/groupId&gt;
            &lt;artifactId&gt;jmockit&lt;/artifactId&gt;
            &lt;version&gt;${jmockit.version}&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;

&lt;dependencies&gt;
    ...
    ...
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;
        &lt;artifactId&gt;junit-jupiter-engine&lt;/artifactId&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.mockito&lt;/groupId&gt;
        &lt;artifactId&gt;mockito-junit-jupiter&lt;/artifactId&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.tist&lt;/groupId&gt;
        &lt;artifactId&gt;mgov-core-jupiter&lt;/artifactId&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.h2database&lt;/groupId&gt;
        &lt;artifactId&gt;h2&lt;/artifactId&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.jmockit&lt;/groupId&gt;
        &lt;artifactId&gt;jmockit&lt;/artifactId&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;

&lt;build&gt;
    &lt;plugins&gt;
        ...
        ...
        &lt;plugin&gt;
            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
            &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
            &lt;version&gt;${maven-surefire-plugin.version}&lt;/version&gt;
            &lt;configuration&gt;
                &lt;argLine&gt;
                    -javaagent:${settings.localRepository}/org/jmockit/jmockit/${jmockit.version}/jmockit-${jmockit.version}.jar
                &lt;/argLine&gt;
                &lt;includes&gt;
                    &lt;include&gt;**/Test*.java&lt;/include&gt;
                    &lt;include&gt;**/*Test.java&lt;/include&gt;
                    &lt;include&gt;**/*Tests.java&lt;/include&gt;
                    &lt;include&gt;**/*TestCase.java&lt;/include&gt;
                &lt;/includes&gt;
                &lt;excludedGroups&gt;slow&lt;/excludedGroups&gt;
                &lt;groups&gt;full,fast&lt;/groups&gt;
            &lt;/configuration&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;
&lt;/build&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
完整測試的策略是使用JUnit5的tag進行分類，依照不同tag分不同群組進行測試， <code>slow</code>
用於測試整合其他環境例如資料庫，需要花費大量時間者，這類的單元測試只能單獨執行，在Maven的生命
週期將被忽略， <code>full</code> 則用於整合spring，同一群進行測試可避免重複初始化，大幅減低測試時間，
<code>fast</code> 則為一般的單元測試
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">pom.xml設定範例(surefire 2.x)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;properties&gt;
    ...
    ...
    &lt;!-- junit --&gt;
    &lt;mockito-junit-jupiter.version&gt;2.23.4&lt;/mockito-junit-jupiter.version&gt;
    &lt;h2.version&gt;1.4.197&lt;/h2.version&gt;
    &lt;jmockit.version&gt;1.46&lt;/jmockit.version&gt;
    &lt;!-- plugins --&gt;
    &lt;maven-surefire-plugin.version&gt;2.22.1&lt;/maven-surefire-plugin.version&gt;
&lt;/properties&gt;

&lt;dependencyManagement&gt;
    &lt;dependencies&gt;
        ...
        ...
        &lt;dependency&gt;
            &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;
            &lt;artifactId&gt;junit-jupiter-engine&lt;/artifactId&gt;
            &lt;version&gt;${org.junit.jupiter.version}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;
            &lt;artifactId&gt;junit-jupiter-api&lt;/artifactId&gt;
            &lt;version&gt;${org.junit.jupiter.version}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.mockito&lt;/groupId&gt;
            &lt;artifactId&gt;mockito-junit-jupiter&lt;/artifactId&gt;
            &lt;version&gt;${mockito-junit-jupiter.version}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.tist&lt;/groupId&gt;
            &lt;artifactId&gt;mgov-core-jupiter&lt;/artifactId&gt;
            &lt;version&gt;${mgov-core.version}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.h2database&lt;/groupId&gt;
            &lt;artifactId&gt;h2&lt;/artifactId&gt;
            &lt;version&gt;${h2.version}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.jmockit&lt;/groupId&gt;
            &lt;artifactId&gt;jmockit&lt;/artifactId&gt;
            &lt;version&gt;${jmockit.version}&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;

&lt;dependencies&gt;
    ...
    ...
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
        &lt;scope&gt;test&lt;/scope&gt;
        &lt;exclusions&gt;
            &lt;exclusion&gt;
                &lt;artifactId&gt;android-json&lt;/artifactId&gt;
                &lt;groupId&gt;com.vaadin.external.google&lt;/groupId&gt;
            &lt;/exclusion&gt;
            &lt;exclusion&gt;
                &lt;artifactId&gt;junit&lt;/artifactId&gt;
                &lt;groupId&gt;junit&lt;/groupId&gt;
            &lt;/exclusion&gt;
        &lt;/exclusions&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;
        &lt;artifactId&gt;junit-jupiter-engine&lt;/artifactId&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.mockito&lt;/groupId&gt;
        &lt;artifactId&gt;mockito-junit-jupiter&lt;/artifactId&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.tist&lt;/groupId&gt;
        &lt;artifactId&gt;mgov-core-jupiter&lt;/artifactId&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.h2database&lt;/groupId&gt;
        &lt;artifactId&gt;h2&lt;/artifactId&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.jmockit&lt;/groupId&gt;
        &lt;artifactId&gt;jmockit&lt;/artifactId&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;

&lt;build&gt;
    &lt;plugins&gt;
        ...
        ...
        &lt;plugin&gt;
            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
            &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
            &lt;version&gt;${maven-surefire-plugin.version}&lt;/version&gt;
            &lt;configuration&gt;
                &lt;argLine&gt;
                    -javaagent:${settings.localRepository}/org/jmockit/jmockit/${jmockit.version}/jmockit-${jmockit.version}.jar
                &lt;/argLine&gt;
                &lt;includes&gt;
                    &lt;include&gt;**/Test*.java&lt;/include&gt;
                    &lt;include&gt;**/*Test.java&lt;/include&gt;
                    &lt;include&gt;**/*Tests.java&lt;/include&gt;
                    &lt;include&gt;**/*TestCase.java&lt;/include&gt;
                &lt;/includes&gt;
                &lt;properties&gt;
                    &lt;!-- &lt;includeTags&gt;fast&lt;/includeTags&gt; --&gt;
                    &lt;excludeTags&gt;slow&lt;/excludeTags&gt;
                    &lt;!--
                    &lt;configurationParameters&gt;
                        junit.jupiter.conditions.deactivate = *
                    &lt;/configurationParameters&gt;
                    --&gt;
                &lt;/properties&gt;
            &lt;/configuration&gt;
            &lt;dependencies&gt;
                &lt;dependency&gt;
                    &lt;groupId&gt;org.junit.platform&lt;/groupId&gt;
                    &lt;artifactId&gt;junit-platform-surefire-provider&lt;/artifactId&gt;
                    &lt;version&gt;${junit.platform.version}&lt;/version&gt;
                &lt;/dependency&gt;
            &lt;/dependencies&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;
&lt;/build&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">簡單的單元測試(非Spring Bean)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Fast <i class="conum" data-value="1"></i><b>(1)</b>
public class SimpleTest{

    @Test <i class="conum" data-value="2"></i><b>(2)</b>
    void someMethod() {
        <i class="conum" data-value="3"></i><b>(3)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>使用自訂的tag歸類為可快速完成的測試</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>只要加上 <code>@Test</code> 即可</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>要測試的程式碼</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">資料庫單元測試</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Slow <i class="conum" data-value="1"></i><b>(1)</b>
@ExtendWith(SpringExtension.class)
@SpringBootTest
@ActiveProfiles("dev") <i class="conum" data-value="2"></i><b>(2)</b>
public class SlowSampleTest {

    @Resource
    private UserService service; <i class="conum" data-value="3"></i><b>(3)</b>

    @DisplayName("QueryContext查詢指定類型") <i class="conum" data-value="4"></i><b>(4)</b>
    @Test
    public void queryAllByUserClass() {
        QueryContext queryContext = new QueryContext();
        queryContext.getConditions().put("class", User.class.getName());
        Page&lt;User&gt; page = service.queryAll(queryContext);
        assertThat(page).isNotNull(); <i class="conum" data-value="5"></i><b>(5)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>標記為slow，封裝時將忽略此測試，但是平常手動測試時可以，理由有二，啟動要花費大量時
間，另外如果資料庫異常就沒辦法正常執行</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>將以application-dev.yml設定為主</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>注入要測試的Spring Bean</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>可自訂單元測試要顯示的名稱，Gradle與IDEA有支援，但是surefire尚未支援</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>斷言page不能為null</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">模擬測試Spring MVC Controller</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Fast <i class="conum" data-value="1"></i><b>(1)</b>
@ExtendWith(MockitoExtension.class) <i class="conum" data-value="2"></i><b>(2)</b>
public class MockitoSampleTest {

    @Mock <i class="conum" data-value="3"></i><b>(3)</b>
    private DepartmentService departmentService;

    @Mock <i class="conum" data-value="4"></i><b>(4)</b>
    private FileAttachService fileAttachService;

    @Mock <i class="conum" data-value="5"></i><b>(5)</b>
    private LocaleMessageService localeMessageService;

    @InjectMocks <i class="conum" data-value="6"></i><b>(6)</b>
    private DepartmentController departmentController;

    private MockMvc mockMvc;

    @BeforeEach
    public void init() {
        MockitoAnnotations.initMocks(this); <i class="conum" data-value="7"></i><b>(7)</b>
        mockMvc = MockMvcBuilders <i class="conum" data-value="8"></i><b>(8)</b>
                .standaloneSetup(departmentController)
                .build();

        new MockUp&lt;SecurityContext&gt;() { <i class="conum" data-value="18"></i><b>(18)</b>
            @mockit.Mock
            public User getUser() {
                return new User();
            }
        };
    }

    @DisplayName("測試查詢最上層單位")
    @Test
    public void departmentQuery() throws Exception {
        List&lt;Department&gt; departs = new ArrayList&lt;&gt;();
        Department depart = new Department();
        depart.setNo("1234");
        depart.setName("測試部門");
        departs.add(depart);

        when(departmentService.findByParentIsNullOrderBySortAsc()).thenReturn(departs); <i class="conum" data-value="9"></i><b>(9)</b>

        String content = mockMvc.perform(
                get("/admin/department/query") <i class="conum" data-value="10"></i><b>(10)</b>
                        .accept("application/json") <i class="conum" data-value="11"></i><b>(11)</b>
                        .param("parentId", "") <i class="conum" data-value="12"></i><b>(12)</b>
        ).andExpect(status().isOk()) <i class="conum" data-value="13"></i><b>(13)</b>
                .andExpect(jsonPath("$").isArray()) <i class="conum" data-value="14"></i><b>(14)</b>
                .andReturn() <i class="conum" data-value="15"></i><b>(15)</b>
                .getResponse()
                .getContentAsString(); <i class="conum" data-value="16"></i><b>(16)</b>
        assertThat(content).endsWith("}]"); <i class="conum" data-value="17"></i><b>(17)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>使用自訂的tag歸類為可快速完成的測試</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>使用 <code>Mockito</code> 整合 <code>JUnit5</code> 的專用模組</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>注入一個模擬的 <code>DepartmentService</code> 物件</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>注入一個模擬的 <code>FileAttachService</code> 物件</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>注入一個模擬的 <code>LocaleMessageService</code> 物件</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>本測試主角</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>將 <code>@Mock</code> 對應的物件設定到 <code>@InjectMocks</code> 對應的物件，有可能失敗，可手動設定</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>以此Controller建立對應的模擬MvcContext</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>設定情境，當(<code>when</code>)呼叫模擬物件的某個方法時，則回傳(<code>thenReturn</code>)指定內容，後續的測試
如果有滿足 <code>when</code> 的定義則會回傳 <code>thenReturn</code> 定義的內容</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>模擬 GET <code>/admin/department/query</code></td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>且Request希望的格式是json格式</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>設定Request的參數</td>
</tr>
<tr>
<td><i class="conum" data-value="13"></i><b>13</b></td>
<td>預期應該回傳的是http code=200</td>
</tr>
<tr>
<td><i class="conum" data-value="14"></i><b>14</b></td>
<td>搭配 <code>jsonPath</code> ，判斷最上層的JSON結構是陣列</td>
</tr>
<tr>
<td><i class="conum" data-value="15"></i><b>15</b></td>
<td>要求回傳Response</td>
</tr>
<tr>
<td><i class="conum" data-value="16"></i><b>16</b></td>
<td>將Response轉成字串</td>
</tr>
<tr>
<td><i class="conum" data-value="17"></i><b>17</b></td>
<td>有時候可能會輸出一些奇怪的空白在前方導致 <code>jsonPath</code> 異常，但是瀏覽器會正常，也可這樣
判斷結尾是不是 預期中的格式</td>
</tr>
<tr>
<td><i class="conum" data-value="18"></i><b>18</b></td>
<td>模擬靜態方法SecurityContext.getUser</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
純模擬只能測試部份功能，好處是速度極快，本範例模擬MVC主要可測試ajax時JSON的轉換
      與欄位驗證是否正常
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">帶參數的單元測試</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java"><i class="conum" data-value="1"></i><b>(1)</b>
public class MockChildcareCaseProvider {

    public static ChildcareCase create() { <i class="conum" data-value="2"></i><b>(2)</b>
        ChildcareCase source = new ChildcareCase();
        source.setId("childcare-case-id");
        source.setNo("childcare-case-no");
        source.setAppDate(LocalDate.now());
        source.setSourceType(ChildcareCaseSourceType.業務端);
        source.setStatus(MockSysConfigProvider.create("1", "媒合中"));
        source.setParent(MockParentProvider.create());
        source.setCenter(source.getParent().getCenter());
        source.setTargetType(MockSysConfigProvider.create("1", "一般"));
        source.setNurseryTime(MockSysConfigProvider.create("1", "白天"));
        source.setFeeAmountMin(1000L);
        source.setFeeAmountMax(20000L);
        source.setExpectDate(LocalDate.now());
        source.setCareCity(MockCountryCodeProvider.create());
        source.setCareTown(MockCountryCodeProvider.create());
        source.setCareVillage(MockCountryCodeProvider.create());
        source.setChildren(source.getParent().getChildren());
        return source;
    }

    public static Stream&lt;ChildcareCase&gt; stream() {
        return Stream.of(create()); <i class="conum" data-value="3"></i><b>(3)</b>
    }
}

@DisplayName("測試新增")
@ParameterizedTest <i class="conum" data-value="4"></i><b>(4)</b>
@MethodSource("com.tist.provider.mock.MockChildcareCaseProvider#stream") <i class="conum" data-value="5"></i><b>(5)</b>
void save(ChildcareCase source) throws Exception {
    MockHttpServletRequestBuilder builder = post("/rest/childcare-case/add")
        .contentType(MediaType.APPLICATION_JSON)
        .content(JsonUtils.stringify(source));

    when(service.save(any(ChildcareCase.class))).thenReturn(source);

    mockMvc.perform(builder)
        .andExpect(status().isOk())
        .andExpect(jsonPath("$.code").value(Deal.OK));
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>測試相關的.java檔請建構在 <code>src/test/java</code> 下</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>建立單筆測試資料</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>可準備多筆多種情境的資料</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>參數化的單元測試與 <code>@MethodSource</code> 搭配使用</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>指定參數來源</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_高速的資料庫單元測試方案">9.2.1. 高速的資料庫單元測試方案</h4>
<div class="paragraph">
<p>使用H2的記憶體模式(SQLite也有類似的記憶體模式)，如果資料庫使用JPA可以很快速的切換資料庫
到H2進行測試，優點除了速度快還有資料庫自動重設、可完整測試商業邏輯，策略如下：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>建立單元測試專用的application-junit.yml，其中的資料庫設定為H2 Memory mode</p>
</li>
<li>
<p>準備初始化使用的SQL檔在啟動時將資料匯入H2(例如系統參數與行政區域代碼)</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">application-junit.yml範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">spring:
  datasource:
    type: com.zaxxer.hikari.HikariDataSource
    url: jdbc:h2:mem:myDb;DB_CLOSE_DELAY=-1 <i class="conum" data-value="1"></i><b>(1)</b>
    driver-class-name: org.h2.Driver
    maximum-pool-size: 10 <i class="conum" data-value="2"></i><b>(2)</b>
    platform: h2
  mail:
    host: 192.168.1.2
    port: 25
  jpa:
    generate-ddl: true <i class="conum" data-value="3"></i><b>(3)</b>
    show-sql: false
    database-platform: org.hibernate.dialect.H2Dialect <i class="conum" data-value="4"></i><b>(4)</b>
tist:
  admin:
    debug: true
    mail-from: online@tist.com.tw
    upload: D:\upload
debug: true
logging:
  level:
    org:
      hibernate: ERROR</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>myDb可換成其他名稱</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>維持10個連線數，可以用來測試平行運算</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>由於每次啟動都是空的資料庫，所以需要每次都重建Table，不過記憶體模式下執行速度極快</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>H2的方言</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">載入測試用sql檔範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Configuration
@AutoConfigureBefore(WebMvcAutoConfiguration.class) <i class="conum" data-value="1"></i><b>(1)</b>
@Profile("junit") <i class="conum" data-value="2"></i><b>(2)</b>
public class InMemoryConfig {

    private static final String SAMPLE_DATA = "classpath:data-h2.sql"; <i class="conum" data-value="3"></i><b>(3)</b>

    @Autowired
    private DataSource datasource;

    @Autowired
    private WebApplicationContext webApplicationContext;

    @PostConstruct
    public void loadIfInMemory() throws Exception {
        EncodedResource resource = new EncodedResource(
            webApplicationContext.getResource(SAMPLE_DATA), "UTF-8"
        );
        ScriptUtils.executeSqlScript(datasource.getConnection(), resource); <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>載入順序在MVC設定之前</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>當profile為junit時才會生效</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>要載入的sql檔路徑，代表會嘗試尋找data-h2.sql檔</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>批次執行SQL指令</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">H2單元測試範例1</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Full <i class="conum" data-value="1"></i><b>(1)</b>
@DisplayName("保母基本資料測試")
@Transactional <i class="conum" data-value="2"></i><b>(2)</b>
@ExtendWith(SpringExtension.class)
@SpringBootTest
@Import(InMemoryConfig.class) <i class="conum" data-value="3"></i><b>(3)</b>
@ActiveProfiles("junit") <i class="conum" data-value="4"></i><b>(4)</b>
class NannyRepositoryTest {

    @Resource
    private NannyRepository repository;

    @DisplayName("測試查詢")
    @Test
    void findAll() { <i class="conum" data-value="5"></i><b>(5)</b>
        List&lt;Nanny&gt; nannys = repository.findAll(
            "center.kind", ChildcareCenterKind.托嬰中心
        );
        assertThat(nannys).isEmpty();

        nannys = repository.findAll(
            "center.kind", ChildcareCenterKind.居家托育服務中心
        );
        assertThat(nannys).isEmpty();

        nannys = repository.findAll(
            "null-check-center", "null"
        );
        assertThat(nannys).isEmpty();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>使用自訂的tag歸類為與spring進行整合的完整測試</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>資料庫相關測試加上@Transactional比較方便，事後還會自動rollback</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>需要額外匯入設定匯入sql的設定</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>使用application-junit.yml設定</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>其他測試與其他資料庫測試一樣</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">H2單元測試範例2</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Target({ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Inherited
@Full
@Transactional
@ExtendWith(SpringExtension.class)
@SpringBootTest
@AutoConfigureMockMvc
@Import({InMemoryConfig.class})
@ActiveProfiles("junit")
public @interface MgovTest {
}

@DisplayName("保母基本資料測試")
@MgovTest
class NannyRepositoryTest {

}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_test_suite">9.2.2. Test Suite</h4>
<div class="listingblock">
<div class="title">設定相依套件</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.junit.platform&lt;/groupId&gt;
    &lt;artifactId&gt;junit-platform-runner&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Test Suite範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@RunWith(JUnitPlatform.class)
@SelectPackages("com.tist")
@IncludeTags("full")
public class FullTestSuite {

}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_logging_機制">9.2.3. logging 機制</h4>
<div class="paragraph">
<p>與其他主程式相同，請使用成熟的log套件例如SLF4J，不要直接使用System.out或者System.err輸出，
單測測試的時候或許問題不大，但是專案的完整測試由於數量龐大，過多的垃圾訊息可能掩蓋了有用的訊息，
透過成熟的log機制才能進行調整，另外訊息量過大也會降低單元測試的效能，拉長了單元測試時間</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<strong>mgov-core</strong> 預設log level為 <code>WARN</code>，可透過環境變數 <code>MGOV_LOG_LEVEL</code> 進行調
           整，IDEA可以在 <span class="menuseq"><b class="menu">Run/Debug Configurations</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Templates</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Junit</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Environment variables</b></span>
           設定 <code>MGOV_LOG_LEVEL=DEBUG</code>，就可將log level調整為 <code>DEBUG</code>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_壓力測試">9.3. 壓力測試</h3>
<div class="paragraph">
<p>使用 <a href="https://jmeter.apache.org/">Apache JMeter</a>壓力測試</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<span class="menuseq"><b class="menu">Options</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Choose Language</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Chinese Traditional</b></span> 可切換為繁體中文，或者在
     JMeter目錄中新增檔案 <code>bin/setenv.bat</code> 內容為
     <code>set JMETER_LANGUAGE=-Duser.language="zh" -Duser.region="TW"</code>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_測試計畫設計順序">9.3.1. 測試計畫設計順序</h4>
<div class="ulist">
<ul>
<li>
<p>設定測試計畫(Test Plan)含 使用者自訂變數(User Defined Variables)</p>
</li>
<li>
<p>新增執行序群組(Thread Group)</p>
</li>
<li>
<p>新增控制器(Controller)</p>
</li>
<li>
<p>新增接聽(Listener)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_維護作業壓測設計範例">9.3.2. 維護作業壓測設計範例</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
請先以開發環境進行設計，完成後有需要再切換成正式環境即可
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
簡易錄製腳本:可參考最後一點BlazeMeter方法，可精簡步驟1~6
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>測試計畫名稱 請設定與案名有關的名稱</p>
</li>
<li>
<p>使用者自訂變數請至少設定以下四個變數，效果是後續錄製腳本時，JMeter如果發現一樣的文字將會使用變
數取代，可減低後續整理的時間</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>scheme</code> 設定http或者https</p>
</li>
<li>
<p><code>host</code> 設定 <code>localhost</code> 或者其他domain name</p>
</li>
<li>
<p><code>port</code> 設定 <code>8080</code> 或者其他http 埠號</p>
</li>
<li>
<p><code>password</code> 設定登入用的密碼</p>
</li>
</ol>
</div>
</li>
<li>
<p><span class="menuseq"><b class="menu">測試計畫</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">新增</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">執行序群組</b></span>(<span class="menuseq"><b class="menu">Test Plan</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Add</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Threads(Users)</b></span>)</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><strong>執行序數量(Number of Threads(users))</strong>： 模擬幾個使用者同時操作系統</p>
</li>
<li>
<p><strong>啟動延遲(秒)(Ramp-Up Period(in seconds))</strong>： 每個執行序延遲啟動的秒數，如果設定0秒，
代表立即啟動，如果設定1秒則每個執行序啟動的間隔為1秒</p>
</li>
<li>
<p><strong>迴圈次數</strong>： 執行序群組重複執行的次數</p>
</li>
</ol>
</div>
</li>
<li>
<p><span class="menuseq"><b class="menu">執行序群組</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">新增</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">邏輯控制器</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">錄製控制器</b></span>
(<span class="menuseq"><b class="menu">Thread Group</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Add</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Logic Controller</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Recording Controller</b></span>)</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<b class="button">Clear all the recorded samples</b> 會清除所有錄製內容，請謹慎使用
</td>
</tr>
</table>
</div>
</li>
<li>
<p><span class="menuseq"><b class="menu">錄製控制器</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">新增</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">設定元素</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">HTTP Cookie 管理員</b></span>
(<span class="menuseq"><b class="menu">Recording Controller</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Add</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Config Element</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">HTTP Cookie Manager</b></span>)
設定這個才可以保存cookie，讓登入之後的測試可以正常</p>
</li>
<li>
<p><span class="menuseq"><b class="menu">測試計畫</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">新增</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">非測試元素</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">HTTP代理伺服器</b></span>
(<span class="menuseq"><b class="menu">Test Plan</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Add</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Non-Test Elements</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">HTTP(S) Test Script Recorder</b></span>)</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><strong>端口(port)</strong> ：預設為8888</p>
</li>
<li>
<p><strong>目標控制器(Target Controller)</strong> ： 請選擇剛剛新增的 <strong>錄製控制器(Recording Controller)</strong></p>
</li>
<li>
<p><span class="menuseq"><b class="menu">Requests Filtering</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">除外的型式</b></span>： 請點選 <b class="button">Add suggested Excludes</b> 可在
錄製時自動忽略部份靜態檔案網址</p>
</li>
<li>
<p><b class="button">開始</b> ：啟動代理伺服器，後續就可以在瀏覽器的網路設定將代理伺服器設定到JMeter提供的代
理伺服器，所有的http(s)的存取將會被側錄下來</p>
</li>
</ol>
</div>
</li>
<li>
<p>錄製腳本範例</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>切換到登入畫面</p>
</li>
<li>
<p>輸入帳號密碼登入</p>
</li>
<li>
<p>點選要測試的作業</p>
</li>
<li>
<p>點選新增按鈕</p>
</li>
<li>
<p>可查詢欄位輸入可識別字眼例如 <code>jmeter_test</code> ，其餘欄位可隨意輸入，完成新增動作</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
識別用字眼建議不要用中文，JMeter處理中文有問題，後續整理Request時還需要加工此字眼
</td>
</tr>
</table>
</div>
</li>
<li>
<p>查詢條件輸入剛剛的識別字眼 <code>jmeter_test</code>，這裡的用意是將查詢出來的資料限制在剛剛新增的資料
方便後續擷取主鍵或者其他重要資訊</p>
</li>
<li>
<p>點選修改按鈕進入修改頁面</p>
</li>
<li>
<p>隨意修改後完成修改動作</p>
</li>
<li>
<p>點選刪除鈕刪除該筆紀錄</p>
</li>
<li>
<p>登出</p>
</li>
</ol>
</div>
</li>
<li>
<p>經過一連串神操作之後，開始整理，刪除用不到request，例如靜態檔案、反灰、或者其他用不到的</p>
</li>
<li>
<p><span class="menuseq"><b class="menu">HTTP要求</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Content encoding</b></span> 設定UTF-8</p>
</li>
<li>
<p>擷取 CSRF Token</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>新增畫面的HTTP Request <span class="menuseq"><b class="menu">新增</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">後置處理器</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">CSS Selector Extractor</b></span>
(<span class="menuseq"><b class="menu">Add</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Post Processors</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">CSS Selector Extractor</b></span>)</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>參照名稱(Name of created variable)： <code>csrfToken</code></p>
</li>
<li>
<p>CSS Selector expression： <code>input[name=_csrf]</code></p>
</li>
<li>
<p>Attribute： <code>value</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>設定CSRF Token： 所有HTTP Request參數有_csrf的值都改成 <code>${__V(csrfToken)}</code></p>
</li>
<li>
<p>擷取主鍵</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>查詢指定關鍵字HTTP Request <span class="menuseq"><b class="menu">新增</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">後置處理器</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">正規表示式剖析器</b></span>
(<span class="menuseq"><b class="menu">Add</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Post Processors</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Regular Expression Extractor</b></span>)</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>參照名稱(Name of created variable)： <code>bulletinId</code></p>
</li>
<li>
<p>正規表示式(Regular Expression)： <code>onclick="location.href='/admin/bulletin/update/(.+)'"</code></p>
</li>
<li>
<p>範本($i$ where i is capturing group number,start at 1)： <code>$1$</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>設定主鍵：所有有使用到主鍵的欄位值都改為 <code>${__V(bulletinId)}</code></p>
</li>
<li>
<p>關鍵字眼加上序號：所有使用到 <code>jmeter_test</code> 改為 <code>jmeter_test${__counter(false)}</code></p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
查詢時如果條件有like記得將like拿掉，避免干擾，例如jmeter_test1查到jmeter_test11
</td>
</tr>
</table>
</div>
</li>
<li>
<p><span class="menuseq"><b class="menu">測試計畫</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">新增</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">接聽</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">檢視結果樹</b></span>
(<span class="menuseq"><b class="menu">Test Plan</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Add</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Listener</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">View Results Tree</b></span>) ：可用來人工檢測實際測試內容</p>
</li>
<li>
<p><span class="menuseq"><b class="menu">測試計畫</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">新增</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">接聽</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Summary Report</b></span>
(<span class="menuseq"><b class="menu">Test Plan</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Add</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Listener</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Summary Report</b></span>)</p>
</li>
<li>
<p><span class="menuseq"><b class="menu">測試計畫</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">新增</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">接聽</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">彙整報告</b></span>
(<span class="menuseq"><b class="menu">Test Plan</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Add</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Listener</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Aggregate Report</b></span>)</p>
</li>
<li>
<p>使用<a href="https://chrome.google.com/webstore/detail/blazemeter-the-continuous/mbopgmdnpcbohhpnfglgohlbhfongabi?hl=zh-TW">BlazeMeter</a>錄製腳本:</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
BlazeMeter可產生不錯的錄製腳本，但變數部分仍需手動進行調整，如csrf token、帳號、密碼&#8230;&#8203;等
</td>
</tr>
</table>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>安裝後右上方會出現B火球按鈕</p>
</li>
<li>
<p>點擊按鈕出現介面，可使用gmail登入</p>
</li>
<li>
<p>登入成功後輸入測試計畫名稱後點擊紅色圓形按鈕，即可開始操作步驟7的動作</p>
</li>
<li>
<p>操作結束後點擊紅色按鈕中止錄製</p>
</li>
<li>
<p>再次點擊火球按鈕選擇save按鈕</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>select scripts to save選擇[JMeter only(JMX)]</p>
</li>
<li>
<p>Select domains to include in your JMeter script選擇undefined</p>
</li>
</ol>
</div>
</li>
<li>
<p>使用JMeter開啟下載的JMX</p>
</li>
<li>
<p>同步驟8後開始整理測試計畫</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/jmeter01.png" alt="jmeter01" width="600">
</div>
<div class="title">Figure 12. JMeter 測試計畫概觀</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_持續整合">10. 持續整合</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_持續整合工具_jenkins簡介">10.1. 持續整合工具-Jenkins簡介</h3>
<div class="paragraph">
<div class="title">持續整合(Continuous Integration)</div>
<p>不同人員進行源碼更新後便會面臨整合問題，已確認這次更新無造成系統之異常，持續整合的宗旨是避免整合問題，並進行源碼分析及單元測試，進而提高程式碼
品質並且提早發現問題，進一步的完整擴展便是持續交付(CD)。</p>
</div>
<div class="ulist">
<div class="title">Why Jenkins?</div>
<ul>
<li>
<p>Jenkins為持續整合平台的一種，為目前使用度最高之平台，其優勢是支援大量plugin，其適用範圍不僅限於Java。</p>
</li>
<li>
<p>透過Jenkins將CI自動化可提高整合頻率、提高程式碼透明度、可確實執行各項單元測試，以及整合靜態分析報告，以便第一時間發現議題以及追蹤。</p>
</li>
<li>
<p>透過自動化測試除能提高程式品，也可省去工程師大量時間，工程師更能將心力放在優化上，達到低重工，高再用精神。</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_安裝jenkins">10.2. 安裝Jenkins</h3>
<div class="listingblock">
<div class="title">Step 1. 新增Jenkins repo</div>
<div class="content">
<pre>wget -O /etc/yum.repos.d/jenkins.repo http://pkg.jenkins.io/redhat-stable/jenkins.repo</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>rpm --import http://pkg.jenkins.io/redhat-stable/jenkins.io.key</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Step 2. 安裝Jenkins以及java，Jenkins為Java所撰寫故需安裝JRE</div>
<div class="content">
<pre>yum install java-1.8.0-openjdk jenkins</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Step 3. Jenkins預設port為8080，可修改為其他port號</div>
<div class="content">
<pre>vi /etc/sysconfig/jenkins

JENKINS_PORT="8082"</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Step 4. 啟動Jenkins</div>
<div class="content">
<pre>systemctl start jenkins</pre>
</div>
</div>
<div class="paragraph">
<p>開機自動啟動</p>
</div>
<div class="listingblock">
<div class="content">
<pre>systemctl enable jenkins</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Step 5. 開啟網頁畫面</div>
<div class="content">
<pre>http://your.server.ip:8082</pre>
</div>
</div>
<div class="paragraph">
<p>取得初始admin密碼並輸入於頁面</p>
</div>
<div class="listingblock">
<div class="content">
<pre>cat /var/lib/jenkins/secrets/initialAdminPassword</pre>
</div>
</div>
<div id="輸入預設密碼" class="imageblock">
<div class="content">
<img src="images/initpwd.png" alt="輸入預設密碼]" width="800">
</div>
<div class="title">Figure 13. 輸入預設密碼</div>
</div>
<div class="paragraph">
<div class="title">Step 6.安裝 Plugin</div>
<p>選擇建議插件即可，需花點時間等待</p>
</div>
<div id="安裝插件" class="imageblock">
<div class="content">
<img src="images/install-plugin.png" alt="安裝插件]" width="800">
</div>
<div class="title">Figure 14. 安裝插件</div>
</div>
</div>
<div class="sect2">
<h3 id="_安裝openjdk">10.3. 安裝OpenJDK</h3>
<div class="listingblock">
<div class="title">Step 1. 下載 JDK</div>
<div class="content">
<pre>yum install java-1.8.0-openjdk-devel</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Step 2. Jenkins設置 JAVA_HOME</div>
<div class="content">
<pre>管理Jenkins&gt;Global Tool Configuration&gt;JDK&gt;新增JDK&gt;自動安裝取消打勾</pre>
</div>
</div>
<div class="paragraph">
<p>JDK名稱自填，JAVA預設安裝於/usr/lib/jvm/，將JAVA_HOME指向JDK目錄</p>
</div>
<div id="jdk" class="imageblock">
<div class="content">
<img src="images/jdk.png" alt="安裝jdk]" width="800">
</div>
<div class="title">Figure 15. 安裝jdk</div>
</div>
</div>
<div class="sect2">
<h3 id="_安裝git">10.4. 安裝Git</h3>
<div class="listingblock">
<div class="title">Step 1. 下載 git</div>
<div class="content">
<pre>yum install git-core</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Step 2. Jenkins設置 Git</div>
<div class="content">
<pre>管理Jenkins&gt;Global Tool Configuration&gt;Git</pre>
</div>
</div>
<div class="paragraph">
<p>正常下完yum安裝指令後下方紅字會自動消失代表配置成功，若仍有紅字則需自己指向</p>
</div>
<div id="git" class="imageblock">
<div class="content">
<img src="images/git01.png" alt="安裝git]" width="800">
</div>
<div class="title">Figure 16. 安裝git</div>
</div>
</div>
<div class="sect2">
<h3 id="_安裝maven">10.5. 安裝Maven</h3>
<div class="listingblock">
<div class="title">Step 1. Jenkins設置 Maven</div>
<div class="content">
<pre>管理Jenkins&gt;Global Tool Configuration&gt;Maven&gt;Maven安裝</pre>
</div>
</div>
<div class="paragraph">
<p>Maven名稱自填，使用自動安裝即可</p>
</div>
<div id="maven" class="imageblock">
<div class="content">
<img src="images/maven.png" alt="安裝maven]" width="800">
</div>
<div class="title">Figure 17. 安裝maven</div>
</div>
<div class="paragraph">
<div class="title">Step 2. Maven settings</div>
<p>預設settings.xml在，第一次安裝在執行mvn相關指令才會進行安裝，並出現以下路徑</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/var/lib/jenkins/tools/hudson.tasks.Maven_MavenInstallation/&lt;1&gt;/conf/</pre>
</div>
</div>
<div class="paragraph">
<p>&lt;1&gt;設定之maven名稱
將原本的settings.xml改名並上傳公司使用之settings.xml即可</p>
</div>
</div>
<div class="sect2">
<h3 id="_plugin安裝">10.6. Plugin安裝</h3>
<div class="paragraph">
<div class="title">Warnings Next Generation Plugin</div>
<p>整合多種靜態分析報告，可各自呈現抑或整合呈現，以及趨勢圖形</p>
</div>
<div class="paragraph">
<div class="title">JaCoCo</div>
<p>涵蓋率測試工具</p>
</div>
<div class="paragraph">
<div class="title">HTML Publisher</div>
<p>可部署HTML，Jenkins預設禁用css、javascript，若要正常使用需調整<br></p>
</div>
<div class="listingblock">
<div class="content">
<pre>vi /etc/sysconfig/jenkins</pre>
</div>
</div>
<div class="paragraph">
<p>調整JENKINS_JAVA_OPTIONS</p>
</div>
<div class="listingblock">
<div class="content">
<pre>JENKINS_JAVA_OPTIONS="-Dhudson.model.DirectoryBrowserSupport.CSP=\"default-src 'none'; img-src 'self'; style-src 'self';child-src 'self'; frame-src 'self';\" -Djava.awt.headless=true"</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_gitea建立ssh連線">10.7. Gitea建立SSH連線</h3>
<div class="paragraph">
<p>Gitea為方便操作git之平台，在操作方式上與Github上有許多雷同之處<br></p>
</div>
<div class="paragraph">
<p><a href="http://git.tist.com.tw:3000/">Gitea</a> 使用AD帳號密碼</p>
</div>
<div class="listingblock">
<div class="title">Step 1. 使用linux ssh-keygen建立 SSH金鑰，使用自己之 AD帳號</div>
<div class="content">
<pre>ssh-keygen -t rsa -C "AD帳號"</pre>
</div>
</div>
<div class="paragraph">
<p>建立過程中會詢問3個問題，全部不輸入enter即可<br></p>
</div>
<div class="paragraph">
<p>會在/root/.ssh/下建立id_rsa、id_rsa.pub兩個檔案，一個為私鑰及公鑰</p>
</div>
<div class="paragraph">
<div class="title">Step 2. 登入 Gitea&gt;右上角用戶設定&gt;SSH/GPG金鑰&gt;增加 SSH金鑰</div>
<p>輸入金鑰名稱，金鑰內容為id_rsa.pub中的內容</p>
</div>
<div class="listingblock">
<div class="content">
<pre>cat /root/.ssh/id_rsa.pub</pre>
</div>
</div>
<div id="新增金鑰" class="imageblock">
<div class="content">
<img src="images/ssh01.png" alt="新增金鑰]" width="800">
</div>
<div class="title">Figure 18. 新增金鑰</div>
</div>
<div id="輸入公鑰" class="imageblock">
<div class="content">
<img src="images/ssh02.png" alt="輸入公鑰]" width="800">
</div>
<div class="title">Figure 19. 輸入公鑰</div>
</div>
</div>
<div class="sect2">
<h3 id="_建置基本作業">10.8. 建置基本作業</h3>
<div class="paragraph">
<div class="title">Step 1. 新增作業&gt;建置 Free-Style軟體專案</div>
<p>輸入專案名稱</p>
</div>
<div class="paragraph">
<div class="title">Step 2. General</div>
<p>簡單描述專案內容</p>
</div>
<div class="paragraph">
<div class="title">Step 3. 原始碼管理</div>
<p>選擇Git<br>
Repository URL請輸入SSH格式，未建立SSH故紅字連線失敗<br></p>
</div>
<div id="設定repository" class="imageblock">
<div class="content">
<img src="images/git02.png" alt="設定repository]" width="800">
</div>
<div class="title">Figure 20. 設定repository</div>
</div>
<div class="paragraph">
<div class="title">Step 4. 新增 SSH連線</div>
<p>選擇右方Add選擇Jenkins<br>
Kind:選擇 <code>SSH Username with private key</code><br>
UserName: <code>AD帳號</code><br>
Private Key: <code>SSH私鑰</code><br>
其餘空白<br></p>
</div>
<div class="listingblock">
<div class="content">
<pre>cat /root/.ssh/id_rsa</pre>
</div>
</div>
<div id="新增SSH連線" class="imageblock">
<div class="content">
<img src="images/git03.png" alt="新增SSH連線]" width="800">
</div>
<div class="title">Figure 21. 新增SSH連線</div>
</div>
<div class="paragraph">
<div class="title">Step 5.選擇 SSH連線</div>
<p>Credentials中會出現剛剛輸入之AD帳號選項，選擇之後紅字消失即連線成功</p>
</div>
<div class="paragraph">
<div class="title">Step 6.建置觸發程序</div>
<p>定期排程: <code>設定排程後固定執行建置</code><br>
輪詢 SCM: <code>設定排程後固定尋訪git，若有異動則建置，反之則不建置</code><br>
兩者皆使用cron expression，設置成功後會在下方顯示下次執行之時間</p>
</div>
<div id="排程" class="imageblock">
<div class="content">
<img src="images/cron.png" alt="排程]" width="800">
</div>
<div class="title">Figure 22. 排程</div>
</div>
<div class="paragraph">
<div class="title">Step 7.建置</div>
<p>新增建置步驟&gt;呼叫最上層Maven目標<br>
Maven 版本: 選擇安裝之Maven版本<br>
Goal: <code>clean test</code><br>
<br>
選擇進階(<strong><em>optional</em></strong>)<br>
JVM 選項參數: <code>-Xmx512M</code>，較容易遭遇記憶體問題，若有其他參數需求也可以下在這</p>
</div>
<div class="paragraph">
<div class="title">Step 8.建置後動作</div>
<p>新增建置後動作&gt;發布JUnit測試結果報告<br>
測試報告 XML: <code>target/surefire-reports/*.xml</code> 使用Maven surefire產生之報告<br>
會顯示紅字為正常，因第一次建置工作區尚無此路徑，第二次之後就不會顯示</p>
</div>
<div class="paragraph">
<div class="title">Step 9.馬上建置</div>
<p>儲存後選擇左方馬上建置待建置完成，可再專案首頁看到最新測試結果</p>
</div>
<div id="建置結果" class="imageblock">
<div class="content">
<img src="images/test.png" alt="建置結果]" width="800">
</div>
<div class="title">Figure 23. 建置結果</div>
</div>
</div>
<div class="sect2">
<h3 id="_使用_findbugs_進行靜態分析">10.9. 使用 Findbugs 進行靜態分析</h3>
<div class="paragraph">
<div class="title">所需 Plugins</div>
<p>Warnings Next Generation Plugin</p>
</div>
<div class="paragraph">
<div class="title">Step 1. 專案組態&gt;建置</div>
<p>Goal: <code>clean test findbugs:findbugs</code><br>
若有其他參數需求也可增加:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>clean
test
findbugs:findbugs
-Dfindbugs.excludeFilterFile=config/findbugs/findbugs-filter.xml</pre>
</div>
</div>
<div class="paragraph">
<div class="title">Step 3. Add Tool&gt;FindBugs</div>
<p>Report File Pattern: <code>target/findbugsXml.xml</code></p>
</div>
<div class="paragraph">
<div class="title">Step 4. 重新建置</div>
<p>重新建置完成後可在首頁看到報告結果，以及趨勢圖</p>
</div>
<div id="findbugs" class="imageblock">
<div class="content">
<img src="images/findbugs.png" alt="findbugs]" width="800">
</div>
<div class="title">Figure 24. findbugs</div>
</div>
</div>
<div class="sect2">
<h3 id="_使用_checkstyle_進行靜態分析">10.10. 使用 Checkstyle 進行靜態分析</h3>
<div class="paragraph">
<div class="title">所需 Plugins</div>
<p>Checkstyle、Static Analysis Collector</p>
</div>
<div class="paragraph">
<div class="title">Step 1. 專案組態&gt;建置</div>
<p>Goal: <code>clean checkstyle:checkstyle</code>
若有其他參數需求也可增加:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>clean
checkstyle:checkstyle
-Dcheckstyle.config.location=config/checkstyle/checkstyle.xml</pre>
</div>
</div>
<div class="paragraph">
<div class="title">Step 3. Add Tool&gt;FindBugs</div>
<p>Report File Pattern: <code>target/checkstyle-result.xml</code></p>
</div>
<div class="paragraph">
<div class="title">Step 4. 重新建置</div>
<p>重新建置完成後可在首頁看到報告結果，以及趨勢圖</p>
</div>
<div id="checkstyle" class="imageblock">
<div class="content">
<img src="images/checkstyle.png" alt="checkstyle]" width="800">
</div>
<div class="title">Figure 25. checkstyle</div>
</div>
</div>
<div class="sect2">
<h3 id="_使用_jacoco_進行涵蓋率分析">10.11. 使用 Jacoco 進行涵蓋率分析</h3>
<div class="paragraph">
<div class="title">所需 Plugins</div>
<p>JaCoCo</p>
</div>
<div class="listingblock">
<div class="title">Step 1. pom.xml</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;build&gt;
    &lt;plugins&gt;
        &lt;plugin&gt;
				&lt;groupId&gt;org.jacoco&lt;/groupId&gt;
				&lt;artifactId&gt;jacoco-maven-plugin&lt;/artifactId&gt;
				&lt;version&gt;0.7.8&lt;/version&gt;
				&lt;executions&gt;
					&lt;execution&gt;
						&lt;id&gt;prepare-agent&lt;/id&gt;
						&lt;goals&gt;
							&lt;goal&gt;prepare-agent&lt;/goal&gt;
						&lt;/goals&gt;
					&lt;/execution&gt;
					&lt;execution&gt;
						&lt;id&gt;report&lt;/id&gt;
						&lt;phase&gt;prepare-package&lt;/phase&gt;
						&lt;goals&gt;
							&lt;goal&gt;report&lt;/goal&gt;
						&lt;/goals&gt;
					&lt;/execution&gt;
					&lt;execution&gt;
						&lt;id&gt;post-unit-test&lt;/id&gt;
						&lt;phase&gt;test&lt;/phase&gt;
						&lt;goals&gt;
							&lt;goal&gt;report&lt;/goal&gt;
						&lt;/goals&gt;
						&lt;configuration&gt;
							&lt;dataFile&gt;target/jacoco.exec&lt;/dataFile&gt;
							&lt;outputDirectory&gt;target/jacoco-ut&lt;/outputDirectory&gt;
						&lt;/configuration&gt;
					&lt;/execution&gt;
				&lt;/executions&gt;
			&lt;/plugin&gt;
    &lt;/plugins&gt;
&lt;/build&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Step 2. 專案組態&gt;建置</div>
<p>Goal: <code>clean test</code></p>
</div>
<div class="paragraph">
<div class="title">Step 3. 專案組態&gt;建置後動作&gt;Record JaCoCo coverage report</div>
<p>Path to exec files&gt;Exclusions: 排除分析之源碼</p>
</div>
<div class="paragraph">
<div class="title">Step 5. 重新建置</div>
<p>重新建置完成後可在首頁看到報告結果，以及趨勢圖</p>
</div>
<div id="JaCoCo報告" class="imageblock">
<div class="content">
<img src="images/jacoco-report.png" alt="JaCoCo報告]" width="800">
</div>
<div class="title">Figure 26. JaCoCo報告</div>
</div>
</div>
<div class="sect2">
<h3 id="_設定_email通知">10.12. 設定 Email通知</h3>
<div class="paragraph">
<div class="title">Step 1. 設定mail server</div>
<p>管理Jenkins&gt;設定系統&gt;電子郵件通知
SMTP 伺服器: <code>192.168.1.2</code><br>
預設使用者信箱後綴字串: <code>@tist.com.tw</code><br>
<br>
管理Jenkins&gt;設定系統&gt;Jenkins 位置<br>
系統管理員郵件地址 : <code>online@tist.com.tw</code> 寄件者名稱</p>
</div>
<div id="設定Server" class="imageblock">
<div class="content">
<img src="images/mail01.png" alt="設定Server]" width="800">
</div>
<div class="title">Figure 27. 設定Server</div>
</div>
<div class="paragraph">
<div class="title">Step 2. 測試Mail</div>
<p>寄測試信，看看設定正不正確 打勾<br>
輸入自己之mail address點擊右方 <code>測試設定</code></p>
</div>
<div class="paragraph">
<div class="title">Step 3. 專案組態&gt;建置後動作&gt;電子郵件通知</div>
<p>收件人: <code>xxx@tist.com.tw</code> 多個收件人以空白隔開<br>
每次建置不穩定都寄送郵件 打勾<br></p>
</div>
<div class="ulist">
<ul>
<li>
<p>建置失敗, 發信</p>
</li>
<li>
<p>建置狀態從不穩定或失敗恢復, 發信</p>
</li>
<li>
<p>建置狀態從成功轉變成不穩定, 發信</p>
</li>
<li>
<p>每一個不穩定的建置, 發信</p>
</li>
</ul>
</div>
<div id="設定通知" class="imageblock">
<div class="content">
<img src="images/mail02.png" alt="設定通知]" width="800">
</div>
<div class="title">Figure 28. 設定通知</div>
</div>
</div>
<div class="sect2">
<h3 id="_jenkins升級">10.13. Jenkins升級</h3>
<div class="paragraph">
<p>Jenkins更新週期為每周一更，每12週會釋出LTS版本。</p>
</div>
<div class="listingblock">
<div class="title">Step 1.關閉Jenkins</div>
<div class="content">
<pre>systemctl stop jenkins</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Step 2. 備份原本war</div>
<div class="content">
<pre>cd /usr/lib/jenkins/

mv jenkins.war org_jenkins.war</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Step 3. 下載更新war，需些時間</div>
<div class="content">
<pre>wget http://mirrors.jenkins.io/war-stable/latest/jenkins.war</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Step 4. 重啟Jenkins</div>
<div class="content">
<pre>systemctl start jenkins</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_範例">11. 範例</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_如何繼承user增加系統使用者欄位">11.1. 如何繼承User(增加系統使用者欄位)</h3>
<div class="paragraph">
<p>User與Department均可</p>
</div>
<div class="sect3">
<h4 id="_entity繼承_user">11.1.1. Entity繼承 User</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@ApiModel(description = "保母使用者")
@Entity
@DiscriminatorValue("cwis_user")
@Table(name = "tist_cwis_user")
@PrimaryKeyJoinColumn(name = "id_", foreignKey = @ForeignKey(name = "fk_tist_cwis_user_pkjc"))
@Data
@EqualsAndHashCode(
        callSuper = true,
        doNotUseGetters = true)
@ToString(
        callSuper = true,
        doNotUseGetters = true, exclude = {"refUsers"}
)
public class CwisUser extends User {

    /**
     * 主要使用者
     */
    @ApiModelProperty("主要使用者")
    @ManyToOne
    @JoinColumn(name = "main_user_id_", foreignKey = @ForeignKey(name = "fk_tist_cwis_user_mu"))
    private CwisUser mainUser;

    /**
     * 關聯使用者
     */
    @ApiModelProperty("關聯使用者")
    @JsonProperty(access = JsonProperty.Access.READ_ONLY)
    @OneToMany(mappedBy = "mainUser")
    private List&lt;CwisUser&gt; refUsers;


    /**
     * 大頭照
     */
    @ApiModelProperty("大頭照")
    @ManyToOne(cascade = CascadeType.ALL)
    @JoinColumn(
            name = "head_shot_id_",
            foreignKey = @ForeignKey(name = "fk_tist_cwis_user_head_shot")
    )
    private FileAttach headShot;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_repository_2">11.1.2. Repository</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public interface CwisUserRepository extends GenericUserRepository&lt;CwisUser&gt; {
    <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>如果沒有要新增功能保持淨空即可</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_serviceinterface">11.1.3. Service(interface)</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public interface CwisUserService extends GenericUserService&lt;CwisUser, CwisUserRepository&gt; {
    <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>如果沒有要新增功能保持淨空即可</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_serviceclass">11.1.4. Service(class)</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Transactional
@Service("com.tist.service.impl.CwisUserServiceImpl")
public class CwisUserServiceImpl extends GenericUserSerivceImpl&lt;CwisUser, CwisUserRepository&gt; implements CwisUserService {

    @Setter
    @Resource
    private FileAttachService fileAttachService;

    @Override
    public void beforeSave(CwisUser source) {
        <i class="conum" data-value="1"></i><b>(1)</b>
    }

    @Override
    public void beforeUpdate(CwisUser source, CwisUser target) {
        <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>新增前的屬性調整</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>修改前的屬性調整，source代表client傳遞過來的資料，target代表資料庫目前的資料</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_controller_2">11.1.5. Controller</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@ProgramInfo("程式編號")
@Controller("com.tist.web.admin.CwisUserController")
@RequestMapping("/admin/cwis-user")
@SessionAttributes("queryContext")
@Slf4j
public class CwisUserController extends GenericUserController&lt;CwisUser, CwisUserService&gt; {
    @Override
    public void beforeQuery(QueryContext queryContext) {
        <i class="conum" data-value="1"></i><b>(1)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>查詢前，查詢條件調整</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_如何在application_yml增加額外的設定">11.2. 如何在application.yml增加額外的設定</h3>
<div class="listingblock">
<div class="title">org.springframework.boot.context.properties.ConfigurationProperties 範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Component
@ConfigurationProperties(prefix = "mgov") <i class="conum" data-value="1"></i><b>(1)</b>
@Data
public class MgovConfig {

    /**
     * 預設縣市代碼
     */
    private String cityCode;

    /**
     * 村里幹事角色名稱(複數)
     */
    private List&lt;String&gt; villageOfficerRoles;

    /**
     * OTP存活時間
     */
    private int otpLifeHour;

    /**
     * 拋轉即結案
     */
    private boolean autoClose;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>prefix 設定為mgov表示設定檔中的設定都是mgov起頭的</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">application.yml設定範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">mgov:
  city-code: 6600000000
  village-officer-roles:
    - 里幹事
    - 國保員
  otp-life-hour: 14
  auto-close: true</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_如何設定與使用系統參數">11.3. 如何設定與使用系統參數</h3>
<div class="sect3">
<h4 id="_在後台參數管理新增">11.3.1. 在後台參數管理新增</h4>
<div class="paragraph">
<p>建立兩層的參數，上層參數的參數編號為主參數代碼，下層參數的參數編號為次參數代碼，請將主參數代碼紀錄在com.tist.constant方便日後操作與管理</p>
</div>
</div>
<div class="sect3">
<h4 id="_entity_設定sysconfig屬性">11.3.2. Entity 設定SysConfig屬性</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@ManyToOne
@JoinColumn(name = "marry_id_")
private SysConfig marry;

@ManyToMany
@JoinTable(
    name = "tist_app_imcs_app_item",
    joinColumns = { @JoinColumn(name = "app_imcs_id_") },
    inverseJoinColumns = { @JoinColumn(name = "app_item_id_") },
    uniqueConstraints = @UniqueConstraint(
        columnNames = { "app_imcs_id_", "app_item_id_" }))
private List&lt;SysConfig&gt; appItems;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_controller_設定_modelattribute">11.3.3. Controller 設定 ModelAttribute</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@SysConfigResource(MainConfig.SWIS_Z1_MARRY)
private Map&lt;String, String&gt; marrys;

@ModelAttribute("marrys")
public Map&lt;String, String&gt; getMarrys() {
    return marrys;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_樣板使用範例">11.3.4. 樣板使用範例</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="ftl">&lt;@tist.singleSelect path="main.marry.id" options={"":"請選擇..."}+marrys /&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_如何設定與使用_encodableenum專用">11.4. 如何設定與使用 Encodable(Enum專用)</h3>
<div class="sect3">
<h4 id="_在com_tist_domain建立enum">11.4.1. 在com.tist.domain建立Enum</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public enum Gender implements Encodable {
    男("M"),
    女("F");

    private String code;

    Gender(String code) {
        this.code = code;
    }

    @Override
    public String getCode() {
        return code;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_在com_tist_jpa_convert建立converter">11.4.2. 在com.tist.jpa.convert建立Converter</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Converter(autoApply = true)
public class GenderConverter extends EncodableAttributeConverter&lt;Gender&gt; {
    public GenderConverter() {
        super(Gender.class);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_controller_設定_modelattribute_2">11.4.3. Controller 設定 ModelAttribute</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@EncodableResource(Gender.class)
private Map&lt;String, Gender&gt; genders;

@ModelAttribute("genders")
public Map&lt;String, Gender&gt; getGenders() {
    return genders;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">樣板使用範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="ftl">&lt;@tist.radioButtons path="main.gender" options=genders /&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_檔案上傳">11.5. 檔案上傳</h3>
<div class="listingblock">
<div class="title">設定</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">tist:
  admin:
    upload: 上傳檔案路徑
    filename-strategy: monthly|simple
# monthly 一個月一個目錄存放
# simple 全部存放在同一個目錄</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_entity_設計fileattach屬性">11.5.1. Entity 設計FileAttach屬性</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@ManyToMany(cascade = CascadeType.ALL)
@JoinTable(
    name = "tist_xxx_attach",
    joinColumns = { @JoinColumn(name = "xxx_id_") },
    inverseJoinColumns = { @JoinColumn(name = "attach_id_") },
    uniqueConstraints = @UniqueConstraint(
        columnNames = { "xxx_id_", "attach_id_" }))
private List&lt;FileAttach&gt; attachs;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
FileAttach.file 屬性用來接上傳的檔案，在view中設定該屬性的路徑到file input
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_service_處理方式">11.5.2. Service 處理方式</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Resource
private FileAttachService fileAttachService;

// 新增
List&lt;FileAttach&gt; attachs = new ArrayList&lt;&gt;();
fileAttachService.update(source.getAttachs(), attachs);
source.setAttachs(attachs);

//修改
fileAttachService.update(source.getAttachs(), target.getAttachs());</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_檔案下載">11.5.3. 檔案下載</h4>
<div class="paragraph">
<div class="title">方法一：傳遞給 AttachController處理</div>
<p><code>/admin/attach/{FileAttach id}</code></p>
</div>
<div class="listingblock">
<div class="title">方法二：透過FileAttachService</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Resource
private FileAttachService fileAttachService;

@GetMapping("download/{id}")
@ResponseBody
public ResponseEntity&lt;Resource&gt; download(@PathVariable("id") String id)
    throws Exception {
    return fileAttachService.getResponseEntityById(id);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_如何發送_email">11.6. 如何發送 Email</h3>
<div class="sect3">
<h4 id="_開發環境設定_application_dev_yml">11.6.1. 開發環境設定 application-dev.yml</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">spring:
  mail:
    host: casarray.systex.tw
    port: 25
    username: online
    password: KEqwp#5283ws
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
tist:
  admin:
    mail-from: online@tist.com.tw</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_測試環境設定_application_test_yml">11.6.2. 測試環境設定 application-test.yml</h4>
<div class="paragraph">
<p>與開發環境相同</p>
</div>
</div>
<div class="sect3">
<h4 id="_正式環境設定_application_live_yml">11.6.3. 正式環境設定 application-live.yml</h4>
<div class="listingblock">
<div class="title">客戶自建SMTP Server且需要帳號密碼驗證者</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">spring:
  mail:
    host: SMTP Host
    port: 25
    username: 帳號
    password: 密碼
tist:
  admin:
    mail-from: 寄件者信箱</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">使用Gmail(需要先申請應用程式密碼)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">spring:
  mail:
    host: smtp.gmail.com
    port: 465
    username: 帳號@gmail.com
    password: 應用程式密碼
    properties:
      mail:
        smtp:
          host: smtp.gmail.com
            auth: true
            port: 465
            socketFactory:
              port: 465
              class: javax.net.ssl.SSLSocketFactory
tist:
  admin:
    mail-from: 寄件者信箱</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_樣板">11.6.4. 樣板</h4>
<div class="paragraph">
<p>使用FreeMarker當樣板，路徑為src/resources/templates</p>
</div>
<div class="listingblock">
<div class="title">範例1</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Service
@Slf4j
public class SomeMailServiceImpl  {

    @Resource
    private EmailService emailService;

    @Override
    public void sendMail() {
        try {

            EmailImplBuilder builder = EmailImpl
                .builder()
                .from(new InternetAddress("online@tist.com.tw", "我是寄件者"))
                .to(
                    Lists.newArrayList(
                        new InternetAddress("收件者信箱",
                            "收件者")))
                .subject("主旨")
                .body("")
                .encoding(Charset.forName("UTF-8"));

            EmailImpl email = builder.build();

            //要傳遞給樣板的資料
            Map&lt;String, Object&gt; model = new HashMap&lt;&gt;();
            model.put("config", config);
            emailService.send(email, "default/email/care-notice-result.ftl", model);
        } catch (Exception e) {
            log.error(e.getLocalizedMessage());
        }
    }

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">範例2</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Data
public class Notification {

    /**
     * 主旨
     */
    private String subject;

    /**
     * 收件人
     */
    private String toName;

    /**
     * 收件人電子信箱
     */
    private String toEmail;

    /**
     * 樣板資料來源
     */
    private Map&lt;String, Object&gt; model = new HashMap&lt;&gt;();

    /**
     * 樣板路徑
     */
    private String template;

    /**
     * 附件
     */
    private Map&lt;String, byte[]&gt; attachs = new HashMap&lt;&gt;();

}

@Service("com.tist.service.impl.NotificationServiceImpl")
@Slf4j
public class NotificationServiceImpl implements NotificationService {

    @Resource
    private TistAdminConfig config;

    @Resource
    private EmailService emailService;

    @Override
    public void sendMail(Notification notification) {
        try {

            EmailImplBuilder builder = EmailImpl
                .builder()
                .from(new InternetAddress(config.getMailFrom(), config.getSystemName()))
                .to(
                    Lists.newArrayList(
                        new InternetAddress(notification.getToEmail(),
                            notification.getToName())))
                .subject(notification.getSubject())
                .body("")
                .encoding(Charset.forName("UTF-8"));
            if (!notification.getAttachs().isEmpty()) {
                List&lt;EmailAttachmentImpl&gt; attachs = new ArrayList&lt;&gt;();
                for (Entry&lt;String, byte[]&gt; entry : notification.getAttachs().entrySet()) {
                    attachs.add(
                        EmailAttachmentImpl
                            .builder()
                            .attachmentName(entry.getKey())
                            .attachmentData(entry.getValue())
                            .build());
                }
                builder.attachments(attachs);
            }
            EmailImpl email = builder.build();

            notification.getModel().put("config", config);
            emailService.send(email, notification.getTemplate(), notification.getModel());
        } catch (Exception e) {
            log.error(e.getLocalizedMessage());
        }
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_如何使用spring_security保護_restful_service">11.7. 如何使用Spring Security保護 RESTFul Service</h3>
<div class="paragraph">
<p>假設Url Pattern為 /api/* 皆屬於 RESTFul Service</p>
</div>
<div class="sect3">
<h4 id="_server端範例">11.7.1. Server端範例</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">// 無論使用到哪個api都需要通過帳號密碼與OTP的驗證，如果有通過只要Cookie中的session id不變，就可呼叫其他api而不需要重新驗證
@Configuration
public static class ApiWebSecurityConfigurer extends WebSecurityConfigurerAdapter {

    @Resource(name = "customFrontAccessDeniedHandler")
    private AccessDeniedHandler customFrontAccessDeniedHandler;

    @Resource(name = "${mgov.authentication-provider}")
    private AuthenticationProvider authenticationProvider;

    @Resource
    private AuthenticationDetailsSource&lt;HttpServletRequest, OtpAuthenticationDetails&gt; authenticationDetailsSource;

    @Override
    public void configure(WebSecurity web) throws Exception {
        web.ignoring().antMatchers("/js/**", "/css/**", "/images/**");
        web.ignoring().antMatchers("/security/**");
        web.ignoring().antMatchers("/api/login/otp");
    }

    // @formatter:off
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
        .antMatcher("/api/**")
            .authorizeRequests()
                .anyRequest()
                    .authenticated()
        .and()
            .formLogin()
                .loginPage("/api/login/index")
                .permitAll()
                .loginProcessingUrl("/api/login/process")
                .defaultSuccessUrl("/api/login/success")
                .successForwardUrl("/api/login/success")
                .failureUrl("/api/login/fail")
                .authenticationDetailsSource(authenticationDetailsSource)
        .and()
            .exceptionHandling()
                .accessDeniedHandler(customFrontAccessDeniedHandler);

        http.csrf().disable();
    }
    // @formatter:on

    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth.authenticationProvider(authenticationProvider);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_client端範例">11.7.2. Client端範例</h4>
<div class="paragraph">
<p>使用OkHttp當作Http Client，實作 CookieJar用來存放Cookie</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class ApiCookieJar implements CookieJar {
    private final HashMap&lt;String, List&lt;Cookie&gt;&gt; cookieStore = new HashMap&lt;&gt;();

    @Override
    public List&lt;Cookie&gt; loadForRequest(HttpUrl url) {
        List&lt;Cookie&gt; cookies = cookieStore.get(url.host());
        return cookies != null ? cookies : new ArrayList&lt;&gt;();
    }

    @Override
    public void saveFromResponse(HttpUrl url, List&lt;Cookie&gt; cookies) {
        cookieStore.put(url.host(), cookies);
    }

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">OkHttp Client Builder範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class HttpUtils {

    public static OkHttpClient getUnsafeOkHttpClient() {
        try {
            // Create a trust manager that does not validate certificate chains
            final TrustManager[] trustAllCerts = new TrustManager[] {
                new X509TrustManager() {
                    @Override
                    public void checkClientTrusted(
                        java.security.cert.X509Certificate[] chain,
                        String authType) throws CertificateException {
                    }

                    @Override
                    public void checkServerTrusted(
                        java.security.cert.X509Certificate[] chain,
                        String authType) throws CertificateException {
                    }

                    @Override
                    public java.security.cert.X509Certificate[] getAcceptedIssuers() {
                        return new java.security.cert.X509Certificate[] {};
                    }
                } };

            // Install the all-trusting trust manager
            final SSLContext sslContext = SSLContext.getInstance("SSL");
            sslContext.init(null, trustAllCerts, new java.security.SecureRandom());
            // Create an ssl socket factory with our all-trusting manager
            final SSLSocketFactory sslSocketFactory = sslContext.getSocketFactory();

            OkHttpClient.Builder builder = new OkHttpClient.Builder();
            builder.sslSocketFactory(sslSocketFactory);
            builder.hostnameVerifier(new HostnameVerifier() {
                @Override
                public boolean verify(String hostname, SSLSession session) {
                    return true;
                }
            });

            CookieJar cookieJar = new ApiCookieJar();
            builder.cookieJar(cookieJar);

            OkHttpClient okHttpClient = builder.build();
            return okHttpClient;
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">OkHttp Client範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class LoginTest {

    private OkHttpClient client = HttpUtils.getUnsafeOkHttpClient();

    private static final String ROOT_URL = "https://lfms.e-land.gov.tw/lfms/api";
    private static final String LOGIN_PROCESS_URL = ROOT_URL + "/login/process";
    private static final String CONFIG_URL = ROOT_URL + "/config/all";

    @Test
    public void testLogin() {

        RequestBody formBody = new FormBody.Builder()
            .add("username", "帳號")
            .add("password", "密碼")
            .build();

        Request request = new Request.Builder()
            .url(LOGIN_PROCESS_URL)
            .post(formBody)
            .build();

        Request configRequest = new Request.Builder().url(CONFIG_URL).build();
        try {
            Response response = client.newCall(request).execute();
            System.err.println(response.body().string());

            Response configResponse = client.newCall(configRequest).execute();
            System.err.println(configResponse.body().string());
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_如何轉換物件型態">11.8. 如何轉換物件型態</h3>
<div class="paragraph">
<p>使用org.springframework.core.convert.ConversionService 與 org.springframework.core.convert.converter.Converter</p>
</div>
<div class="sect3">
<h4 id="_conversionservice">11.8.1. ConversionService</h4>
<div class="paragraph">
<p>負責處理物件型態轉換，Spring MVC已經有實做ConversionService，所以只要註冊對應的Converter即可</p>
</div>
</div>
<div class="sect3">
<h4 id="_converter">11.8.2. Converter</h4>
<div class="paragraph">
<p>實際負責一對一型態轉換的轉換器，會被ConversionService調用，盡量避免使用注入的方式，容易出問題</p>
</div>
<div class="listingblock">
<div class="title">Converter 範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">// 將AppDc 轉換成 AppDm
public class AppDcToAppDmConverter implements Converter&lt;AppDc, AppDm&gt; {

    @Override
    public AppDm convert(AppDc source) {
        // 相關的轉換處理
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">註冊 Converter</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Configuration
public class ConverterConfig implements WebMvcConfigurer {

    @Override
    public void addFormatters(FormatterRegistry registry) {
        registry.addConverter(new AppDcToAppDmConverter());
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">使用 ConversionService</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Transactional
@Service("com.tist.service.impl.AppDmServiceImpl")
public class AppDmServiceImpl extends LazyProcessServiceImpl&lt;AppDm&gt;
    implements AppDmService {

    @Setter
    @Resource
    private ConversionService conversionService;

    @Override
    public AppDm createByNotice(AppDmNotice notice) {

        // ... 以上省略

        appDm = conversionService.convert(appResult.getAppDc(), AppDm.class);

        // ... 以下省略

    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_如何建立_web_service_client">11.9. 如何建立 Web Service Client</h3>
<div class="sect3">
<h4 id="_使用apache_cxf_指令將wsdl轉換成java_code">11.9.1. 使用Apache CXF 指令將wsdl轉換成Java Code</h4>
<div class="paragraph">
<p>使用瀏覽器瀏覽wsdl確認targetNamespace 內容</p>
</div>
<div class="literalblock">
<div class="title">執行wsdl2java.bat指令進行轉換</div>
<div class="content">
<pre>C:\apache\cxf\3.1.6\bin\wsdl2java.bat -client -d Z:\temp\ws -p http://icfws.sfaa.gov.tw/city=com.tist.ws.icf -impl -validate -exsh false -dns true -dex true -wsdlLocation http://icfws.tist.com.tw/ws/city/IcfCityService?wsdl -verbose -defaultValues -fe jaxws -db jaxb -wv 1.1 http://icfws.tist.com.tw/ws/city/IcfCityService?wsdl</pre>
</div>
</div>
<div class="paragraph">
<p>使用ConvertZ或者其他轉碼軟體將產生的檔案編碼從Big5轉換成UTF-8，將轉換後的.java檔複製到專案內即可使用</p>
</div>
<div class="listingblock">
<div class="title">建立Web Service Client(Spring Bean)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Configuration
public class WebServiceConfig {

    @Autowired
    private Setting setting;

    /**
     * 特境 jax-ws client
     *
     * @return
     */
    @Bean
    public SwisService swisService() {
        JaxWsProxyFactoryBean factory = new JaxWsProxyFactoryBean();
        factory.setServiceClass(SwisService.class);
        factory.setAddress(setting.getSwis().getAddress());
        SwisService service = (SwisService) factory.create();
        SoapUtils.disableTlsServerCertificateCheck(ClientProxy.getClient(service));
        return service;
    }

    @Component
    @ConfigurationProperties(prefix = "tist.ws")
    public static class Setting {

        /** 特境 */
        private ServiceSetting swis;

    }

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Web Service Client設定</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">tist:
  ws:
    swis:
      address: http://lcas.tist.com.tw/swis/service/SwisService
      user-id: BAG0016
      password: 24231451</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_如何建立_web_service_server端">11.10. 如何建立 Web Service Server端</h3>
<div class="paragraph">
<p>參考資料 <a href="http://cxf.apache.org/docs/springboot.html">Spring Boot CXF JAX-WS Starter</a></p>
</div>
<div class="sect3">
<h4 id="_建立service_介面">11.10.1. 建立Service 介面</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@WebService(name = "SomeInterface", targetNamespace = "http://some.sfaa.gov.tw/some/api")
public interface SomeInterface {

    @WebMethod
    @WebResult(name = "someMethodResult")
    String someMethod(@WebParam(name = "param1") String param1, @WebParam(name = "param2") String param2);
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_實作service">11.10.2. 實作Service</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@WebService(name = "SomeInterface", targetNamespace = "http://some.sfaa.gov.tw/some/api")
public class SomeInterfaceImpl implements SomeInterface {
    // 其他一般Override寫法
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_spring_設定">11.10.3. Spring 設定</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Configuration
public class WebServiceConfig {

    /**
     * 介接服務使用到的網址
     */
    public static final String INTERFACING_PATTERN = "/some";

    @Resource
    private Bus bus;

    /**
     * 建立介接服務
     */
    @Bean
    public SomeInterface someInterface() {
        return new SomeInterfaceImpl();
    }

    /**
     * 建立介接服務的Endpoint
     */
    @Bean
    public Endpoint endpoint() {
        EndpointImpl endpoint = new EndpointImpl(bus, someInterface());
        endpoint.publish(INTERFACING_PATTERN);
        return endpoint;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_如何使用oauth驗證api">11.11. 如何使用Oauth驗證api</h3>
<div class="paragraph">
<p>Url Pattern為 /rest/* 皆為Oauth驗證範圍 各使用者API權限由tist_program負責控管</p>
</div>
<div class="sect3">
<h4 id="_相依package">11.11.1. 相依package</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="pom">        &lt;dependency&gt;
            &lt;groupId&gt;com.tist&lt;/groupId&gt;
            &lt;artifactId&gt;mgov-core-oauth&lt;/artifactId&gt;
            &lt;version&gt;${mgov-core.version}&lt;/version&gt;
        &lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_設定yml">11.11.2. 設定yml</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yml">tist:
    oauth:
        client-id: tist-front <i class="conum" data-value="1"></i><b>(1)</b>
        client-secret: 1111 <i class="conum" data-value="2"></i><b>(2)</b>
        key: tist <i class="conum" data-value="3"></i><b>(3)</b>
        token-time: 2400 <i class="conum" data-value="4"></i><b>(4)</b>
        redirect-uri: http://localhost:4200/admin/index <i class="conum" data-value="5"></i><b>(5)</b>
        legacy-mode: false <i class="conum" data-value="6"></i><b>(6)</b>
server: <i class="conum" data-value="7"></i><b>(7)</b>
  error:
    include-message: always
    include-binding-errors: always</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>選填，註冊之client id，預設admin</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>選填，註冊之client secret，預設1111</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>選填，jwt加密key，預設tist</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>選填，token存活秒數，預設1800秒</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>選填，轉導網址，預設http://localhost:4200/main/index</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>選填，是否用舊版本url綁定角色模式，預設false</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>選填，spring-boot:2.3之後預設將錯誤文字訊息隱藏僅保留HttpStatus, 若需文字可補上此設定</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
舊版模式不用設定Controller上架及角色設定功能
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">API Controller上架</div>
<div class="content">
<pre>OauthProgramController類似ProgramController用於API上架之功能</pre>
</div>
</div>
<div class="listingblock">
<div class="title">API 角色設定</div>
<div class="content">
<pre>OauthRoleController類似RoleController用於將每支rest API與角色綁定</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_授權碼模式">11.11.3. 授權碼模式</h4>
<div class="listingblock">
<div class="title">輸入網址取得授權碼</div>
<div class="content">
<pre>GET:/oauth/authorize</pre>
</div>
</div>
<div class="paragraph">
<p><strong>參數</strong></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Key</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>response_type</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>code</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>client_id</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>user_id</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>redirect_uri</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>tist.oauth.redirect-uri</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>state</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>選填，若有參數會一併夾帶至轉導頁面</p>
</div></div></td>
</tr>
</tbody>
</table>
<div id="authorization1" class="imageblock">
<div class="content">
<img src="images/oauth-authorization-code01.png" alt="authorization1]" width="750">
</div>
<div class="title">Figure 29. authorization1</div>
</div>
<div class="ulist">
<ul>
<li>
<p>登入後取得授權碼</p>
</li>
</ul>
</div>
<div id="authorization2" class="imageblock left">
<div class="content">
<img src="images/oauth-authorization-code02.png" alt="authorization2]" width="400">
</div>
<div class="title">Figure 30. authorization2</div>
</div>
<div class="paragraph">
<p><strong>轉址至tist.oauth.redirect.uri並夾帶授權碼</strong></p>
</div>
<div id="authorization3" class="imageblock">
<div class="content">
<img src="images/oauth-authorization-code03.png" alt="authorization3]" width="500">
</div>
<div class="title">Figure 31. authorization3</div>
</div>
<div class="paragraph">
<p><strong>夾帶state狀況</strong></p>
</div>
<div id="authorization4" class="imageblock">
<div class="content">
<img src="images/oauth-authorization-code04.png" alt="authorization4]" width="500">
</div>
<div class="title">Figure 32. authorization4</div>
</div>
<div class="listingblock">
<div class="title">取得access token</div>
<div class="content">
<pre>Post:/oauth/token</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Header</strong></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Key</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Authorization</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Basic YWRtaW46MTExMQ==</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Basic後方為 clientId:clientSecret Base64 encode</p>
</div>
<div class="paragraph">
<p><strong>參數</strong></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Key</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>grant_type</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>authorization_code</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>code</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>轉導後code之參數</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>redirect_uri</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>tist.oauth.redirect-uri</p>
</div></div></td>
</tr>
</tbody>
</table>
<div id="authorization5" class="imageblock">
<div class="content">
<img src="images/oauth-authorization-code05.png" alt="authorization5]" width="800">
</div>
<div class="title">Figure 33. authorization5</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="json">{
    "access_token": "accessToken", <i class="conum" data-value="1"></i><b>(1)</b>
    "token_type": "bearer",
    "refresh_token": "refreshToken", <i class="conum" data-value="2"></i><b>(2)</b>
    "expires_in": 1799, <i class="conum" data-value="3"></i><b>(3)</b>
    "scope": "create read update delete", <i class="conum" data-value="4"></i><b>(4)</b>
    "organization": "TIST CORP",
    "jti": "866c1c8a-06fb-4320-9830-baca53a37921"
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>訪問api所需之access token</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>刷新token所需，下方說明</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>token存活時間(秒)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>token scope</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">使用access token訪問api</div>
<div class="content">
<pre>GET:/oauth/token-info</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Header</strong></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Key</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Authorization</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Bearer access_token</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_implicit模式">11.11.4. Implicit模式</h4>
<div class="paragraph">
<p>同授權碼模式，差異僅response_type改為token，轉導後token資訊會夾帶於網址</p>
</div>
<div class="listingblock">
<div class="title">輸入網址取得授權碼</div>
<div class="content">
<pre>GET:/oauth/authorize</pre>
</div>
</div>
<div class="paragraph">
<p><strong>參數</strong></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Key</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>response_type</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>token</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>client_id</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>user_id</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>redirect_uri</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>tist.oauth.redirect-uri</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>state</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>選填，若有參數會一併夾帶至轉導頁面</p>
</div></div></td>
</tr>
</tbody>
</table>
<div id="authorization6" class="imageblock">
<div class="content">
<img src="images/oauth-authorization-code06.png" alt="authorization6]" width="800">
</div>
<div class="title">Figure 34. authorization6</div>
</div>
<div class="ulist">
<ul>
<li>
<p>登入後取得授權碼</p>
</li>
</ul>
</div>
<div id="authorization7" class="imageblock">
<div class="content">
<img src="images/oauth-authorization-code07.png" alt="authorization7]" width="800">
</div>
<div class="title">Figure 35. authorization7</div>
</div>
<div class="listingblock">
<div class="title">使用access token訪問api</div>
<div class="content">
<pre>GET:/rest/token-info</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Header</strong></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Key</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Authorization</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Bearer access_token</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_密碼模式">11.11.5. 密碼模式</h4>
<div class="listingblock">
<div class="title">取得access token</div>
<div class="content">
<pre>Post:/oauth/token</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Header</strong></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Key</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Authorization</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Basic YWRtaW46MTExMQ==</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Basic後方為 clientId:clientSecret Base64 encode</p>
</div>
<div class="paragraph">
<p><strong>參數</strong></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Key</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>grant_type</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>password</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>username</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>後台帳號</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>password</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>後台密碼</p>
</div></div></td>
</tr>
</tbody>
</table>
<div id="authorization8" class="imageblock">
<div class="content">
<img src="images/oauth-authorization-code08.png" alt="authorization8]" width="1000">
</div>
<div class="title">Figure 36. authorization8</div>
</div>
<div class="listingblock">
<div class="title">使用access token訪問api</div>
<div class="content">
<pre>GET:/rest/token-info</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Header</strong></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Key</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Authorization</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Bearer access_token</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_client_device驗證模式">11.11.6. client device驗證模式</h4>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
建議使用於Server-to-Server情境
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">取得access token</div>
<div class="content">
<pre>Post:/oauth/token</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Header</strong></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Key</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Authorization</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Basic YWRtaW46MTExMQ==</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Basic後方為 clientId:clientSecret Base64 encode</p>
</div>
<div class="paragraph">
<p><strong>參數</strong></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Key</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>grant_type</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>client_credentials</p>
</div></div></td>
</tr>
</tbody>
</table>
<div id="authorization9" class="imageblock">
<div class="content">
<img src="images/oauth-authorization-code09.png" alt="authorization9]" width="1000">
</div>
<div class="title">Figure 37. authorization9</div>
</div>
<div class="listingblock">
<div class="title">使用access token訪問api</div>
<div class="content">
<pre>GET:/rest/token-info</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Header</strong></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Key</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Authorization</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Bearer access_token</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_若header無token則訪問失敗">11.11.7. 若header無token則訪問失敗</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;oauth&gt;
    &lt;error_description&gt;
        Full authentication is required to access this resource
    &lt;/error_description&gt;
    &lt;error&gt;unauthorized&lt;/error&gt;
&lt;/oauth&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_refresh_token模式">11.11.8. refresh token模式</h4>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
client device驗證模式無法使用refresh token
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">重新取得access token</div>
<div class="content">
<pre>Post:/oauth/token</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Header</strong></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Key</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Authorization</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Basic YWRtaW46MTExMQ==</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Basic後方為 clientId:clientSecret Base64 encode</p>
</div>
<div class="paragraph">
<p><strong>參數</strong></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Key</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>grant_type</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>refresh_token</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>refresh_token</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>使用於之前取得accessToken之refreshToken</p>
</div></div></td>
</tr>
</tbody>
</table>
<div id="authorization10" class="imageblock">
<div class="content">
<img src="images/oauth-authorization-code10.png" alt="authorization10]" width="1000">
</div>
<div class="title">Figure 38. authorization10</div>
</div>
</div>
<div class="sect3">
<h4 id="_token_info">11.11.9. Token info</h4>
<div class="paragraph">
<p>取得持有token相關資訊，過期token也可查詢</p>
</div>
<div class="paragraph">
<p><strong>Header</strong></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Key</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Authorization</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Bearer access_token</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">取得token相關資訊</div>
<div class="content">
<pre>GET:/oauth/token-info</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="json">{
    "jti": "fee3cd3a-e550-411a-a6eb-2ee2f5b64102",
    "userName": "系統管理員", <i class="conum" data-value="1"></i><b>(1)</b>
    "tokenValue": accessToken, <i class="conum" data-value="2"></i><b>(2)</b>
    "exp": 1557475790, <i class="conum" data-value="3"></i><b>(3)</b>
    "rules": [ <i class="conum" data-value="4"></i><b>(4)</b>
        ...
    ],
    "authorities": [ <i class="conum" data-value="5"></i><b>(5)</b>
        "ROLE_ANONYMOUS",
        "admin"
    ],
    "scope": [
        "create",
        "read",
        "update",
        "delete"
    ]
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>登入使用者名稱</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>token value</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>token過期時間，unix時戳(秒)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>可訪問之api</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>角色權限</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_如何將阿拉伯數字轉成中文數字">11.12. 如何將阿拉伯數字轉成中文數字</h3>
<div class="paragraph">
<p>使用 <a href="http://icu-project.org">ICU4J</a></p>
</div>
<div class="listingblock">
<div class="title">pom.xml增加icu4j的相依設定</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.ibm.icu&lt;/groupId&gt;
    &lt;artifactId&gt;icu4j&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">範例</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">long number = 12345;
NumberFormat nf = NumberFormat.getInstance(new Locale("C@numbers=hant")); <i class="conum" data-value="1"></i><b>(1)</b>
NumberFormat nf2 = NumberFormat.getInstance(new Locale("C@numbers=hantfin")); <i class="conum" data-value="2"></i><b>(2)</b>
System.err.println(nf.format(number)); <i class="conum" data-value="3"></i><b>(3)</b>
System.err.println(nf2.format(number)); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>C@numbers=hant</code> 表示要將英文數字轉換成繁體中文數字</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>C@numbers=hantfin</code> 表示要將英文數字轉換成繁體中文的財經數字</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>結果為 <strong>一萬二千三百四十五</strong></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>結果為 <strong>壹萬貳仟參佰肆拾伍</strong></td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>C</code> 是 <code>en_US_POSIX</code> 簡寫， <code>hant</code> 代表繁體中文(t代表Tranditional)，所以 <code>hans</code>
     就是簡體中文，而fin代表財經
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_如何使用onetomany級連處理">11.13. 如何使用OneToMany級連處理</h3>
<div class="sect3">
<h4 id="_onetomany簡單說明">11.13.1. OneToMany簡單說明</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
基本上擁有ManyToOne那方的該欄位去記住雙方之間的關聯<br>
而擁有OneToMany那方的欄位則是由JPA去幫我們經由mapped的欄位來查找清單資訊
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>綜上所述要建立OneToMany一對多關聯必須要有一方有OneToMany去map有ManyToOne的那方</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_entity配置">11.13.2. Entity配置</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>擁有ManyToOne的一方</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">import com.tist.domain.AbstractEntity;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.ToString;
import javax.persistence.*;
import javax.validation.constraints.FutureOrPresent;

@Entity
@Table(name = "tist_many")
@Data
@EqualsAndHashCode(callSuper = true, doNotUseGetters = true)
@ToString(callSuper = true, doNotUseGetters = true)
public class Many extends AbstractEntity {

    @ManyToOne
    @JoinColumn(name = "one_id_", foreignKey = @ForeignKey(name = "fk_many_one"))
    private One one;
}</code></pre>
</div>
</div>
</li>
<li>
<p>擁有OneToMany的一方</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">import com.tist.domain.AbstractEntity;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.ToString;
import javax.persistence.CascadeType;
import javax.persistence.Entity;
import javax.persistence.OneToMany;
import javax.persistence.Table;
import java.util.List;
import java.util.Objects;

@Entity
@Table(name = "tist_one")
@Data
@EqualsAndHashCode(callSuper = true, doNotUseGetters = true)
@ToString(callSuper = true, doNotUseGetters = true)
public class One extends AbstractEntity {

    @OneToMany(mappedBy = "one", cascade = CascadeType.ALL, orphanRemoval = true)
    private List&lt;Many&gt; manyList;

    public void setManyList(List&lt;Many&gt; manyList) {
        if (Objects.isNull(this.manyList) || this.manyList == manyList) {
            this.manyList = manyList;
        } else {
            this.manyList.clear();
            this.manyList.addAll(manyList);
        }
    }
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_由manytoone方去儲存onetomany那方">11.13.3. 由ManyToOne方去儲存OneToMany那方</h4>
<div class="paragraph">
<p>跟一般的ManyToOne一樣，就會建立起關聯了</p>
</div>
</div>
<div class="sect3">
<h4 id="_由onetomany方去儲存manytoone那方">11.13.4. 由OneToMany方去儲存ManyToOne那方</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">import com.tist.service.impl.AbstractEntityServiceImpl;
import com.tist.util.BeanTool;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.BeanUtils;
import org.springframework.stereotype.Service;
import javax.annotation.Resource;
import javax.transaction.Transactional;
import java.util.Objects;
import java.util.Optional;
import com.tist.service.OneService;
import com.tist.service.ManyService;

@Transactional
@Service("com.tist.service.impl.OneServiceImpl")
public class OneServiceImpl
  extends AbstractEntityServiceImpl&lt;One, OneRepository&gt;
  implements OneService {
    /**
     * 不複製的屬性
     */
    private static final String[] EXCLUDE_PROPERTIES = new String[]{
        One_.ID,
        One_.CREATE_USER_ID,
        One_.CREATE_TIME
    };

    @Resource
    private ManyService manyService;

    @Override
    public One fetchAndUpdateBy(One source) {
        if (Objects.isNull(source)) {
            return null;
        }

        source.setManyList(manyService.fetchAndUpdateBy(source.getManyList()));

        if (StringUtils.isEmpty(source.getId())) {
            source.setId(null);
            source.getManyList().forEach(many -&gt; many.setOne(source));
            return source;
        }

        Optional&lt;One&gt; optionalTarget = getBaseRepository().findById(source.getId());
        if (optionalTarget.isPresent()) {
            One target = optionalTarget.get();
            BeanUtils.copyProperties(source, target, EXCLUDE_PROPERTIES);
            target.getManyList().forEach(many -&gt; many.setOne(target));
            return target;
        }
        return null;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_如何設定與使用_logableentity資料異動查詢紀錄">11.14. 如何設定與使用 Logable(Entity資料異動/查詢紀錄)</h3>
<div class="sect3">
<h4 id="_基本配置">11.14.1. 基本配置</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>pom檔相依mgov-core-log</p>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.tist&lt;/groupId&gt;
    &lt;artifactId&gt;mgov-core-log&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>yml 設定 檔案路徑、記錄層級、設定檔後綴</p>
<div class="listingblock">
<div class="title">application.yml</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yml">tist:
  log:
    path: D:\entity-log  <i class="conum" data-value="1"></i><b>(1)</b>
    level: trace  <i class="conum" data-value="2"></i><b>(2)</b>
    profile: log  <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>檔案路徑 &#8594; log檔要存放的位置</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>記錄層級 &#8594; 也就是log level (trace, debug, info, warn, error)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>設定檔後綴 &#8594; 自訂 logback-ooo.xml 使用，底層預設使用log</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="異動紀錄">11.14.2. 異動紀錄</h4>
<div class="ulist">
<ul>
<li>
<p>Entity 標註@Logable及實作 LogableEntity介面</p>
<div class="ulist">
<ul>
<li>
<p>@Logable</p>
<div class="ulist">
<ul>
<li>
<p>在想要記錄的Entity 上方標註 @Logable(LogableOperation)<br>
分為 ALL, INSERT, UPDATE, DELETE, QUERY</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
標註QUERY, 在"異動"紀錄中不會被記錄
</td>
</tr>
</table>
</div>
</li>
<li>
<p>範例：</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Logable(LogableOperation.ALL)
public class Student extends AbstractEntity {
    // 略...
}</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>LogableEntity</p>
<div class="ulist">
<ul>
<li>
<p>實作此介面的唯一目的：自製要記錄的內容( toLog() )。<br>
(各專案Entity已存在多時，無法預測每個Entity長什麼樣子，所以才決定讓大家各自實作)</p>
</li>
<li>
<p>原則上使用Json格式，記log的用意無非是未來某一天需要還原。</p>
</li>
<li>
<p>承上，雙向關聯等容易造成無窮迴圈的地方需各位多多注意。</p>
</li>
<li>
<p>範例：</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Logable(LogableOperation.ALL)
public class Student extends AbstractEntity implements LogableEntity {

    // 略...

    @Override
    public String toLog() {
        String logMsg = this.getId();
        try {
            logMsg = JsonUtils.stringify(this);
        } catch (JsonProcessingException e) {
            log.error(e.getLocalizedMessage());
        }
        return logMsg;
    }
}</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>效果</p>
<div class="ulist">
<ul>
<li>
<p>路徑下的資料夾, 2021.06改檔名為 ${yyyyMMdd}_modify.log</p>
<div class="imageblock">
<div class="content">
<img src="images/entity-log/log-01.png" alt="存放的位置" width="600" height="400">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/entity-log/log-02.png" alt="按日期分資料夾" width="600" height="400">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/entity-log/log-03.png" alt="最後的檔案" width="600" height="400">
</div>
</div>
</li>
<li>
<p>檔案內容</p>
<div class="imageblock">
<div class="content">
<img src="images/entity-log/log-04.png" alt="檔案內容" width="600" height="400">
</div>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_查詢紀錄">11.14.3. 查詢紀錄</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>大致上與<a href="#異動紀錄">異動紀錄</a> 相同,<br>
Entity 標註@Logable及實作 LogableEntity介面</p>
<div class="ulist">
<ul>
<li>
<p>@Logable</p>
<div class="ulist">
<ul>
<li>
<p>Entity 上方標註 @Logable(LogableOperation)<br>
分為 ALL, INSERT, UPDATE, DELETE, QUERY</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>標註QUERY, 僅能被"查詢"紀錄使用, 在"異動"紀錄中不會被記錄</p>
</li>
<li>
<p>能不能被查詢記錄取決於第二步Repository的寫法,<br>
並非標註@Logable(LogableOperation.QUERY)即可</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>範例：</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Logable(LogableOperation.QUERY)
public class Student extends AbstractEntity {
    // 略...
}</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>LogableEntity</p>
<div class="ulist">
<ul>
<li>
<p>實作此介面的唯一目的：自製要記錄的內容( toLog() )。<br>
(各專案Entity已存在多時，無法預測每個Entity長什麼樣子，所以才決定讓大家各自實作)</p>
</li>
<li>
<p>原則上使用Json格式，記log的用意無非是未來某一天需要還原。</p>
</li>
<li>
<p>承上，雙向關聯等容易造成無窮迴圈的地方需各位多多注意。</p>
</li>
<li>
<p>範例：</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Logable(LogableOperation.QUERY)
public class Student extends AbstractEntity implements LogableEntity {

    // 略...

    @Override
    public String toLog() {
        String logMsg = this.getId();
        try {
            logMsg = JsonUtils.stringify(this);
        } catch (JsonProcessingException e) {
            log.error(e.getLocalizedMessage());
        }
        return logMsg;
    }
}</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Repository 方法標註 @Logable<br></p>
<div class="ulist">
<ul>
<li>
<p>"不必"帶任何參數</p>
</li>
<li>
<p>回傳型別目前限定 Page&lt;T&gt;</p>
</li>
<li>
<p>範例:</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public interface StudentRepository
        extends BaseRepository&lt;Student, String&gt; {

    @Logable
    Page&lt;Student&gt; findByName(String name, Pageable pageable);

}</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="ulist">
<ul>
<li>
<p>效果</p>
<div class="ulist">
<ul>
<li>
<p>資料夾, 檔名為${yyyyMMdd}_query.log</p>
<div class="imageblock">
<div class="content">
<img src="images/entity-log/log-06.png" alt="query.log" width="600" height="400">
</div>
</div>
</li>
<li>
<p>紀錄內容</p>
<div class="imageblock">
<div class="content">
<img src="images/entity-log/log-07.png" alt="紀錄內容" width="600" height="400">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/entity-log/log-08.png" alt="紀錄內容format" width="600" height="400">
</div>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_log_查詢介面">11.14.4. log 查詢介面</h4>
<div class="ulist">
<ul>
<li>
<p>POM 檔相依 mgov-log 即可</p>
</li>
<li>
<p>Controller URL: "/admin/log"</p>
</li>
<li>
<p>查詢介面範例</p>
<div class="imageblock">
<div class="content">
<img src="images/entity-log/log-09.png" alt="查詢介面範例" width="600" height="400">
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_補充_logback_log_xml_寫法">11.14.5. 補充: logback-log.xml 寫法</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
此章節主要講述mgov下 logback 設定檔的載入機制。<br>
對整個logback.xml有興趣的同仁可以參考另一篇
<a href="http://git.tist.com.tw:3000/develop/rd-document/src/branch/master/src/docs/asciidoc/logback/logback.adoc">logback</a>的介紹。
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>檔案位置： resource/</p>
<div class="imageblock">
<div class="content">
<img src="images/entity-log/log-05.png" alt="xml位置">
</div>
</div>
</li>
<li>
<p>範例：</p>
<div class="listingblock">
<div class="title">主logback-spring.xml</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;configuration&gt;

    &lt;springProperty scope="context" name="log.profile" source="tist.log.profile"/&gt;
    &lt;include resource="logback-${log.profile}.xml"/&gt;

    &lt;!--略--&gt;

&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">底層logback-log.xml</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;included&gt;  <i class="conum" data-value="1"></i><b>(1)</b>
    &lt;springProperty scope="context" name="logging.level" source="tist.log.level"/&gt; <i class="conum" data-value="2"></i><b>(2)</b>
    &lt;springProperty scope="context" name="logging.path" source="tist.log.path"/&gt; <i class="conum" data-value="2"></i><b>(2)</b>

    &lt;appender name="ENTITY_LOG" class="ch.qos.logback.core.rolling.RollingFileAppender"&gt;  <i class="conum" data-value="3"></i><b>(3)</b>
        &lt;append&gt;true&lt;/append&gt;
        &lt;filter class="ch.qos.logback.classic.filter.LevelFilter"&gt; <i class="conum" data-value="4"></i><b>(4)</b>
            &lt;level&gt;${logging.level}&lt;/level&gt;
            &lt;onMatch&gt;ACCEPT&lt;/onMatch&gt;
            &lt;onMismatch&gt;DENY&lt;/onMismatch&gt;
        &lt;/filter&gt;
        &lt;rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy"&gt; <i class="conum" data-value="5"></i><b>(5)</b>
            &lt;FileNamePattern&gt;${logging.path}/%d{yyyyMMdd}_entity_log/Entity.log&lt;/FileNamePattern&gt;
            &lt;MaxHistory&gt;30&lt;/MaxHistory&gt;
        &lt;/rollingPolicy&gt;
        &lt;encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder"&gt;
            &lt;pattern&gt;%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n&lt;/pattern&gt;
            &lt;charset&gt;UTF-8&lt;/charset&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;logger name="com.tist.domain" level="${logging.level}" additivity="false"&gt;  <i class="conum" data-value="6"></i><b>(6)</b>
        &lt;appender-ref ref="ENTITY_LOG"/&gt; <i class="conum" data-value="7"></i><b>(7)</b>
    &lt;/logger&gt;

&lt;/included&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>使用include 的方式加載, 通常專案只會吃一個名為logback-spring.xml的檔案</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>吃yml檔參數</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>appender 可以把它想像成一本本的日誌</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>filter 過濾是否可以寫進這個日誌</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>rollingPolicy 寫這個日誌的規則</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>logger 可以把它想像成決定要用哪一本日誌來寫的人</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>appender-ref 決定要用的那一本日誌</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_如何發送簡訊">11.15. 如何發送簡訊</h3>
<div class="ulist">
<ul>
<li>
<p>參考 <a href="https://www.emome.net/files/fckeditor/IMSP_SMS_Protocol_v2_5.pdf">中華電信Http SNS說明文件</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_開發環境設定_application_dev_yml_2">11.15.1. 開發環境設定 application-dev.yml</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yml">tist:
  sms:
    url: https://imsp.emome.net:4443/imsp/sms/servlet/SubmitSM <i class="conum" data-value="1"></i><b>(1)</b>
    username: 11738 <i class="conum" data-value="2"></i><b>(2)</b>
    password: tist1022 <i class="conum" data-value="3"></i><b>(3)</b>
    from: "0911511738" <i class="conum" data-value="4"></i><b>(4)</b>
    long-sms-max: 4 <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>中華電信簡訊服務網址</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>使用者帳號(公司帳號，僅限開發使用！！)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>使用者密碼(公司帳號，僅限開發使用！！)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>寄送者門號(公司門號，僅限開發使用！！)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>長簡訊最大則數設定，詳見<a href="#長簡訊相關注意事項">長簡訊相關注意事項</a></td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_測試環境設定_application_test_yml_2">11.15.2. 測試環境設定 application-test.yml</h4>
<div class="ulist">
<ul>
<li>
<p>與開發環境相同</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_正式環境設定_application_live_yml_2">11.15.3. 正式環境設定 application-live.yml</h4>
<div class="ulist">
<ul>
<li>
<p>需請各專案承辦向中華電信申請一組企業簡訊使用門號。<br>
若有需要長簡訊功能，須另外申請。</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">客戶自建</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yml">tist:
  sms:
    url: [string]
    username: [string]
    password: [string]
    from: [string]
    long-sms-max: [int]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="長簡訊相關注意事項">11.15.4. 長簡訊相關注意事項</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>長簡訊服務需要另外申請帳號之相關權限。</p>
</li>
<li>
<p>長簡訊服務含簡訊標頭，所以每則簡訊由70字減為67字。</p>
</li>
<li>
<p>長簡訊服務最多設定 256則，mgov 預設4則。</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_com_tist_service_chtsmsservice">11.15.5. com.tist.service.ChtSmsService</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 71.4286%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">method</th>
<th class="tableblock halign-left valign-top">description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">send</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>send(String number, String message)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Parameters:</p>
<div class="ulist">
<ul>
<li>
<p>number : String (收簡訊人電話號碼)</p>
</li>
<li>
<p>message : String (簡訊內容)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Return Value: String (中華電信回傳代碼)</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sendLongSms</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>sendLongSms(String number, String message)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Parameters:</p>
<div class="ulist">
<ul>
<li>
<p>number : String (收簡訊人電話號碼)</p>
</li>
<li>
<p>message : String (簡訊內容)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Return Value: String (中華電信回傳代碼)</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_如何設定proguard">11.16. 如何設定ProGuard</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>java9相容性尚未完全請使用在java8</p>
</li>
<li>
<p>有些東西不可proguard 例如: constant、enum<br>
會將常數也一併混淆，程式啟動就會異常<br>
請跳過(skip)或者不要使用proguard</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;properties&gt;
    &lt;proguard-maven-plugin.version&gt;2.3.1&lt;/proguard-maven-plugin.version&gt;
    &lt;tool.proguard.version&gt;6.2.2&lt;/tool.proguard.version&gt;
&lt;/properties&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;build&gt;
    &lt;plugins&gt;
        &lt;plugin&gt;
            &lt;groupId&gt;com.github.wvengen&lt;/groupId&gt;
            &lt;artifactId&gt;proguard-maven-plugin&lt;/artifactId&gt;
            &lt;version&gt;${proguard-maven-plugin.version}&lt;/version&gt;
            &lt;executions&gt;
                &lt;execution&gt;
                    &lt;id&gt;obfuscation-packaging&lt;/id&gt;
                    &lt;phase&gt;package&lt;/phase&gt;
                    &lt;goals&gt;
                        &lt;goal&gt;proguard&lt;/goal&gt;
                    &lt;/goals&gt;
                    &lt;configuration&gt;
                        &lt;proguardVersion&gt;${tool.proguard.version}&lt;/proguardVersion&gt;
                        &lt;injarNotExistsSkip&gt;true&lt;/injarNotExistsSkip&gt;
                        &lt;libs&gt;
                            &lt;lib&gt;${java.home}/lib/rt.jar&lt;/lib&gt;
                        &lt;/libs&gt;
                        &lt;options&gt;
                            &lt;option&gt;-target 1.8&lt;/option&gt;
                            &lt;option&gt;-ignorewarnings&lt;/option&gt;
                            &lt;option&gt;-dontoptimize&lt;/option&gt;
                            &lt;option&gt;-keepdirectories&lt;/option&gt;
                            &lt;option&gt;-keepparameternames&lt;/option&gt;
                            &lt;option&gt;-allowaccessmodification&lt;/option&gt;
                            &lt;option&gt;-useuniqueclassmembernames&lt;/option&gt;
                            &lt;option&gt;-renamesourcefileattribute SourceFile&lt;/option&gt;
                            &lt;option&gt;-keepattributes Exceptions,InnerClasses,Signature,Deprecated,
                                SourceFile,LineNumberTable,*Annotation*,EnclosingMethod
                            &lt;/option&gt;
                            &lt;option&gt;-keepclassmembers public class * {void set*(***);*** get*();}&lt;/option&gt;
                            &lt;option&gt;-keep public class * {
                                public protected *;
                                }
                            &lt;/option&gt;
                            &lt;option&gt;-keepclassmembernames class * {
                                java.lang.Class class$(java.lang.String);
                                java.lang.Class class$(java.lang.String, boolean);
                                }
                            &lt;/option&gt;
                            &lt;option&gt;-keepclasseswithmembernames,includedescriptorclasses class * {
                                native &lt;![CDATA[&lt;methods&gt;]]&gt;;
                                }
                            &lt;/option&gt;
                            &lt;option&gt;-keepclassmembers,allowoptimization enum * {
                                public static **[] values();
                                public static ** valueOf(java.lang.String);
                                }
                            &lt;/option&gt;
                            &lt;option&gt;-keepclassmembers class * implements java.io.Serializable {
                                static final long serialVersionUID;
                                private static final java.io.ObjectStreamField[] serialPersistentFields;
                                private void writeObject(java.io.ObjectOutputStream);
                                private void readObject(java.io.ObjectInputStream);
                                java.lang.Object writeReplace();
                                java.lang.Object readResolve();
                                }
                            &lt;/option&gt;
                            &lt;option&gt;-keep class com.tist.aspect.** {*;}&lt;/option&gt;
                            &lt;option&gt;-keep class com.tist.domain.** {*;}&lt;/option&gt;
                            &lt;option&gt;-keep class com.tist.web.** {*;}&lt;/option&gt;
                            &lt;option&gt;-keep class com.tist.config.** {*;}&lt;/option&gt;
                            &lt;option&gt;-keep class com.tist.bean.factory.** {*;}&lt;/option&gt;
                            &lt;option&gt;-keep class com.tist.annotation.** {*;}&lt;/option&gt;
                            &lt;option&gt;-keep class com.tist.report.** {*;}&lt;/option&gt;

                        &lt;/options&gt;
                    &lt;/configuration&gt;
                &lt;/execution&gt;
            &lt;/executions&gt;
            &lt;dependencies&gt;
                &lt;dependency&gt;
                    &lt;groupId&gt;net.sf.proguard&lt;/groupId&gt;
                    &lt;artifactId&gt;proguard-base&lt;/artifactId&gt;
                    &lt;version&gt;${tool.proguard.version}&lt;/version&gt;
                &lt;/dependency&gt;
            &lt;/dependencies&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;
&lt;/build&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">skip 設定</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;build&gt;
    &lt;plugins&gt;
        &lt;plugin&gt;
            &lt;groupId&gt;com.github.wvengen&lt;/groupId&gt;
            &lt;artifactId&gt;proguard-maven-plugin&lt;/artifactId&gt;
            &lt;configuration&gt;
                &lt;skip&gt;true&lt;/skip&gt;
            &lt;/configuration&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;
&lt;/build&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_如何使用mgov_initializer">11.17. 如何使用mgov-initializer</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>目前僅提供最基本的初始化, 提供大家盡量快速建立環境, 若有額外需求仍須自行處理</p>
</div>
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">下載</dt>
<dd>
<p>從Nexus依照自身mgov版本下載</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>http://repo.tist.com.tw:8081/repository/maven-releases/com/tist/mgov-initializer/{版本號}/mgov-initializer-{版本號}.jar</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>正常啟動web使其自動生成table後執行jar</p>
</li>
<li>
<p>java -jar mgov-initializer-2.4.8.2.jar</p>
</li>
<li>
<p>根據需求輸入DB連線資訊, 若無密碼則不必輸入</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>config --type postgresql --url jdbc:postgresql://192.168.106.128:5432/mgov --username postgres</p>
</li>
<li>
<p>config --type oracle --url jdbc:oracle:thin:@192.168.106.145:1521:xe --username tistusr --password tistusr1234</p>
</li>
<li>
<p>config --type mssql --url jdbc:sqlserver://192.168.106.146;databaseName=mgov --username tist --password 1111</p>
</li>
</ol>
</div>
</li>
<li>
<p>初始化/全部刪除</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>init</p>
</li>
<li>
<p>delete</p>
</li>
</ol>
</div>
</li>
<li>
<p>全指令查詢</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>help</p>
</li>
<li>
<p>指令說明前有順序註記供想逐步插入的人使用</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_如何修改登入流程的驗證項目">11.18. 如何修改登入流程的驗證項目</h3>
<div class="sect3">
<h4 id="_前言">11.18.1. 前言</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>mgov 後台加入了預設使用kaptcha 的驗證碼產生器<br>
因此，對原本交由spring 預設的驗證流程進行了改寫<br>
各專案需要擴充或需要改寫使用別的多因子驗證請參考這篇。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>kaptcha 相關設定請參考 <a href="#客製Kaptcha驗證碼">如何客製Kaptcha驗證碼</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>主要項目有三</p>
<div class="ulist">
<ul>
<li>
<p>AuthenticationDetails</p>
</li>
<li>
<p>AuthenticationDetailsSource</p>
</li>
<li>
<p>AuthenticationProvider</p>
</li>
</ul>
</div>
</li>
<li>
<p>先看一下WebSecurityConfig</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class WebSecurityConfig {

    /**
     * 後台相關設定
     */
    @Configuration
    @Order(1)
    public static class BackWebSecurityConfigurer extends WebSecurityConfigurerAdapter {

        // 略...

        @ConditionalOnMissingBean(name = "mgovAuthenticationDetailsSource")
        @Bean("mgovAuthenticationDetailsSource")
        public MgovAuthenticationDetailsSource mogvAuthenticationDetailsSource() {
            return new MgovAuthenticationDetailsSource();
        }

        @ConditionalOnMissingBean(name = "mgovAuthenticationProvider")
        @Bean("mgovAuthenticationProvider")
        public MgovAuthenticationProviderImpl mgovAuthenticationProviderImpl() {
            return new MgovAuthenticationProviderImpl();
        }

        @Resource(name = "mgovAuthenticationDetailsSource") <i class="conum" data-value="3"></i><b>(3)</b>
        private AuthenticationDetailsSource&lt;HttpServletRequest, MgovAuthenticationDetails&gt; detailsSource;  <i class="conum" data-value="1"></i><b>(1)</b>

        @Resource(name = "mgovAuthenticationProvider") <i class="conum" data-value="3"></i><b>(3)</b>
        private MgovAuthenticationProvider provider;  <i class="conum" data-value="2"></i><b>(2)</b>

        // 略...
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>AuthenticationDetails 請實作 MgovAuthenticationDetails 介面, 但注意這裡注入的是 AuthenticationDetails"Source"</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>AuthenticationProvider 請實作 MgovAuthenticationProvider 介面</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>注意一下Spring Bean的名稱</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_實作authenticationdetails">11.18.2. 實作AuthenticationDetails</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Getter
public class XxxxAuthenticationDetails extends WebAuthenticationDetails
    implements MgovAuthenticationDetails, Serializable { <i class="conum" data-value="1"></i><b>(1)</b>

    private static final long serialVersionUID = -7838300200866507650L;

    private final String kaptcha; <i class="conum" data-value="2"></i><b>(2)</b>

    private final String test; <i class="conum" data-value="3"></i><b>(3)</b>

    XxxxAuthenticationDetails(HttpServletRequest request) {
        super(request);
        kaptcha = request.getParameter("kaptcha"); <i class="conum" data-value="2"></i><b>(2)</b>
        test = request.getParameter("YOUR_CHECKED_PARAMETER");
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>實作 MgovAuthenticationDetails</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>承接驗證碼的屬性String kaptcha, 並在建構子中從request 物件取得。<br>
若使用別的多因子驗證套件這裡就可以不用，改用自己的即可。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>依需求增加想驗證的項目</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_實作authenticationdetailssource">11.18.3. 實作AuthenticationDetailsSource</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Component("mgovAuthenticationDetailsSource") <i class="conum" data-value="2"></i><b>(2)</b>
public class XxxxAuthenticationDetailsSource
    implements AuthenticationDetailsSource&lt;HttpServletRequest, MgovAuthenticationDetails&gt; {

    @Override
    public MgovAuthenticationDetails buildDetails(HttpServletRequest httpServletRequest) {
        return new XxxxAuthenticationDetails(httpServletRequest); <i class="conum" data-value="1"></i><b>(1)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>實作AuthenticationDetailsSource 的buildDetails 方法以提供Details</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>@Component 註冊為SpringBean 且命名為 "mgovAuthenticationDetailsSource" (固定不能改)
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
SpringBean 名稱一定要對，否則會使用底層預設的DetailsSource。
</td>
</tr>
</table>
</div></td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_實作authenticationprovider">11.18.4. 實作AuthenticationProvider</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Component("mgovAuthenticationProvider")  <i class="conum" data-value="1"></i><b>(1)</b>
public class XxxxAuthenticationProvider
    extends AbstractUserDetailsAuthenticationProvider
    implements MgovAuthenticationProvider {   <i class="conum" data-value="2"></i><b>(2)</b>

    // 略...

    @Override
    protected void additionalAuthenticationChecks( <i class="conum" data-value="3"></i><b>(3)</b>
        UserDetails userDetails, UsernamePasswordAuthenticationToken authentication)
        throws AuthenticationException {

        if (authentication.getCredentials() == null) {
            logger.debug("...");
            throw new BadCredentialsException(/*...*/);

        } else {
            String presentedPassword = authentication.getCredentials().toString();
            XxxxAuthenticationDetails authenticationDetails =
                (XxxxAuthenticationDetails) authentication.getDetails(); <i class="conum" data-value="4"></i><b>(4)</b>

            // 略...

            if (!authenticationDetails.getKaptcha().equals(session.getAttribute("kaptcha.code"))) {
                throw new CaptchaException(localeMessageService.getMessage("admin.login.kaptcha"));
            }  <i class="conum" data-value="5"></i><b>(5)</b>

            <i class="conum" data-value="6"></i><b>(6)</b>
        }
    }

    @Override
    protected UserDetails retrieveUser( <i class="conum" data-value="3"></i><b>(3)</b>
        String username, UsernamePasswordAuthenticationToken authentication) throws AuthenticationException {
        // 略...
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Provider 註冊為SpringBean 且命名為 "mgovAuthenticationProvider" (固定不能改)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>實作 MgovAuthenticationProvider 介面</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>實作 抽象類的retrieveUser 及 additionalAuthenticationChecks方法</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>這裡會使用SpringBean 名稱為"mgovAuthenticationDetailsSource"的DetailsSource 所建立的Details。<br>
如果對不起來這裡容易報ClassCastException。</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>預設的驗證碼驗證。若使用別的多因子驗證套件這裡可以移除，改用自己的即可。</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>依需求增加其他驗證流程</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="客製Kaptcha驗證碼">11.19. 如何客製Kaptcha驗證碼</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>參考 KaptchaConfig，在yml檔調整、設定。<br>
前綴為 "tist.kaptcha" ，如下圖</p>
</div>
<div class="paragraph">
<p>官方網址:<br>
<a href="https://code.google.com/archive/p/kaptcha/wikis/ConfigParameters.wiki" class="bare">https://code.google.com/archive/p/kaptcha/wikis/ConfigParameters.wiki</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="images/kaptcha01.png" alt="Kaptcha相關參數">
</div>
<div class="title">Figure 39. Kaptcha相關參數</div>
</div>
<div class="ulist">
<ul>
<li>
<p>mgov-kaptcha參數及預設值(不一定為官方預設值)</p>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">參數名稱</th>
<th class="tableblock halign-center valign-top">描述</th>
<th class="tableblock halign-center valign-top">預設值</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">session-key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HttpSession中取得驗證碼的屬性名稱</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">kaptcha.code</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">font-color</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">驗證碼文字顏色</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">black</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">font-size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">驗證碼文字大小</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">25</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">obscurificator-impl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">驗證碼樣式引擎</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">com.google.code.kaptcha.impl.ShadowGimpy</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">noise-impl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">驗證碼噪點生成對象</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">com.google.code.kaptcha.impl.NoNoise</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">image-width</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">驗證碼圖片寬度(px)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">100</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">image-height</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">驗證碼圖片高度(px)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">40</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">char-length</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">驗證碼字數長度</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">char-string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">驗證碼文字內容範圍</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">abcde2345678gfynmnpwx</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">char-space</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">驗證碼文字間距</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">background-clear-from</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">驗證碼背景顏色漸進起始顏色</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">247,247,247 (不能有空白)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">background-clear-to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">驗證碼背景顏色漸進結束顏色</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">247,247,247 (不能有空白)</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>範例</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="yaml">tist:
  kaptcha:
    char-string: abcde345678gfnmnkrtABCDEFGHJKLMNQRT
    font-color: blue
    font-size: 40
    image-height: 80
    image-width: 200
    char-length: 5
    char-space: 10
    background-clear-from: 240,232,185 #注意逗號後面不能有空白
    background-clear-to: 247,229,124 #注意逗號後面不能有空白</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/kaptcha02.png" alt="客製範例">
</div>
<div class="title">Figure 40. Kaptcha驗證碼客製範例</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 0.5<br>
Last updated 2021-11-01 11:46:16 +0800
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/run_prettify.min.js"></script>
</body>
</html>